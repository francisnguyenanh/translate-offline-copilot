<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel & PowerPoint Translation Manager</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome cho icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- html2canvas: capture overlay as image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .function-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: 100%;
            transition: transform 0.3s;
        }
        
        .function-card:hover {
            transform: translateY(-5px);
        }
        
        .function-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .function-card .icon {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin: 15px 0;
            transition: all 0.3s;
        }
        
        .upload-area.compact {
            padding: 15px;
            margin: 10px 0;
        }
        
        .upload-area:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }
        
        .upload-area i {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .collapse-toggle {
            cursor: pointer;
            user-select: none;
        }
        
        .collapse-toggle:hover {
            opacity: 0.8;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-custom:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .alert-custom {
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .file-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .loading {
            display: none;
            margin-top: 15px;
        }
        
        .loading .spinner-border {
            width: 2rem;
            height: 2rem;
        }
        
        .json-file-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: #f0f7ff;
            border: 1px solid #cce0ff;
            border-radius: 6px;
            margin-bottom: 6px;
            gap: 8px;
        }
        
        .json-file-row .file-name {
            font-size: 0.78rem;
            color: #333;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .json-file-row .btn-copy-json {
            flex-shrink: 0;
            font-size: 0.75rem;
            padding: 3px 10px;
        }
        
        .btn-copy-json.copied {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: white !important;
        }

        /* ===== DARK MODE ===== */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        body.dark-mode .function-card {
            background: #1e2a3a;
            color: #e0e0e0;
        }
        body.dark-mode .function-card h3 { color: #90b4f7; }
        body.dark-mode .upload-area {
            background: #253244;
            border-color: #4a6fa5;
        }
        body.dark-mode .upload-area:hover { background: #2c3e54; }
        body.dark-mode .file-info { background: #253244; color: #ccc; }
        body.dark-mode .json-file-row {
            background: #1e3049;
            border-color: #2d5080;
            color: #ccc;
        }
        body.dark-mode .collapse-toggle {
            background: #253244 !important;
            color: #ccc;
        }
        body.dark-mode .collapse-toggle .text-info { color: #7ec8e3 !important; }
        body.dark-mode .collapse > div {
            background: #253244 !important;
            color: #ccc;
        }
        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background: #253244;
            color: #e0e0e0;
            border-color: #4a6fa5;
        }
        body.dark-mode .nav-tabs .nav-link { color: #90b4f7; }
        body.dark-mode .nav-tabs .nav-link.active {
            background: #1e3049;
            color: #fff;
            border-color: #4a6fa5;
        }
        body.dark-mode .text-muted { color: #8a9bb0 !important; }
        body.dark-mode footer { color: #8a9bb0 !important; }
        body.dark-mode .alert-info { background: #1b3a52; color: #7ec8e3; border-color: #2d6a8a; }
        body.dark-mode #promptDetail > div {
            background: #1b2d3e !important;
            border-color: #2d5a7a !important;
        }
        body.dark-mode #aiPrompt { color: #b0c8e0; }
        body.dark-mode .validation-item { background: #253244; border-color: #3a5070; }
        .dedup-banner {
            background: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        body.dark-mode .dedup-banner {
            background: #193d2a;
            border-color: #1f6640;
            color: #6dd99e;
        }
        body.dark-mode .dedup-banner .text-muted { color: #4d9e6a !important; }

        /* === Dark mode: Improvement for Step 2/3 === */
        body.dark-mode .file-name { color: #e0e0e0; font-weight: 500; }
        body.dark-mode .json-file-row { color: #e0e0e0; }
        body.dark-mode .form-control::placeholder { color: #8a9bb0; }
        
        /* === Dark mode: Modal === */
        body.dark-mode .modal-content {
            background: #1e3049;
            color: #e0e0e0;
            border-color: #2d5080;
        }
        body.dark-mode .modal-header {
            background: #17253a;
            border-bottom-color: #2d5080;
        }
        body.dark-mode .modal-footer {
            background: #17253a;
            border-top-color: #2d5080;
        }
        body.dark-mode .modal-title { color: #e0e0e0; }
        body.dark-mode .btn-close { filter: invert(1) brightness(1.5); }

        /* === Dark mode: Dropdown === */
        body.dark-mode .dropdown-menu {
            background: #1e3049;
            border-color: #2d5080;
        }
        body.dark-mode .dropdown-item { color: #d0dff0; }
        body.dark-mode .dropdown-item:hover,
        body.dark-mode .dropdown-item:focus {
            background: #253c5a;
            color: #fff;
        }
        body.dark-mode .dropdown-header { color: #8ab4d8; }
        body.dark-mode .dropdown-divider { border-color: #2d5080; }

        /* === Dark mode: List group (template list in modal) === */
        body.dark-mode .list-group-item {
            background: #1e3049;
            color: #d0dff0;
            border-color: #2d5080;
        }
        body.dark-mode .list-group-item:hover {
            background: #253c5a;
            color: #fff;
        }
        body.dark-mode .list-group-item.active {
            background: #0d5c9e;
            border-color: #1a7ac4;
            color: #fff;
        }
        body.dark-mode .list-group-item-action { color: #d0dff0; }

        /* === Dark mode: Alerts === */
        body.dark-mode .alert-success {
            background: #193d2a;
            color: #6dd99e;
            border-color: #1f6640;
        }
        body.dark-mode .alert-danger {
            background: #3d1919;
            color: #f08080;
            border-color: #7a2020;
        }
        body.dark-mode .alert-warning {
            background: #3d3019;
            color: #f0c060;
            border-color: #7a6020;
        }
        body.dark-mode .alert-secondary {
            background: #253244;
            color: #b0c4d8;
            border-color: #3a5070;
        }

        /* === Dark mode: Typography & Labels === */
        body.dark-mode label,
        body.dark-mode .form-label { color: #ffffff; }
        body.dark-mode code {
            background: #172840;
            color: #79d4f3;
            border: 1px solid #2d5080;
        }
        body.dark-mode small { color: #a0b0c0; }
        body.dark-mode strong { color: #ffffff; }
        body.dark-mode p { color: #e0e0e0; }
        body.dark-mode hr { border-color: #2d5080; opacity: 0.5; }

        /* === Dark mode: Cards & function cards === */
        body.dark-mode .card {
            background: #1b2d3e;
            border-color: #2d5080;
            color: #d0e0f0;
        }
        body.dark-mode .card-header {
            background: #17253a;
            border-bottom-color: #2d5080;
            color: #e0e0e0;
        }
        body.dark-mode .card-body { color: #d0e0f0; }

        /* === Dark mode: Table === */
        body.dark-mode .table {
            color: #d0e0f0;
            border-color: #2d5080;
        }
        body.dark-mode .table th,
        body.dark-mode .table td { border-color: #2d5080; }
        body.dark-mode .table-striped tbody tr:nth-of-type(odd) { background: #1b2d40; }

        /* === Dark mode: Textarea === */
        body.dark-mode textarea.form-control {
            background: #172840;
            color: #ffffff;
            border-color: #3a6090;
        }
        body.dark-mode textarea.form-control:focus {
            background: #1b3050;
            border-color: #5090c8;
            box-shadow: 0 0 0 0.2rem rgba(80,144,200,0.25);
        }

        /* === Dark mode: Tab border at bottom === */
        body.dark-mode .nav-tabs { border-bottom-color: #2d5080; }
        body.dark-mode .nav-tabs .nav-link:not(.active):hover {
            background: #1b2d3e;
            border-color: #2d5080 #2d5080 transparent;
        }

        /* ===== IMAGE OVERLAY ===== */
        .overlay-block {
            box-sizing: border-box;
            transition: outline 0.1s;
        }
        .overlay-block.selected {
            outline: 2px solid #667eea !important;
            z-index: 15 !important;
        }
        .overlay-block:hover { z-index: 14 !important; }
        .overlay-translated {
            display: block;
            width: 100%;
            text-align: center;
            line-height: 1.2;
            word-break: break-word;
            overflow: hidden;
        }
        .overlay-original {
            font-size: 0.6em;
            opacity: 0.7;
            text-align: center;
        }
        /* Resize handles */
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #667eea;
            border: 1.5px solid #fff;
            border-radius: 2px;
            z-index: 40;
            display: none;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        .overlay-block:hover .resize-handle,
        .overlay-block.selected .resize-handle { display: block; }
        .rh-nw { top:-5px;  left:-5px;              cursor:nw-resize; }
        .rh-n  { top:-5px;  left:calc(50% - 5px);   cursor:n-resize;  }
        .rh-ne { top:-5px;  right:-5px;             cursor:ne-resize; }
        .rh-e  { top:calc(50% - 5px); right:-5px;  cursor:e-resize;  }
        .rh-se { bottom:-5px; right:-5px;           cursor:se-resize; }
        .rh-s  { bottom:-5px; left:calc(50% - 5px); cursor:s-resize;  }
        .rh-sw { bottom:-5px; left:-5px;            cursor:sw-resize; }
        .rh-w  { top:calc(50% - 5px); left:-5px;   cursor:w-resize;  }
        body.dark-mode .resize-handle { background:#5090d8; border-color:#1e3049; }
    </style>
</head>
<body class="dark-mode">
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-language"></i> Tomo Translation</h1>
            <div class="mt-3 d-flex flex-wrap justify-content-center gap-2">
                <button class="btn btn-outline-light btn-sm" onclick="clearUploads()" title="Xóa file trong phiên của bạn">
                    <i class="fas fa-trash-alt"></i> Xóa file của tôi
                </button>
                <a href="/logout" class="btn btn-outline-light btn-sm" title="Đăng xuất">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </a>
                <button class="btn btn-outline-light btn-sm" id="darkModeToggle" onclick="toggleDarkMode()" title="Chuyển chế độ tối/sáng">
                    <i class="fas fa-sun" id="darkModeIcon"></i> <span id="darkModeLabel">Light Mode</span>
                </button>

            </div>
        </div>

        <!-- Main Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="main-tab1" data-bs-toggle="tab" data-bs-target="#mainTab1" type="button" role="tab" aria-selected="true">
                    <i class="fas fa-exchange-alt"></i> Dịch tài liệu
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="main-tab2" data-bs-toggle="tab" data-bs-target="#mainTab2" type="button" role="tab" aria-selected="false">
                    <i class="fas fa-image"></i> Dịch ảnh
                </button>
            </li>
        </ul>
        <div class="tab-content" id="mainTabContent">
        <div class="tab-pane fade show active" id="mainTab1" role="tabpanel" aria-labelledby="main-tab1">
        <!-- 3 Bước theo hàng ngang -->
        <div class="row g-3">
            <!-- Bước 1: Upload file -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">1</span>
                        <h3 class="d-inline">Upload File</h3>
                        <p class="text-muted small mt-2">File gốc (.xlsx/.pptx/.docx)</p>
                    </div>
                    
                    <form id="uploadExcelForm" enctype="multipart/form-data">
                        <div class="upload-area compact" id="mainUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p class="mb-2 small"><strong>Kéo thả file vào đây</strong></p>
                            <input type="file" class="form-control" id="mainExcelFile" name="file" accept=".xlsx,.pptx,.docx" style="display: none;">
                            <label for="mainExcelFile" class="btn btn-custom btn-sm">
                                <i class="fas fa-folder-open"></i> Chọn file
                            </label>
                        </div>
                        
                        <div id="mainFileInfo" class="file-info" style="display: none;">
                            <i id="mainFileIcon" class="fas fa-file text-secondary"></i>
                            <span id="mainFileName" class="small"></span>
                            <button type="button" class="btn btn-sm btn-outline-danger float-end" id="mainFileRemove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div id="mainAlert"></div>
                    </form>

                    <!-- Chọn ngôn ngữ đích -->
                    <div class="mt-3">
                        <label for="targetLangSelect" class="form-label small mb-1">
                            <i class="fas fa-globe"></i> <strong>Ngôn ngữ đích:</strong>
                        </label>
                        <select class="form-select form-select-sm" id="targetLangSelect">
                            <option value="" disabled>Đang tải danh sách...</option>
                        </select>
                        <div class="text-muted" style="font-size: 0.72rem; margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> Danh sách ngôn ngữ chỉnh sửa trong <code>languages.json</code>
                        </div>
                    </div>


                    
                    <!-- Hướng dẫn collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step1Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>Hướng dẫn sử dụng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step1Guide">
                            <div class="p-2" style="border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li>Hỗ trợ Excel (.xlsx), PowerPoint (.pptx) <b>và Word (.docx)</b></li>
                                    <li>Kéo thả hoặc click để chọn file</li>
                                    <li>File sẽ dùng cho cả Extract và Inject</li>
                                    <li>Giới hạn: 16MB</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bước 2: Extract -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">2</span>
                        <h3 class="d-inline">Trích xuất</h3>
                        <p class="text-muted small mt-2">Extract nội dung cần dịch</p>
                    </div>
                    
                    <form id="extractForm" enctype="multipart/form-data">
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-custom btn-sm" id="extractBtn" disabled>
                                <i class="fas fa-cog"></i> Trích xuất JSON
                            </button>
                        </div>
                        
                        <div class="loading text-center" id="extractLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang xử lý...</span>
                            </div>
                            <p class="mt-2 small">Đang trích xuất dữ liệu...</p>
                        </div>
                        
                        <div id="extractAlert"></div>
                    </form>
                    
                    <!-- Prompt AI -->
                    <div class="mt-3">
                        <!-- Template Selector -->
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <small> <strong>Template:</strong></small>
                            <select class="form-select form-select-sm" id="templateSelect" style="font-size:0.78rem;"></select>
                            <button class="btn btn-outline-primary btn-sm py-0 px-2" style="font-size:0.72rem;flex-shrink:0" onclick="openTemplateModal()">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#promptDetail">
                                <i class="fas fa-eye"></i> Xem Prompt AI
                            </button>
                        </div>
                    </div>
                    <!-- Nội dung prompt collapse -->
                    <div class="collapse mt-2" id="promptDetail">
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; border: 1px solid #90caf9;">
                            <pre id="aiPrompt" style="margin: 0; font-size: 0.7rem; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto;">Hãy dịch các giá trị (values) trong file JSON này sang {TARGET_LANG}.

Quy tắc bắt buộc:
1. Giữ nguyên 100% các keys (tọa độ cell như "Sheet1!A1")
2. CHỈ dịch nội dung bên trong values
3. KHÔNG dịch các từ/cụm từ đã là ngôn ngữ đích - GIỮ NGUYÊN chúng
4. KHÔNG dịch các mã kỹ thuật, placeholder, hoặc tên biến
5. KHÔNG dịch số, ngày tháng, ký hiệu đặc biệt
6. Giữ nguyên format JSON chuẩn

⚠️ QUY TẮC QUAN TRỌNG về dấu ngoặc kép:
- CHỈ sử dụng dấu ngoặc kép THẲNG chuẩn JSON: " (U+0022)
- TUYỆT ĐỐI KHÔNG dùng dấu ngoặc kép đặc biệt: " " „ ‟ « »
- Nếu cần trích dẫn trong nội dung dịch: dùng 「 」hoặc 'đơn'
- Ví dụ ĐÚNG: "App 「Order Printer Pro」 の使用"
- Ví dụ SAI: "App "Order Printer Pro" の使用" ❌

Output yêu cầu:
- Trả về ĐÚNG cấu trúc JSON gốc
- KHÔNG thêm giải thích hay văn bản nào khác
- Đảm bảo encoding UTF-8
- Kiểm tra kỹ KHÔNG có dấu ngoặc kép đặc biệt trong output</pre>
                        </div>
                    </div>
                    <!-- Kết quả sau khi trích xuất -->
                    <div id="extractResult" style="display: none;">
                        <hr class="my-2">                        

                        <!-- Dedup Panel -->
                        <div id="dedupPanel" style="display:none;"></div>

                        <!-- Danh sách file JSON -->
                        <div id="jsonFileList"></div>

                        <!-- Btn download ZIP -->
                        <div class="text-center mb-2">
                            <a id="downloadZipBtn" href="/download-zip" class="btn btn-success btn-sm">
                                <i class="fas fa-file-archive"></i> Tải ZIP
                            </a>
                            <span id="extractSummary" class="text-muted small ms-2"></span>
                        </div>
                                                
                        <!-- Duplicate warning -->
                        

                    </div>
                    

                    <!-- Hướng dẫn collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step2Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>Hướng dẫn sử dụng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step2Guide">
                            <div class="p-2" style=" border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li>Click "Trích xuất JSON" để xử lý</li>
                                    <li>Sau khi xong: hiển thị từng file JSON</li>
                                    <li>Click <strong>Copy</strong> để copy prompt + JSON → paste vào AI</li>
                                    <li>Click <strong>Tải ZIP</strong> để tải tất cả file</li>
                                    <li>Excel: Bỏ qua số và công thức</li>
                                    <li>PowerPoint: Trích xuất text từ shapes</li>
                                    <li>Word: Trích xuất text từ paragraphs, bảng, header/footer</li>
                                    <li>Mỗi file JSON chứa 400 cặp key-value</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bước 3: Inject -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">3</span>
                        <h3 class="d-inline">Nạp bản dịch</h3>
                        <p class="text-muted small mt-2">Inject JSON đã dịch vào file</p>
                    </div>
                    
                    <form id="injectForm" enctype="multipart/form-data">
                        <!-- Tab chọn giữa Upload file và Paste JSON -->
                        <ul class="nav nav-tabs nav-fill mb-2" id="injectTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#uploadTab" type="button" role="tab">
                                    <i class="fas fa-folder-open"></i> Upload File
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="paste-tab" data-bs-toggle="tab" data-bs-target="#pasteTab" type="button" role="tab">
                                    <i class="fas fa-paste"></i> Paste JSON
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="injectTabContent">
                            <!-- Tab Upload File -->
                            <div class="tab-pane fade" id="uploadTab" role="tabpanel">
                                <div class="upload-area compact" id="injectJsonUploadArea">
                                    <i class="fas fa-file-code"></i>
                                    <p class="mb-2 small"><strong>Kéo thả JSON/ZIP</strong></p>
                                    <input type="file" class="form-control" id="injectJsonFile" name="json_files" accept=".json,.zip" multiple style="display: none;">
                                    <label for="injectJsonFile" class="btn btn-custom btn-sm">
                                        <i class="fas fa-folder-open"></i> Chọn file
                                    </label>
                                </div>
                                
                                <div id="injectJsonFileInfo" class="file-info" style="display: none;">
                                    <div id="injectJsonFileList"></div>
                                    <button type="button" class="btn btn-sm btn-outline-danger float-end mt-2" id="injectJsonFileRemove">
                                        <i class="fas fa-times"></i> Xóa tất cả
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tab Paste JSON -->
                            <div class="tab-pane fade show active" id="pasteTab" role="tabpanel">
                                <div class="mb-2">
                                    <label class="form-label small mb-1"><strong>Paste nội dung JSON:</strong></label>
                                    <textarea class="form-control" id="pasteJsonTextarea" rows="5" placeholder='Paste nội dung JSON vào đây, ví dụ:
{
  "Sheet1!A1": "Translated text 1",
  "Sheet1!A2": "Translated text 2"
}' style="font-family: monospace; font-size: 0.85rem;"></textarea>
                                </div>
                                <div class="text-center mb-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="addPastedJsonBtn">
                                        <i class="fas fa-plus-circle"></i> Thêm JSON này
                                    </button>
                                </div>
                                
                                <!-- Danh sách JSON đã paste -->
                                <div id="pastedJsonList" style="display: none;">
                                    <div class="file-info">
                                        <label class="form-label small mb-1"><strong>Đã thêm:</strong></label>
                                        <div id="pastedJsonItems"></div>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="clearPastedJsonBtn">
                                            <i class="fas fa-trash"></i> Xóa tất cả
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-2">
                            <button type="submit" class="btn btn-custom btn-sm" id="injectBtn" disabled>
                                <i class="fas fa-download"></i> Nạp & Tải về
                            </button>
                        </div>

                        <!-- Validation -->
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-info btn-sm w-100" id="validateBtn" onclick="runValidation()">
                                <i class="fas fa-check-double"></i> Kiểm tra bản dịch
                            </button>
                            <div id="validationResult" class="mt-2" style="display:none;"></div>
                        </div>
                        
                        <div class="loading text-center" id="injectLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang xử lý...</span>
                            </div>
                            <p class="mt-2 small">Đang nạp bản dịch...</p>
                        </div>
                        
                        <div id="injectAlert"></div>
                    </form>
                    
                    <!-- Hướng dẫn collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step3Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>Hướng dẫn sử dụng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step3Guide">
                            <div class="p-2" style="border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li><strong>2 cách nạp JSON:</strong></li>
                                    <li style="list-style: none; padding-left: 15px;">
                                        • <strong>Upload file:</strong> Chọn file JSON/ZIP (hỗ trợ nhiều file cùng lúc)
                                    </li>
                                    <li style="list-style: none; padding-left: 15px;">
                                        • <strong>Paste JSON:</strong> Paste trực tiếp nội dung JSON (có thể paste nhiều lần)
                                    </li>
                                    <li>Tự động gộp và nạp vào file gốc (Excel, PowerPoint <b>hoặc Word</b>)</li>
                                    <li>Giữ nguyên định dạng, màu sắc, bảng, header/footer cho Word</li>
                                    <li>Tải về file output_translated</li>
                                    <li>File tạm tự động xóa sau khi tải</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div><!-- /tab-pane tab1 -->
        <div class="tab-pane fade" id="mainTab2" role="tabpanel" aria-labelledby="main-tab2">
            <div class="row g-3">
                <!-- Bước 1: Upload ảnh -->
                <div class="col-lg-4">
                    <div class="function-card">
                        <div class="text-center">
                            <span class="step-number">1</span>
                            <h3 class="d-inline">Upload Ảnh</h3>
                            <p class="text-muted small mt-2">Chọn ảnh cần dịch</p>
                        </div>
                        <div class="upload-area compact" id="imgUploadArea">
                            <i class="fas fa-image"></i>
                            <p class="mb-2 small"><strong>Kéo thả ảnh vào đây</strong></p>
                            <input type="file" id="imgFileInput" accept=".png,.jpg,.jpeg,.gif,.webp,.bmp" style="display:none;">
                            <label for="imgFileInput" class="btn btn-custom btn-sm">
                                <i class="fas fa-folder-open"></i> Chọn ảnh
                            </label>
                        </div>
                        <div id="imgPreviewWrap" style="display:none;" class="mt-2 text-center">
                            <img id="imgPreview" src="" style="max-width:100%; border-radius:8px; max-height:150px; object-fit:contain;" alt="Preview">
                            <div class="file-info mt-1 d-flex align-items-center gap-2">
                                <span id="imgFileName" class="small flex-grow-1"></span>
                                <button type="button" class="btn btn-sm btn-outline-danger" id="imgRemoveBtn"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div id="imgUploadAlert" class="mt-2"></div>
                        <div class="mt-3">
                            <label class="form-label small mb-1"><i class="fas fa-font"></i> <strong>Ngôn ngữ nguồn (tùy chọn):</strong></label>
                            <input type="text" class="form-control form-control-sm" id="imgSourceLang" placeholder="Ví dụ: tiếng Anh, tiếng Trung...">
                        </div>
                        <div class="mt-2">
                            <label class="form-label small mb-1"><i class="fas fa-globe"></i> <strong>Ngôn ngữ đích:</strong></label>
                            <select class="form-select form-select-sm" id="imgTargetLangSelect">
                                <option value="" disabled>Đang tải...</option>
                            </select>
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-custom btn-sm" id="genPromptBtn" disabled>
                                <i class="fas fa-magic"></i> Tạo Prompt
                            </button>
                        </div>
                        <div class="mt-3">
                            <div class="collapse-toggle p-2" style="background:#f8f9fa;border-radius:5px;" data-bs-toggle="collapse" data-bs-target="#imgStep1Guide">
                                <i class="fas fa-info-circle text-info"></i>
                                <small><strong>Hướng dẫn</strong></small>
                                <i class="fas fa-chevron-down float-end"></i>
                            </div>
                            <div class="collapse mt-2" id="imgStep1Guide">
                                <div class="p-2" style="border-radius:5px;">
                                    <ul class="small mb-0" style="padding-left:20px;">
                                        <li>Hỗ trợ: PNG, JPG, JPEG, GIF, WEBP, BMP</li>
                                        <li>Ngôn ngữ nguồn có thể bỏ trống</li>
                                        <li>Chọn ngôn ngữ đích cần dịch sang</li>
                                        <li>Nhấn <b>Tạo Prompt</b> để chuyển sang bước 2</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bước 2: Prompt AI -->
                <div class="col-lg-4">
                    <div class="function-card">
                        <div class="text-center">
                            <span class="step-number">2</span>
                            <h3 class="d-inline">Prompt AI</h3>
                            <p class="text-muted small mt-2">Copy &amp; gửi cho AI cùng ảnh</p>
                        </div>
                        <div id="imgPromptEmpty" class="text-center text-muted mt-4">
                            <i class="fas fa-arrow-left" style="font-size:2rem;opacity:0.3;"></i>
                            <p class="mt-2 small">Upload ảnh và nhấn <br><b>Tạo Prompt</b> ở bước 1</p>
                        </div>
                        <div id="imgPromptWrap" style="display:none;">
                            <div class="alert alert-info small py-2 mb-2">
                                <i class="fas fa-lightbulb"></i> Copy prompt, mở <strong>Gemini / Grok / ChatGPT</strong>, đính kèm ảnh + prompt rồi gửi.
                            </div>
                            <textarea class="form-control" id="imgPromptText" rows="12" readonly style="font-size:0.75rem;font-family:monospace;resize:vertical;"></textarea>
                            <div class="text-center mt-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="copyImgPromptBtn">
                                    <i class="fas fa-copy"></i> Copy Prompt
                                </button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="collapse-toggle p-2" style="background:#f8f9fa;border-radius:5px;" data-bs-toggle="collapse" data-bs-target="#imgStep2Guide">
                                <i class="fas fa-info-circle text-info"></i>
                                <small><strong>Hướng dẫn</strong></small>
                                <i class="fas fa-chevron-down float-end"></i>
                            </div>
                            <div class="collapse mt-2" id="imgStep2Guide">
                                <div class="p-2" style="border-radius:5px;">
                                    <ul class="small mb-0" style="padding-left:20px;">
                                        <li>Copy prompt và mở AI (Gemini, Grok...)</li>
                                        <li>Đính kèm ảnh + paste prompt rồi gửi</li>
                                        <li>AI trả về JSON chứa tọa độ và bản dịch</li>
                                        <li>Copy toàn bộ JSON đó → sang Bước 3</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bước 3: Paste JSON & Render -->
                <div class="col-lg-4">
                    <div class="function-card">
                        <div class="text-center">
                            <span class="step-number">3</span>
                            <h3 class="d-inline">Dán JSON &amp; Render</h3>
                            <p class="text-muted small mt-2">Paste JSON từ AI để xem kết quả</p>
                        </div>
                        <div>
                            <label class="form-label small mb-1"><strong>Paste JSON từ AI:</strong></label>
                            <textarea class="form-control" id="imgJsonTextarea" rows="10"
                                placeholder='{"text_blocks": [{"original":"...","translated":"...","top_pct":10,"left_pct":5,"width_pct":30,"height_pct":5,"bg_color":"#ffffff","text_color":"#000000","font_size_pct":2.5}]}'
                                style="font-family:monospace;font-size:0.75rem;resize:vertical;"></textarea>
                        </div>
                        <div id="imgJsonAlert" class="mt-2"></div>
                        <div class="text-center mt-2">
                            <button type="button" class="btn btn-custom btn-sm" id="renderOverlayBtn" disabled>
                                <i class="fas fa-layer-group"></i> Render Overlay
                            </button>
                        </div>
                        <div class="mt-3">
                            <div class="collapse-toggle p-2" style="background:#f8f9fa;border-radius:5px;" data-bs-toggle="collapse" data-bs-target="#imgStep3Guide">
                                <i class="fas fa-info-circle text-info"></i>
                                <small><strong>Hướng dẫn</strong></small>
                                <i class="fas fa-chevron-down float-end"></i>
                            </div>
                            <div class="collapse mt-2" id="imgStep3Guide">
                                <div class="p-2" style="border-radius:5px;">
                                    <ul class="small mb-0" style="padding-left:20px;">
                                        <li>Paste JSON trả về từ AI</li>
                                        <li>Nhấn <b>Render Overlay</b> để hiển thị</li>
                                        <li><b>Click</b> vào khối → chỉnh sửa nội dung, màu</li>
                                        <li><b>Kéo thả</b> khối → di chuyển vị trí</li>
                                        <li><b>Kéo giãn góc/cạnh</b> → thay đổi kích thước</li>
                                        <li><b>Delete / Backspace</b> → xóa khối đã chọn</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kết quả Overlay -->
            <div id="imgOverlayResult" class="mt-4" style="display:none;">
                <div class="function-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="mb-0"><i class="fas fa-eye"></i> Kết quả Overlay</h3>
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="toggleOriginalBtn" onclick="toggleImgOriginalText()">
                                <i class="fas fa-eye-slash"></i> Ẩn/hiện chữ gốc
                            </button>
                            <button type="button" id="saveImageBtn" class="btn btn-outline-success btn-sm" onclick="saveOverlayAsImage()">
                                <i class="fas fa-download"></i> Lưu ảnh
                            </button>
                        </div>
                    </div>
                    <div class="alert alert-secondary small py-2 mb-2" style="font-size:0.75rem;">
                        <i class="fas fa-hand-pointer"></i> <b>Click</b> = chỉnh sửa &ensp;
                        <i class="fas fa-arrows-alt"></i> <b>Kéo khối</b> = di chuyển &ensp;
                        <i class="fas fa-expand-alt"></i> <b>Kéo góc/cạnh</b> = kích thước &ensp;
                        <kbd>Delete</kbd> = xóa &ensp;
                        <kbd>Ctrl</kbd>+<b>Click</b> = chọn nhiều &ensp;
                        <i class="fas fa-object-group"></i> <b>Kéo khi chọn nhiều</b> = di chuyển đồng loạt
                    </div>
                    <!-- Zoom controls -->
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="small text-muted"><i class="fas fa-search"></i> Zoom:</span>
                        <button type="button" class="btn btn-outline-secondary btn-sm px-2 py-0" onclick="imgZoom(-0.15)" title="Thu nhỏ"><i class="fas fa-search-minus"></i></button>
                        <span id="imgZoomLabel" class="small" style="min-width:40px;text-align:center;">100%</span>
                        <button type="button" class="btn btn-outline-secondary btn-sm px-2 py-0" onclick="imgZoom(+0.15)" title="Phóng to"><i class="fas fa-search-plus"></i></button>
                        <button type="button" class="btn btn-outline-secondary btn-sm px-2 py-0" onclick="imgZoomReset()" title="Khôi phục">↺</button>
                    </div>
                    <div style="overflow:auto;max-height:75vh;">
                        <div id="imgOverlayContainer" style="position:relative;display:inline-block;user-select:none;transform-origin:top left;">
                            <img id="imgOverlayBase" src="" style="display:block;max-width:none;" alt="Ảnh gốc">
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6><i class="fas fa-list"></i> Danh sách vùng dịch <small class="text-muted">(click để chỉnh sửa)</small></h6>
                        <div id="imgBlockList"></div>
                    </div>
                </div>
            </div>
        </div><!-- /tab-pane tab2 -->
        </div><!-- /tab-content -->
    </div>
    
    <!-- Footer -->
    <footer class="text-center mt-5" style="color: #fff; opacity: 0.85;">
        <hr style="border-color: #fff; opacity: 0.2;">
        <div class="pb-2">
            <small>
                &copy; 2026 Tomo Translation &middot; Built by <a href="mailto:eikitomobe@gmail.com" style="color: #fff; text-decoration: underline;">友部 瑛稀</a>
            </small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Modal: Edit Overlay Block -->
    <div class="modal fade" id="overlayEditModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title mb-0"><i class="fas fa-palette"></i> Chỉnh sửa khối</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editBlockIdx">
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small mb-1"><strong>Màu nền</strong></label>
                            <div class="d-flex gap-1 align-items-center">
                                <input type="color" class="form-control form-control-sm" id="editBgColor" style="width:38px;padding:2px;">
                                <input type="text" class="form-control form-control-sm" id="editBgColorHex" maxlength="7" placeholder="#ffffff">
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small mb-1"><strong>Màu chữ</strong></label>
                            <div class="d-flex gap-1 align-items-center">
                                <input type="color" class="form-control form-control-sm" id="editTextColor" style="width:38px;padding:2px;">
                                <input type="text" class="form-control form-control-sm" id="editTextColorHex" maxlength="7" placeholder="#000000">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="form-label small mb-1"><strong>Cỡ chữ</strong> <span class="text-muted">(% chiều cao ảnh)</span></label>
                        <input type="number" class="form-control form-control-sm" id="editFontSize" min="0.3" max="30" step="0.1">
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary btn-sm" id="saveBlockBtn">
                        <i class="fas fa-save"></i> Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Template Editor -->
    <div class="modal fade" id="templateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-magic"></i> Quản lý Prompt Templates</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Template list (left) + edit form (right) -->
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong class="small">Danh sách:</strong>
                                <button class="btn btn-outline-success btn-sm py-0 px-2" style="font-size:0.75rem" onclick="addNewTemplate()">
                                    <i class="fas fa-plus"></i> Thêm
                                </button>
                            </div>
                            <div id="templateList" class="list-group" style="max-height:300px;overflow-y:auto;"></div>
                        </div>
                        <div class="col-md-8" id="templateEditPanel" style="display:none;">
                            <div class="mb-2">
                                <label class="form-label small mb-1"><strong>Tên template:</strong></label>
                                <input type="text" class="form-control form-control-sm" id="editTemplateName" placeholder="Tên hiển thị...">
                            </div>
                            <div class="mb-2">
                                <label class="form-label small mb-1"><strong>Nội dung prompt</strong> <span class="text-muted">(dùng <code>{TARGET_LANG}</code> cho ngôn ngữ đích)</span>:</label>
                                <textarea class="form-control" id="editTemplateContent" rows="10" style="font-size:0.78rem;font-family:monospace;"></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="saveEditTemplate()"><i class="fas fa-save"></i> Lưu</button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteEditTemplate()"><i class="fas fa-trash"></i> Xóa</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <small class="text-muted me-auto">Templates lưu trong <code>prompt_templates.json</code></small>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== BIẾN TOÀN CỤC ====================
        let uploadedExcelFilename  = null;
        let extractedFilesData     = null;
        let extractedDedupData     = null;  // Dedup files từ server
        let currentLangCode        = 'ja';
        let currentLangName        = 'tiếng Nhật';
        let currentTemplateContent = '';
        let editingTemplateIdx     = -1;

        // ==================== NGÔN NGỮ ĐÍCH ====================
        const INITIAL_PROMPT = document.getElementById('aiPrompt').textContent;
        currentTemplateContent = INITIAL_PROMPT;

        function updatePrompt(langName) {
            let promptText = currentTemplateContent.replace(/{TARGET_LANG}/g, langName);
            document.getElementById('aiPrompt').textContent = promptText;
        }

        async function loadLanguages() {
            const select = document.getElementById('targetLangSelect');
            try {
                const res = await fetch('/api/languages');
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const langs = await res.json();
                select.innerHTML = '';
                langs.forEach(function(lang) {
                    const opt = document.createElement('option');
                    opt.value        = lang.code;
                    opt.textContent  = lang.label;
                    opt.dataset.name = lang.name;
                    if (lang.code === 'ja') opt.selected = true;
                    select.appendChild(opt);
                });
                const def = select.options[select.selectedIndex];
                if (def) {
                    currentLangCode = def.value;
                    currentLangName = def.dataset.name;
                    updatePrompt(currentLangName);
                    await loadTemplates(currentLangCode);
                }
            } catch (e) {
                select.innerHTML = '<option value="ja" data-name="tiếng Nhật">🇯🇵 Tiếng Nhật (Japanese)</option>';
                updatePrompt('tiếng Nhật');
                console.warn('Không thể tải languages.json:', e);
            }
            select.addEventListener('change', async function() {
                const chosen = this.options[this.selectedIndex];
                if (chosen) {
                    currentLangCode = chosen.value;
                    currentLangName = chosen.dataset.name;
                    updatePrompt(currentLangName);
                    await loadTemplates(currentLangCode);
                }
            });
        }

        // Chạy ngay khi trang load
        loadLanguages();

        // ==================== UPLOAD EXCEL CHUNG ====================
        const mainExcelFile = document.getElementById('mainExcelFile');
        const mainFileInfo = document.getElementById('mainFileInfo');
        const mainFileName = document.getElementById('mainFileName');
        const mainFileRemove = document.getElementById('mainFileRemove');
        const mainAlert = document.getElementById('mainAlert');
        const mainUploadArea = document.getElementById('mainUploadArea');
        const extractBtn = document.getElementById('extractBtn');
        const injectBtn = document.getElementById('injectBtn');
        
        // Xử lý khi chọn file Excel chung
        mainExcelFile.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                mainFileName.textContent = file.name;
                mainFileInfo.style.display = 'block';
                uploadedExcelFilename = file.name;
                
                // Thay đổi icon phù hợp với loại file
                const fileIcon = document.getElementById('mainFileIcon');
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.xlsx')) {
                    fileIcon.className = 'fas fa-file-excel text-success';
                } else if (fileName.endsWith('.pptx')) {
                    fileIcon.className = 'fas fa-file-powerpoint text-danger';
                } else if (fileName.endsWith('.docx')) {
                    fileIcon.className = 'fas fa-file-word text-primary';
                } else {
                    fileIcon.className = 'fas fa-file text-secondary';
                }
                
                // Kích hoạt cả 2 nút Extract và Inject
                extractBtn.disabled = false;
                injectBtn.disabled = false;
                
                // Hiển thị thông báo
                showAlert(mainAlert, 'success', `File "${file.name}" đã được chọn. Bạn có thể tiến hành Extract hoặc Inject.`);
            }
        });
        
        // Xử lý xóa file
        mainFileRemove.addEventListener('click', function() {
            mainExcelFile.value = '';
            mainFileInfo.style.display = 'none';
            uploadedExcelFilename = null;
            extractBtn.disabled = true;
            injectBtn.disabled = true;
            mainAlert.innerHTML = '';
        });
        
        // Xử lý drag and drop
        mainUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#764ba2';
            mainUploadArea.style.background = '#e9ecef';
        });
        
        mainUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#667eea';
            mainUploadArea.style.background = '#f8f9fa';
        });
        
        mainUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#667eea';
            mainUploadArea.style.background = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                mainExcelFile.files = files;
                mainFileName.textContent = files[0].name;
                mainFileInfo.style.display = 'block';
                uploadedExcelFilename = files[0].name;
                extractBtn.disabled = false;
                injectBtn.disabled = false;
                showAlert(mainAlert, 'success', `File "${files[0].name}" đã được chọn.`);
            }
        });
        
        // ==================== CHỨC NĂNG EXTRACT ====================
        
        const extractForm = document.getElementById('extractForm');
        const extractAlert = document.getElementById('extractAlert');
        const extractLoading = document.getElementById('extractLoading');
        const extractResult = document.getElementById('extractResult');
        const extractSummary = document.getElementById('extractSummary');
        const jsonFileList = document.getElementById('jsonFileList');
        
        // Xử lý submit form Extract
        extractForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Kiểm tra xem có file được upload chưa
            if (!uploadedExcelFilename || mainExcelFile.files.length === 0) {
                showAlert(extractAlert, 'warning', 'Vui lòng upload file (Excel hoặc PowerPoint) ở Bước 1 trước!');
                return;
            }
            
            // Ẩn kết quả cũ
            extractResult.style.display = 'none';
            jsonFileList.innerHTML = '';
            extractedDedupData = null;
            const dedupPanel = document.getElementById('dedupPanel');
            if (dedupPanel) { dedupPanel.style.display = 'none'; dedupPanel.innerHTML = ''; }
            
            // Hiển thị loading
            extractLoading.style.display = 'block';
            extractAlert.innerHTML = '';
            
            // Tạo FormData với file Excel từ upload chung
            const formData = new FormData();
            formData.append('file', mainExcelFile.files[0]);
            
            try {
                // Gửi request
                const response = await fetch('/extract', {
                    method: 'POST',
                    body: formData
                });
                
                // Ẩn loading
                extractLoading.style.display = 'none';
                
                // Kiểm tra content-type
                const contentType = response.headers.get('content-type');
                
                if (response.ok && contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    
                    if (data.success) {
                        // Hiển thị tóm tắt
                        // Lưu extracted data cho TM và validation
                        extractedFilesData = data.files;
                        extractedDedupData = data.dedup_files || null;

                        // Render file rows
                        renderJsonFileRows(data.files);

                        // Render dedup panel
                        if (extractedDedupData && data.dedup_stats) {
                            renderDedupPanel(extractedDedupData, data.dedup_stats);
                        }

                        // Cập nhật summary
                        const ds = data.dedup_stats;
                        if (ds && ds.saved > 0) {
                            extractSummary.textContent = `${data.total_files} file · ${data.total_items} keys (${ds.unique} unique)`;
                        } else {
                            extractSummary.textContent = `${data.total_files} file · ${data.total_items} keys`;
                        }

                        // Kiểm tra text trùng lặp
                        detectDuplicatesInFiles(data.files);

                        // Hiện khu vực kết quả
                        extractResult.style.display = 'block';

                        const ds2 = data.dedup_stats;
                        const dedupNote = (ds2 && ds2.saved > 0)
                            ? ` | 📈 <strong>Dedup:</strong> chỉ cần dịch <strong>${ds2.unique}</strong>/${ds2.total} (tiết kiệm ${ds2.saved}, ${ds2.percent_saved}%)`
                            : '';
                        //showAlert(extractAlert, 'success', `Trích xuất thành công! ${data.total_files} file JSON, ${data.total_items} cặp key-value.${dedupNote} Click <strong>Copy</strong> hoặc <strong>Copy Dedup</strong> để dùng với AI.`);
                    } else {
                        showAlert(extractAlert, 'danger', data.error || 'Có lỗi xảy ra!');
                    }
                } else if (!response.ok) {
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        showAlert(extractAlert, 'danger', error.error || 'Có lỗi xảy ra!');
                    } else {
                        const text = await response.text();
                        if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                            showAlert(extractAlert, 'danger', 'Phiên đăng nhập đã hết hạn. Vui lòng <a href="/login">đăng nhập lại</a>.');
                        } else {
                            showAlert(extractAlert, 'danger', 'Lỗi: ' + (text || 'Không xác định'));
                        }
                    }
                }
            } catch (error) {
                extractLoading.style.display = 'none';
                showAlert(extractAlert, 'danger', 'Lỗi kết nối: ' + error.message);
            }
        });
        
        // Render danh sách file JSON thành từng hàng
        function renderJsonFileRows(files) {
            jsonFileList.innerHTML = '';
            
            files.forEach(function(file, idx) {
                const row = document.createElement('div');
                row.className = 'json-file-row';
                row.innerHTML = `
                    <span class="file-name" title="${file.name}">
                        <i class="fas fa-file-code text-primary"></i>
                        ${file.name}
                    </span>
                    <button type="button"
                        class="btn btn-outline-primary btn-sm btn-copy-json"
                        data-idx="${idx}"
                        title="Copy prompt AI + nội dung JSON này">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                `;
                
                // Lưu nội dung vào data attribute (dùng dataset)
                row.querySelector('.btn-copy-json').addEventListener('click', function() {
                    const btnEl = this;
                    // Đọc prompt tại thời điểm click để luôn dùng ngôn ngữ hiện tại
                    const promptText = document.getElementById('aiPrompt').textContent;
                    const textToCopy = promptText + '\n\n' + file.content;
                    
                    navigator.clipboard.writeText(textToCopy).then(function() {
                        btnEl.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        btnEl.classList.add('copied');
                        setTimeout(function() {
                            btnEl.innerHTML = '<i class="fas fa-copy"></i> Copy';
                            btnEl.classList.remove('copied');
                        }, 2000);
                    }).catch(function() {
                        // Fallback cho browser không hỗ trợ clipboard API
                        const textarea = document.createElement('textarea');
                        textarea.value = textToCopy;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        try {
                            document.execCommand('copy');
                            btnEl.innerHTML = '<i class="fas fa-check"></i> Copied!';
                            btnEl.classList.add('copied');
                            setTimeout(function() {
                                btnEl.innerHTML = '<i class="fas fa-copy"></i> Copy';
                                btnEl.classList.remove('copied');
                            }, 2000);
                        } catch(err) {
                            alert('Không thể copy tự động. Vui lòng copy thủ công.');
                        }
                        document.body.removeChild(textarea);
                    });
                });
                
                jsonFileList.appendChild(row);
            });
        }

        // Render dedup panel – hiển thị thống kê và các file dedup
        function renderDedupPanel(dedupFiles, stats) {
            const panel = document.getElementById('dedupPanel');
            if (!panel) return;

            const savedPct = stats.saved > 0
                ? `<span class="badge bg-success ms-1">-${stats.percent_saved}%</span>`
                : '';

            let rowsHtml = dedupFiles.map((file, idx) => `
                <div class="json-file-row d-flex align-items-center gap-2" style="margin-top:4px">
                    <span class="file-name text-truncate" style="flex:1;font-size:0.78rem" title="${file.name}">
                        <i class="fas fa-compress-alt text-success"></i> ${file.name}
                    </span>
                    <button type="button"
                        class="btn btn-outline-success btn-sm btn-copy-dedup"
                        data-dedup-idx="${idx}"
                        title="Copy prompt AI + nội dung dedup JSON này (ít keys hơn)">
                        <i class="fas fa-copy"></i> Copy Dedup
                    </button>
                </div>
            `).join('');

            panel.innerHTML = `
                <div class="dedup-banner alert py-2 px-3 mb-2">
                    <strong><i class="fas fa-compress-arrows-alt text-success me-1"></i>Dedup Mode</strong>
                    — Tổng <strong>${stats.total}</strong> keys →
                    chỉ cần dịch <strong>${stats.unique}</strong> unique values
                    ${savedPct}
                    <span class="text-muted">(tiết kiệm ${stats.saved} lần dịch)</span>
                    <div class="mt-1" id="dedupFileRows">${rowsHtml}</div>
                </div>`;
            panel.style.display = 'block';

            // Gắn sự kiện cho các nút Copy Dedup
            panel.querySelectorAll('.btn-copy-dedup').forEach(btn => {
                btn.addEventListener('click', function() {
                    const btnEl = this;
                    const idx   = parseInt(this.dataset.dedupIdx);
                    const file  = extractedDedupData[idx];
                    const promptText = document.getElementById('aiPrompt').textContent;
                    const textToCopy = promptText + '\n\n' + file.content;

                    navigator.clipboard.writeText(textToCopy).then(() => {
                        btnEl.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        btnEl.classList.add('copied');
                        setTimeout(() => {
                            btnEl.innerHTML = '<i class="fas fa-copy"></i> Copy Dedup';
                            btnEl.classList.remove('copied');
                        }, 2000);
                    }).catch(() => {
                        const ta = document.createElement('textarea');
                        ta.value = textToCopy;
                        ta.style.cssText = 'position:fixed;opacity:0';
                        document.body.appendChild(ta);
                        ta.select();
                        try { document.execCommand('copy'); btnEl.innerHTML = '<i class="fas fa-check"></i> Copied!'; setTimeout(() => { btnEl.innerHTML = '<i class="fas fa-copy"></i> Copy Dedup'; }, 2000); }
                        catch(e) { alert('Không thể copy tự động.'); }
                        document.body.removeChild(ta);
                    });
                });
            });
        }
        
        const injectForm = document.getElementById('injectForm');
        const injectJsonFile = document.getElementById('injectJsonFile');
        const injectJsonFileInfo = document.getElementById('injectJsonFileInfo');
        const injectJsonFileName = document.getElementById('injectJsonFileName');
        const injectJsonFileRemove = document.getElementById('injectJsonFileRemove');
        const injectAlert = document.getElementById('injectAlert');
        const injectLoading = document.getElementById('injectLoading');
        
        // Paste JSON functionality
        const pasteJsonTextarea = document.getElementById('pasteJsonTextarea');
        const addPastedJsonBtn = document.getElementById('addPastedJsonBtn');
        const pastedJsonList = document.getElementById('pastedJsonList');
        const pastedJsonItems = document.getElementById('pastedJsonItems');
        const clearPastedJsonBtn = document.getElementById('clearPastedJsonBtn');
        
        // Lưu danh sách JSON đã paste
        let pastedJsonData = [];
        
        // Xử lý khi click "Thêm JSON này"
        addPastedJsonBtn.addEventListener('click', function() {
            const jsonText = pasteJsonTextarea.value.trim();
            
            if (!jsonText) {
                showAlert(injectAlert, 'warning', 'Vui lòng paste nội dung JSON vào ô bên trên!');
                return;
            }
            
            // Validate JSON
            try {
                const parsedJson = JSON.parse(jsonText);
                
                // Kiểm tra xem có phải object không
                if (typeof parsedJson !== 'object' || parsedJson === null) {
                    showAlert(injectAlert, 'warning', 'JSON phải là một object (không phải array hoặc giá trị đơn)!');
                    return;
                }
                
                // Thêm vào danh sách
                pastedJsonData.push(parsedJson);
                
                // Hiển thị trong danh sách
                updatePastedJsonList();
                
                // Xóa textarea
                pasteJsonTextarea.value = '';
                
                // Hiển thị thông báo
                showAlert(injectAlert, 'success', `Đã thêm JSON #${pastedJsonData.length} với ${Object.keys(parsedJson).length} cặp key-value.`);
                
            } catch (e) {
                showAlert(injectAlert, 'danger', 'JSON không hợp lệ: ' + e.message);
            }
        });
        
        // Cập nhật hiển thị danh sách JSON đã paste
        function updatePastedJsonList() {
            if (pastedJsonData.length === 0) {
                pastedJsonList.style.display = 'none';
                return;
            }
            
            pastedJsonList.style.display = 'block';
            pastedJsonItems.innerHTML = '';
            
            pastedJsonData.forEach((jsonObj, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'mb-1 d-flex justify-content-between align-items-center';
                itemDiv.innerHTML = `
                    <div>
                        <i class="fas fa-clipboard text-success"></i> 
                        <small><strong>JSON #${index + 1}</strong> - ${Object.keys(jsonObj).length} keys</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePastedJson(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                pastedJsonItems.appendChild(itemDiv);
            });
        }
        
        // Xóa một JSON đã paste
        window.removePastedJson = function(index) {
            pastedJsonData.splice(index, 1);
            updatePastedJsonList();
            showAlert(injectAlert, 'info', 'Đã xóa JSON.');
        };
        
        // Xóa tất cả JSON đã paste
        clearPastedJsonBtn.addEventListener('click', function() {
            if (confirm('Xóa tất cả JSON đã paste?')) {
                pastedJsonData = [];
                updatePastedJsonList();
                showAlert(injectAlert, 'info', 'Đã xóa tất cả JSON đã paste.');
            }
        });
        
        // Xử lý khi chọn file JSON (nhiều file)
        injectJsonFile.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const fileList = document.getElementById('injectJsonFileList');
                fileList.innerHTML = '';
                
                // Hiển thị danh sách các file
                Array.from(e.target.files).forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'mb-1';
                    const icon = file.name.endsWith('.zip') ? 'fa-file-archive' : 'fa-file-code';
                    const color = file.name.endsWith('.zip') ? 'text-warning' : 'text-primary';
                    fileItem.innerHTML = `<i class="fas ${icon} ${color}"></i> <small>${file.name}</small>`;
                    fileList.appendChild(fileItem);
                });
                
                injectJsonFileInfo.style.display = 'block';
            }
        });
        
        // Xử lý xóa file JSON
        injectJsonFileRemove.addEventListener('click', function() {
            injectJsonFile.value = '';
            injectJsonFileInfo.style.display = 'none';
        });
        
        // Xử lý drag and drop cho JSON files
        const injectJsonUploadArea = document.getElementById('injectJsonUploadArea');
        
        injectJsonUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#764ba2';
            injectJsonUploadArea.style.background = '#e9ecef';
        });
        
        injectJsonUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#667eea';
            injectJsonUploadArea.style.background = '#f8f9fa';
        });
        
        injectJsonUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#667eea';
            injectJsonUploadArea.style.background = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Sử dụng DataTransfer để gán files vào input
                const dataTransfer = new DataTransfer();
                Array.from(files).forEach(file => {
                    // Chỉ chấp nhận file .json hoặc .zip
                    if (file.name.endsWith('.json') || file.name.endsWith('.zip')) {
                        dataTransfer.items.add(file);
                    }
                });
                
                if (dataTransfer.files.length > 0) {
                    injectJsonFile.files = dataTransfer.files;
                    
                    // Hiển thị danh sách files
                    const fileList = document.getElementById('injectJsonFileList');
                    fileList.innerHTML = '';
                    
                    Array.from(dataTransfer.files).forEach((file, index) => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'mb-1';
                        const icon = file.name.endsWith('.zip') ? 'fa-file-archive' : 'fa-file-code';
                        const color = file.name.endsWith('.zip') ? 'text-warning' : 'text-primary';
                        fileItem.innerHTML = `<i class="fas ${icon} ${color}"></i> <small>${file.name}</small>`;
                        fileList.appendChild(fileItem);
                    });
                    
                    injectJsonFileInfo.style.display = 'block';
                } else {
                    showAlert(injectAlert, 'warning', 'Chỉ chấp nhận file .json hoặc .zip!');
                }
            }
        });
        
        // Xử lý submit form Inject
        injectForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Kiểm tra xem có file được upload chưa
            if (!uploadedExcelFilename || mainExcelFile.files.length === 0) {
                showAlert(injectAlert, 'warning', 'Vui lòng upload file (Excel hoặc PowerPoint) ở Bước 1 trước!');
                return;
            }
            
            // Kiểm tra xem có file JSON HOẶC pasted JSON không
            if (injectJsonFile.files.length === 0 && pastedJsonData.length === 0) {
                showAlert(injectAlert, 'warning', 'Vui lòng chọn file JSON đã dịch hoặc paste JSON!');
                return;
            }
            
            // Hiển thị loading
            injectLoading.style.display = 'block';
            injectAlert.innerHTML = '';
            
            // Tạo FormData với file Excel từ upload chung và tất cả file JSON
            const formData = new FormData();
            formData.append('excel_file', mainExcelFile.files[0]);
            
            // Thêm tất cả các file JSON/ZIP
            Array.from(injectJsonFile.files).forEach(file => {
                formData.append('json_files', file);
            });
            
            // Thêm tất cả JSON đã paste (gửi dưới dạng JSON string)
            if (pastedJsonData.length > 0) {
                formData.append('pasted_json_data', JSON.stringify(pastedJsonData));
            }
            
            try {
                // Gửi request
                const response = await fetch('/inject', {
                    method: 'POST',
                    body: formData
                });
                
                // Ẩn loading
                injectLoading.style.display = 'none';
                
                if (response.ok) {
                    // Lấy tên file từ header Content-Disposition
                    const disposition = response.headers.get('Content-Disposition');
                    let filename = `output_translated_${Date.now()}.xlsx`;
                    const parsedFilename = parseDownloadFilename(disposition);
                    if (parsedFilename) {
                        filename = parsedFilename;
                    }
                    
                    // Tải file với tên đúng extension
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert(injectAlert, 'success', 'Nạp bản dịch thành công! File đang được tải về. Tất cả file tạm đã được xóa.');
                    
                    // Reset form JSON
                    injectJsonFile.value = '';
                    injectJsonFileInfo.style.display = 'none';
                    
                    // Reset pasted JSON
                    pastedJsonData = [];
                    updatePastedJsonList();
                    pasteJsonTextarea.value = '';
                    
                    // Tự động xóa tất cả file trong thư mục uploads sau khi thành công
                    await clearUploads(true);
                } else {
                    // Kiểm tra xem response có phải JSON không
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        showAlert(injectAlert, 'danger', error.error || 'Có lỗi xảy ra!');
                    } else {
                        // Nếu không phải JSON (có thể là HTML từ trang login hoặc lỗi server)
                        const text = await response.text();
                        if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                            showAlert(injectAlert, 'danger', 'Phiên đăng nhập đã hết hạn. Vui lòng <a href="/login">đăng nhập lại</a>.');
                        } else {
                            showAlert(injectAlert, 'danger', 'Lỗi: ' + (text || 'Không xác định'));
                        }
                    }
                }
            } catch (error) {
                injectLoading.style.display = 'none';
                showAlert(injectAlert, 'danger', 'Lỗi kết nối: ' + error.message);
            }
        });
        
        // ==================== HÀM TRỢ GIÚP ====================

        function parseDownloadFilename(contentDisposition) {
            if (!contentDisposition) return null;

            // Ưu tiên RFC 5987: filename*=UTF-8''...
            const filenameStarMatch = contentDisposition.match(/filename\*\s*=\s*UTF-8''([^;\n]+)/i);
            if (filenameStarMatch && filenameStarMatch[1]) {
                try {
                    return decodeURIComponent(filenameStarMatch[1].trim());
                } catch (e) {
                    // fallback xuống filename thường
                }
            }

            // Fallback: filename="..." hoặc filename=...
            const filenameMatch = contentDisposition.match(/filename\s*=\s*(("([^"]+)")|([^;\n]+))/i);
            if (filenameMatch) {
                return (filenameMatch[3] || filenameMatch[4] || '').trim();
            }

            return null;
        }
        
        // Hàm xóa tất cả file trong uploads
        async function clearUploads(skipConfirm = false) {
            // Xác nhận trước khi xóa (trừ khi skipConfirm = true)
            if (!skipConfirm && !confirm('Bạn có chắc chắn muốn xóa TẤT CẢ file trong thư mục uploads?\n\nThao tác này không thể hoàn tác!')) {
                return;
            }
            
            try {
                const response = await fetch('/clear-uploads', {
                    method: 'POST'
                });
                
                // Kiểm tra xem response có phải JSON không
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                        if (!skipConfirm) {
                            alert('❌ Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                            window.location.href = '/login';
                        }
                        return;
                    }
                    result = { error: text };
                }
                
                if (response.ok && result.success) {
                    if (!skipConfirm) {
                        alert(`✅ ${result.message}`);
                    }
                    
                    // Reset form và trạng thái
                    mainExcelFile.value = '';
                    mainFileInfo.style.display = 'none';
                    uploadedExcelFilename = null;
                    extractBtn.disabled = true;
                    injectBtn.disabled = true;
                    mainAlert.innerHTML = '';
                    injectJsonFile.value = '';
                    injectJsonFileInfo.style.display = 'none';
                } else {
                    if (!skipConfirm) {
                        alert('❌ Lỗi: ' + (result.error || result.message));
                    }
                }
            } catch (error) {
                if (!skipConfirm) {
                    alert('❌ Lỗi kết nối: ' + error.message);
                }
            }
        }
        
        // Hàm copy prompt AI
        // copyPrompt() đã được thay thế bởi renderJsonFileRows() inline copy
        

        // ==================== PROMPT TEMPLATES ====================
        let allTemplates = [];

        async function loadTemplates(lang) {
            lang = lang || currentLangCode || 'default';
            try {
                const res = await fetch('/api/templates?lang=' + encodeURIComponent(lang));
                if (!res.ok) throw new Error();
                allTemplates = await res.json();
            } catch(e) {
                allTemplates = [{id:'default', name:'Mặc định', content: INITIAL_PROMPT}];
            }
            renderTemplateSelect();
        }

        function renderTemplateSelect() {
            const sel = document.getElementById('templateSelect');
            if (!sel) return;
            sel.innerHTML = '';
            allTemplates.forEach((t, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = t.name;
                sel.appendChild(opt);
            });
            applyTemplate(0);
            // Replace with clone to clear any previously attached listeners
            const fresh = sel.cloneNode(true);
            sel.parentNode.replaceChild(fresh, sel);
            fresh.addEventListener('change', function() { applyTemplate(parseInt(this.value)); });
        }

        function applyTemplate(idx) {
            if (!allTemplates[idx]) return;
            currentTemplateContent = allTemplates[idx].content;
            updatePrompt(currentLangName);
        }

        function openTemplateModal() {
            const title = document.querySelector('#templateModal .modal-title');
            if (title) title.innerHTML = `<i class="fas fa-magic"></i> Quản lý Prompt Templates <small class="text-muted ms-1" style="font-size:0.75em">(${currentLangName})</small>`;
            renderTemplateListInModal();
            new bootstrap.Modal(document.getElementById('templateModal')).show();
        }

        function renderTemplateListInModal() {
            const list = document.getElementById('templateList');
            list.innerHTML = '';
            allTemplates.forEach((t, i) => {
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action py-1 small';
                btn.textContent = t.name;
                btn.onclick = () => openTemplateForEdit(i);
                list.appendChild(btn);
            });
        }

        function openTemplateForEdit(idx) {
            editingTemplateIdx = idx;
            document.getElementById('editTemplateName').value    = allTemplates[idx].name;
            document.getElementById('editTemplateContent').value = allTemplates[idx].content;
            document.getElementById('templateEditPanel').style.display = 'block';
            document.querySelectorAll('#templateList .list-group-item').forEach((el, i) => {
                el.classList.toggle('active', i === idx);
            });
        }

        function addNewTemplate() {
            allTemplates.push({id: 'custom_' + Date.now(), name: 'Template mới', content: INITIAL_PROMPT});
            renderTemplateListInModal();
            openTemplateForEdit(allTemplates.length - 1);
        }

        async function saveEditTemplate() {
            if (editingTemplateIdx < 0) return;
            allTemplates[editingTemplateIdx].name    = document.getElementById('editTemplateName').value.trim() || 'Template';
            allTemplates[editingTemplateIdx].content = document.getElementById('editTemplateContent').value;
            try {
                await fetch('/api/templates?lang=' + encodeURIComponent(currentLangCode), {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(allTemplates)});
            } catch(e) {}
            renderTemplateListInModal();
            renderTemplateSelect();
            alert('✅ Đã lưu template!');
        }

        async function deleteEditTemplate() {
            if (editingTemplateIdx < 0 || allTemplates.length <= 1) { alert('Cần giữ ít nhất 1 template.'); return; }
            if (!confirm('Xóa template này?')) return;
            allTemplates.splice(editingTemplateIdx, 1);
            editingTemplateIdx = -1;
            document.getElementById('templateEditPanel').style.display = 'none';
            try {
                await fetch('/api/templates?lang=' + encodeURIComponent(currentLangCode), {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(allTemplates)});
            } catch(e) {}
            renderTemplateListInModal();
            renderTemplateSelect();
        }

        // ==================== DUPLICATE DETECTION ====================
        function detectDuplicatesInFiles(files) {
            const valueCounts = {};
            files.forEach(file => {
                try {
                    const obj = JSON.parse(file.content);
                    for (const [k, v] of Object.entries(obj)) {
                        if (!valueCounts[v]) valueCounts[v] = [];
                        valueCounts[v].push(k);
                    }
                } catch(e) {}
            });
            const dups = Object.entries(valueCounts).filter(([v, keys]) => keys.length > 1);
        }

        // ==================== SMART VALIDATION ====================
        function runValidation() {
            // Gom tất cả JSON đã paste
            const translated = {};
            pastedJsonData.forEach(obj => Object.assign(translated, obj));

            if (Object.keys(translated).length === 0) {
                document.getElementById('validationResult').style.display = 'block';
                document.getElementById('validationResult').innerHTML =
                    '<div class="alert alert-warning py-1 small mt-1"><i class="fas fa-exclamation-triangle"></i> Chưa có JSON nào để kiểm tra. Hãy paste JSON đã dịch trước.</div>';
                return;
            }

            // Gom source text (nếu có)
            const source = {};
            if (extractedFilesData) {
                extractedFilesData.forEach(f => {
                    try { Object.assign(source, JSON.parse(f.content)); } catch(e) {}
                });
            }

            const errors = [], warnings = [];
            const INVALID_QUOTES = /[“”„‟«»‘’]/;
            const PLACEHOLDER_RE = /\{[\w\d_]+\}|%[sdf\d]|\$\d+|%\d+\$[sd]|%\d/g;
            const URL_RE         = /https?:\/\/[^\s"]+/g;
            const EMAIL_RE       = /[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}/g;

            for (const [key, tVal] of Object.entries(translated)) {
                // 1. Dấu ngoặc kép đặc biệt
                if (INVALID_QUOTES.test(tVal)) {
                    errors.push({key, msg: 'Có dấu ngoặc kép đặc biệt (" " hoặc tương tự) — cần thay bằng \"'});
                }
                const sVal = source[key];
                if (sVal !== undefined) {
                    // 2. Placeholder bị thiếu
                    const srcPH = [...sVal.matchAll(PLACEHOLDER_RE)].map(m => m[0]);
                    const missing = srcPH.filter(ph => !tVal.includes(ph));
                    if (missing.length > 0) {
                        errors.push({key, msg: `Thiếu placeholder: ${missing.join(', ')}`});
                    }
                    // 3. Độ dài chênh lệch > 50%
                    if (sVal.length > 5) {
                        const ratio = tVal.length / sVal.length;
                        if (ratio > 2.0 || ratio < 0.3) {
                            warnings.push({key, msg: `Độ dài khác biệt nhiều: gốc ${sVal.length} → dịch ${tVal.length} ký tự`});
                        }
                    }
                    // 4. URL không được thay đổi
                    const srcURLs = [...sVal.matchAll(URL_RE)].map(m => m[0]);
                    srcURLs.filter(u => !tVal.includes(u)).forEach(u => {
                        warnings.push({key, msg: `URL cần giữ nguyên: ${u.substring(0, 50)}`});
                    });
                    // 5. Email không được thay đổi
                    const srcEmails = [...sVal.matchAll(EMAIL_RE)].map(m => m[0]);
                    srcEmails.filter(e => !tVal.includes(e)).forEach(e => {
                        warnings.push({key, msg: `Email cần giữ nguyên: ${e}`});
                    });
                }
            }

            renderValidationResult(errors, warnings, Object.keys(translated).length);
        }

        function renderValidationResult(errors, warnings, totalKeys) {
            const el = document.getElementById('validationResult');
            el.style.display = 'block';
            if (errors.length === 0 && warnings.length === 0) {
                el.innerHTML = `<div class="alert alert-success py-1 small mt-1"><i class="fas fa-check-circle"></i> Kiểm tra ${totalKeys} keys — Không phát hiện vấn đề!</div>`;
                return;
            }
            let html = `<div class="mt-1" style="font-size:0.78rem;">
                <div class="mb-1"><strong>${totalKeys} keys</strong> — <span class="text-danger">${errors.length} lỗi</span>, <span class="text-warning">${warnings.length} cảnh báo</span></div>`;
            if (errors.length > 0) {
                html += `<div class="mb-1"><strong class="text-danger"><i class="fas fa-times-circle"></i> Lỗi:</strong>
                    <ul class="mb-0 ps-3">` +
                    errors.slice(0, 20).map(e => `<li><code>${e.key.substring(0,30)}</code>: ${e.msg}</li>`).join('') +
                    (errors.length > 20 ? `<li>... và ${errors.length - 20} lỗi khác</li>` : '') +
                    `</ul></div>`;
            }
            if (warnings.length > 0) {
                html += `<div><strong class="text-warning"><i class="fas fa-exclamation-triangle"></i> Cảnh báo:</strong>
                    <ul class="mb-0 ps-3">` +
                    warnings.slice(0, 10).map(w => `<li><code>${w.key.substring(0,30)}</code>: ${w.msg}</li>`).join('') +
                    (warnings.length > 10 ? `<li>... và ${warnings.length - 10} cảnh báo khác</li>` : '') +
                    `</ul></div>`;
            }
            html += '</div>';
            el.innerHTML = html;
        }


        // ==================== DARK MODE ====================
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark ? '1' : '0');
            document.getElementById('darkModeIcon').className   = isDark ? 'fas fa-sun'  : 'fas fa-moon';
            document.getElementById('darkModeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }
        (function() {
            // Mặc định là Dark Mode (đã set class dark-mode trong <body>)
            // Nếu user đã chủ động chọn Light Mode ('0'), thì mới chuyển về Light
            if (localStorage.getItem('darkMode') === '0') {
                document.body.classList.remove('dark-mode');
                document.getElementById('darkModeIcon').className    = 'fas fa-moon';
                document.getElementById('darkModeLabel').textContent = 'Dark Mode';
            }
        })();

                function showAlert(element, type, message) {
            element.innerHTML = `
                <div class="alert alert-${type} alert-custom alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // ==================== DỊCH ẢNH (IMAGE OVERLAY) ====================
        let imgCurrentFilename = null;
        let imgCurrentLangName = 'tiếng Nhật';
        let imgTextBlocks = [];
        let imgShowOriginal = false;

        // Populate imgTargetLangSelect từ cùng API languages
        async function loadImgLanguages() {
            const select = document.getElementById('imgTargetLangSelect');
            try {
                const resp = await fetch('/api/languages');
                if (!resp.ok) throw new Error();
                const langs = await resp.json();
                select.innerHTML = '';
                langs.forEach(lang => {
                    const opt = document.createElement('option');
                    opt.value = lang.code || lang.name;
                    opt.textContent = lang.name;
                    opt.dataset.langName = lang.name;
                    select.appendChild(opt);
                });
                if (langs.length > 0) imgCurrentLangName = langs[0].name;
            } catch(e) {
                select.innerHTML = '<option value="ja">tiếng Nhật</option>';
            }
            select.addEventListener('change', function() {
                const opt = this.selectedOptions[0];
                imgCurrentLangName = opt.dataset.langName || opt.textContent;
            });
        }
        loadImgLanguages();

        const imgFileInput    = document.getElementById('imgFileInput');
        const imgUploadArea   = document.getElementById('imgUploadArea');
        const imgPreviewWrap  = document.getElementById('imgPreviewWrap');
        const imgPreview      = document.getElementById('imgPreview');
        const imgFileNameEl   = document.getElementById('imgFileName');
        const imgRemoveBtn    = document.getElementById('imgRemoveBtn');
        const imgUploadAlert  = document.getElementById('imgUploadAlert');
        const genPromptBtn    = document.getElementById('genPromptBtn');
        const renderOverlayBtn = document.getElementById('renderOverlayBtn');

        imgFileInput.addEventListener('change', e => { if (e.target.files.length > 0) handleImgFile(e.target.files[0]); });

        imgUploadArea.addEventListener('dragover',  e => { e.preventDefault(); imgUploadArea.style.borderColor = '#764ba2'; });
        imgUploadArea.addEventListener('dragleave', e => { e.preventDefault(); imgUploadArea.style.borderColor = '#667eea'; });
        imgUploadArea.addEventListener('drop', e => {
            e.preventDefault();
            imgUploadArea.style.borderColor = '#667eea';
            if (e.dataTransfer.files.length > 0) handleImgFile(e.dataTransfer.files[0]);
        });

        imgRemoveBtn.addEventListener('click', function() {
            imgFileInput.value = '';
            imgCurrentFilename = null;
            imgPreviewWrap.style.display = 'none';
            genPromptBtn.disabled = true;
            renderOverlayBtn.disabled = true;
            document.getElementById('imgPromptWrap').style.display = 'none';
            document.getElementById('imgPromptEmpty').style.display = 'block';
            document.getElementById('imgOverlayResult').style.display = 'none';
            imgUploadAlert.innerHTML = '';
        });

        async function handleImgFile(file) {
            const allowed = ['image/png','image/jpeg','image/jpg','image/gif','image/webp','image/bmp'];
            if (!allowed.includes(file.type)) {
                imgUploadAlert.innerHTML = '<div class="alert alert-danger small py-2">Định dạng không hỗ trợ. Chỉ nhận PNG, JPG, GIF, WEBP, BMP.</div>';
                return;
            }
            imgUploadAlert.innerHTML = '<div class="alert alert-info small py-2"><i class="fas fa-spinner fa-spin"></i> Đang upload...</div>';
            const fd = new FormData();
            fd.append('image', file);
            try {
                const resp = await fetch('/img-translate/upload', { method: 'POST', body: fd });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Upload thất bại');
                imgCurrentFilename = data.filename;
                imgPreview.src = `/img-translate/image/${data.filename}`;
                imgFileNameEl.textContent = file.name;
                imgPreviewWrap.style.display = 'block';
                genPromptBtn.disabled = false;
                renderOverlayBtn.disabled = false;
                imgUploadAlert.innerHTML = '<div class="alert alert-success small py-2"><i class="fas fa-check"></i> Upload thành công!</div>';
                setTimeout(() => { imgUploadAlert.innerHTML = ''; }, 2500);
            } catch(err) {
                imgUploadAlert.innerHTML = `<div class="alert alert-danger small py-2">${err.message}</div>`;
            }
        }

        // Tạo Prompt
        genPromptBtn.addEventListener('click', async function() {
            const sourceLang = document.getElementById('imgSourceLang').value.trim();
            // Pass actual image pixel dimensions so AI can anchor coordinates
            const imgW = imgPreview.naturalWidth  || 0;
            const imgH = imgPreview.naturalHeight || 0;
            try {
                const resp = await fetch('/img-translate/prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_lang: imgCurrentLangName,
                        source_lang: sourceLang,
                        image_width:  imgW,
                        image_height: imgH
                    })
                });
                const data = await resp.json();
                document.getElementById('imgPromptText').value = data.prompt;
                document.getElementById('imgPromptWrap').style.display = 'block';
                document.getElementById('imgPromptEmpty').style.display = 'none';
            } catch(err) {
                alert('Lỗi tạo prompt: ' + err.message);
            }
        });

        // Copy Prompt
        document.getElementById('copyImgPromptBtn').addEventListener('click', function() {
            const text = document.getElementById('imgPromptText').value;
            navigator.clipboard.writeText(text).then(() => {
                this.innerHTML = '<i class="fas fa-check"></i> Đã copy!';
                this.classList.replace('btn-outline-primary', 'btn-success');
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-copy"></i> Copy Prompt';
                    this.classList.replace('btn-success', 'btn-outline-primary');
                }, 2000);
            });
        });

        // Render Overlay
        renderOverlayBtn.addEventListener('click', function() {
            const jsonText = document.getElementById('imgJsonTextarea').value.trim();
            const imgJsonAlert = document.getElementById('imgJsonAlert');
            if (!jsonText) { imgJsonAlert.innerHTML = '<div class="alert alert-warning small py-2">Vui lòng paste JSON từ AI.</div>'; return; }
            if (!imgCurrentFilename) { imgJsonAlert.innerHTML = '<div class="alert alert-warning small py-2">Vui lòng upload ảnh trước.</div>'; return; }
            try {
                const parsed = JSON.parse(jsonText);
                if (!parsed.text_blocks || !Array.isArray(parsed.text_blocks)) throw new Error('thiếu trường "text_blocks"');
                imgTextBlocks = parsed.text_blocks;
                imgJsonAlert.innerHTML = '';
                renderAllOverlays();
            } catch(e) {
                imgJsonAlert.innerHTML = `<div class="alert alert-danger small py-2">JSON không hợp lệ: ${e.message}</div>`;
            }
        });

        function renderAllOverlays() {
            const container = document.getElementById('imgOverlayContainer');
            const imgEl     = document.getElementById('imgOverlayBase');
            const result    = document.getElementById('imgOverlayResult');
            const blockList = document.getElementById('imgBlockList');

            imgEl.src = `/img-translate/image/${imgCurrentFilename}`;
            result.style.display = 'block';
            setTimeout(() => result.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);

            container.querySelectorAll('.overlay-block').forEach(el => el.remove());
            blockList.innerHTML = '';
            selectedBlockIdx = -1;
            selectedBlockIdxSet.clear();

            function doRender() {
                imgTextBlocks.forEach((block, idx) => {
                    createOverlayBlock(block, idx, container, imgEl);
                    appendBlockListRow(block, idx, blockList);
                });
            }
            if (imgEl.complete && imgEl.naturalWidth > 0) doRender();
            else imgEl.onload = doRender;
        }

        let selectedBlockIdx  = -1;
        let selectedBlockIdxSet = new Set();   // multi-select set

        /**
         * selectBlock(idx, ctrlKey)
         * - ctrlKey=false (default): single-select – clears all, selects only idx
         * - ctrlKey=true:           toggle idx in/out of the selection set
         */
        function selectBlock(idx, ctrlKey) {
            const container = document.getElementById('imgOverlayContainer');
            if (ctrlKey && idx >= 0) {
                // Toggle
                if (selectedBlockIdxSet.has(idx)) {
                    selectedBlockIdxSet.delete(idx);
                    const el = container.querySelector(`.overlay-block[data-idx="${idx}"]`);
                    if (el) el.classList.remove('selected');
                } else {
                    selectedBlockIdxSet.add(idx);
                    const el = container.querySelector(`.overlay-block[data-idx="${idx}"]`);
                    if (el) el.classList.add('selected');
                }
                // Keep selectedBlockIdx pointing at the most-recently toggled block
                selectedBlockIdx = selectedBlockIdxSet.size > 0 ? idx : -1;
            } else {
                // Single select
                container.querySelectorAll('.overlay-block').forEach(el => el.classList.remove('selected'));
                selectedBlockIdxSet.clear();
                selectedBlockIdx = idx;
                if (idx >= 0) {
                    selectedBlockIdxSet.add(idx);
                    const el = container.querySelector(`.overlay-block[data-idx="${idx}"]`);
                    if (el) el.classList.add('selected');
                }
            }
        }

        // Delete / Backspace to remove selected block(s)
        document.addEventListener('keydown', function(e) {
            if (selectedBlockIdxSet.size === 0) return;
            const tag = document.activeElement ? document.activeElement.tagName : '';
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
            if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault();
                // Remove in descending order so splicing does not shift remaining indices
                const toDelete = Array.from(selectedBlockIdxSet).sort((a, b) => b - a);
                toDelete.forEach(i => imgTextBlocks.splice(i, 1));
                selectedBlockIdxSet.clear();
                selectedBlockIdx = -1;
                renderAllOverlays();
            }
        });

        // Click outside → deselect all
        document.getElementById('imgOverlayContainer').addEventListener('mousedown', function(e) {
            if (!e.target.closest('.overlay-block')) selectBlock(-1, false);
        });

        function createOverlayBlock(block, idx, container, imgEl) {
            const div = document.createElement('div');
            div.className = 'overlay-block';
            div.dataset.idx = idx;
            const bg = block.bg_color || '#ffffff';
            const fg = block.text_color || '#000000';
            // Derive font-size in px from font_size_pct (% of image height).
            // If AI gave a value too small relative to block height, auto-scale up.
            const blockHeightPx = imgEl.naturalHeight * (block.height_pct || 5) / 100;
            let fsPx = imgEl.naturalHeight * (block.font_size_pct || 0) / 100;
            // Fallback: font must be at least 45% of block height (single-line readable)
            if (fsPx < blockHeightPx * 0.45) fsPx = blockHeightPx * 0.72;
            const fs = fsPx + 'px';
            Object.assign(div.style, {
                position: 'absolute',
                top:    block.top_pct    + '%',
                left:   block.left_pct   + '%',
                width:  block.width_pct  + '%',
                height: block.height_pct + '%',
                backgroundColor: bg,
                color: fg,
                display: 'flex',
                flexDirection: 'column',
                justifyContent: 'center',
                alignItems: 'center',
                overflow: 'visible',
                cursor: 'move',
                fontSize: fs,
                lineHeight: '1.2',
                padding: '2px',
                zIndex: '10',
                boxSizing: 'border-box',
                userSelect: 'none'
            });

            // Text content wrapper (clips text inside block)
            const inner = document.createElement('div');
            inner.style.cssText = 'display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%;height:100%;overflow:hidden;pointer-events:none;';
            const textSpan = document.createElement('span');
            textSpan.className = 'overlay-translated';
            textSpan.textContent = block.translated || '';
            inner.appendChild(textSpan);
            if (imgShowOriginal && block.original) {
                const origDiv = document.createElement('div');
                origDiv.className = 'overlay-original';
                origDiv.textContent = '[' + block.original + ']';
                inner.appendChild(origDiv);
            }
            div.appendChild(inner);

            // Resize handles
            ['nw','n','ne','e','se','s','sw','w'].forEach(dir => {
                const h = document.createElement('div');
                h.className = `resize-handle rh-${dir}`;
                h.dataset.dir = dir;
                div.appendChild(h);
            });

            // Interaction: drag (move) + resize
            attachBlockInteraction(div, idx, container);
            container.appendChild(div);
        }

        function attachBlockInteraction(div, idx, container) {
            div.addEventListener('mousedown', function(e) {
                // Check if we're clicking a resize handle
                const handle = e.target.closest('.resize-handle');
                const dir = handle ? handle.dataset.dir : null;

                e.preventDefault();
                e.stopPropagation();

                const isCtrl = e.ctrlKey || e.metaKey;
                // Track whether this block was already in selection BEFORE mousedown
                const wasAlreadySelected = selectedBlockIdxSet.has(idx);

                if (isCtrl) {
                    // Always ADD to selection on mousedown (never remove yet).
                    // Removal of an already-selected block is deferred to mouseup,
                    // but only if the user didn't drag (plain Ctrl+click = deselect).
                    if (!wasAlreadySelected) {
                        selectedBlockIdxSet.add(idx);
                        selectedBlockIdx = idx;
                        div.classList.add('selected');
                    }
                    // if already selected → keep it selected during potential drag
                } else if (!wasAlreadySelected) {
                    // Plain click on a block NOT in current selection → single-select
                    selectBlock(idx, false);
                }
                // Plain click on an already-selected block (no Ctrl) → keep selection for drag

                const rect  = container.getBoundingClientRect();
                const W     = rect.width;
                const H     = rect.height;
                const startX = e.clientX;
                const startY = e.clientY;
                const startTop    = imgTextBlocks[idx].top_pct;
                const startLeft   = imgTextBlocks[idx].left_pct;
                const startWidth  = imgTextBlocks[idx].width_pct;
                const startHeight = imgTextBlocks[idx].height_pct;

                // Snapshot starting positions for ALL currently-selected blocks
                const startPositions = {};
                selectedBlockIdxSet.forEach(i => {
                    if (imgTextBlocks[i]) {
                        startPositions[i] = {
                            top_pct:  imgTextBlocks[i].top_pct,
                            left_pct: imgTextBlocks[i].left_pct
                        };
                    }
                });

                let dragged = false;

                function onMove(ev) {
                    const dx = (ev.clientX - startX) / W * 100;
                    const dy = (ev.clientY - startY) / H * 100;
                    if (Math.abs(dx) > 0.2 || Math.abs(dy) > 0.2) dragged = true;

                    if (!dir) {
                        if (selectedBlockIdxSet.size > 1) {
                            // MULTI-MOVE: move every selected block by the same delta
                            selectedBlockIdxSet.forEach(i => {
                                const sp = startPositions[i];
                                const block = imgTextBlocks[i];
                                if (!sp || !block) return;
                                const newTop  = Math.max(0, Math.min(100 - block.height_pct, sp.top_pct  + dy));
                                const newLeft = Math.max(0, Math.min(100 - block.width_pct,  sp.left_pct + dx));
                                block.top_pct  = newTop;
                                block.left_pct = newLeft;
                                const blockEl = container.querySelector(`.overlay-block[data-idx="${i}"]`);
                                if (blockEl) {
                                    blockEl.style.top  = newTop  + '%';
                                    blockEl.style.left = newLeft + '%';
                                }
                            });
                        } else {
                            // Single-block MOVE
                            const newTop  = Math.max(0, Math.min(100 - startHeight, startTop  + dy));
                            const newLeft = Math.max(0, Math.min(100 - startWidth,  startLeft + dx));
                            div.style.top  = newTop  + '%';
                            div.style.left = newLeft + '%';
                            imgTextBlocks[idx].top_pct  = newTop;
                            imgTextBlocks[idx].left_pct = newLeft;
                        }
                    } else {
                        // RESIZE (always single-block)
                        let t = startTop, l = startLeft, w = startWidth, h = startHeight;
                        if (dir.includes('s')) h = Math.max(1, startHeight + dy);
                        if (dir.includes('n')) { h = Math.max(1, startHeight - dy); t = startTop + (startHeight - h); }
                        if (dir.includes('e')) w = Math.max(2, startWidth  + dx);
                        if (dir.includes('w')) { w = Math.max(2, startWidth  - dx); l = startLeft + (startWidth - w); }
                        div.style.top    = t + '%';
                        div.style.left   = l + '%';
                        div.style.width  = w + '%';
                        div.style.height = h + '%';
                        imgTextBlocks[idx].top_pct    = t;
                        imgTextBlocks[idx].left_pct   = l;
                        imgTextBlocks[idx].width_pct  = w;
                        imgTextBlocks[idx].height_pct = h;
                    }
                }

                function onUp() {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    if (isCtrl && wasAlreadySelected && !dragged) {
                        // Deferred deselect: Ctrl+click (no drag) on already-selected block → remove it
                        selectedBlockIdxSet.delete(idx);
                        selectedBlockIdx = selectedBlockIdxSet.size > 0 ? [...selectedBlockIdxSet].at(-1) : -1;
                        div.classList.remove('selected');
                    } else if (!dragged && !dir && !isCtrl) {
                        // Plain click with no drag → open edit modal
                        openImgEditModal(idx);
                    }
                }

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
        }

        function appendBlockListRow(block, idx, listEl) {
            const row = document.createElement('div');
            row.className = 'json-file-row';
            row.dataset.blockRow = idx;
            row.innerHTML = `
                <div class="file-name" style="flex:1;">
                    <span style="background:${block.bg_color||'#fff'};color:${block.text_color||'#000'};
                                 padding:1px 6px;border-radius:3px;font-size:0.8rem;margin-right:6px;">
                        ${block.translated || '(trống)'}
                    </span>
                    <span class="text-muted" style="font-size:0.72rem;">${block.original || ''}</span>
                </div>
                <button class="btn btn-outline-secondary btn-sm me-1" style="font-size:0.72rem;padding:3px 8px;" onclick="openImgEditModal(${idx})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" style="font-size:0.72rem;padding:3px 8px;" onclick="deleteImgBlock(${idx})">
                    <i class="fas fa-trash"></i>
                </button>`;
            listEl.appendChild(row);
        }

        window.deleteImgBlock = function(idx) {
            if (!confirm('Xóa block này?')) return;
            imgTextBlocks.splice(idx, 1);
            renderAllOverlays();
        };

        window.toggleImgOriginalText = function() {
            imgShowOriginal = !imgShowOriginal;
            renderAllOverlays();
        };

        // ========== EDIT MODAL ==========
        window.openImgEditModal = function(idx) {
            const block = imgTextBlocks[idx];
            document.getElementById('editBlockIdx').value = idx;
            const bg = block.bg_color || '#ffffff';
            const fg = block.text_color || '#000000';
            document.getElementById('editBgColor').value    = bg;
            document.getElementById('editBgColorHex').value = bg;
            document.getElementById('editTextColor').value    = fg;
            document.getElementById('editTextColorHex').value = fg;
            document.getElementById('editFontSize').value  = block.font_size_pct || 2;
            bootstrap.Modal.getOrCreateInstance(document.getElementById('overlayEditModal')).show();
        };

        // Color picker ↔ hex text sync
        ['Bg','Text'].forEach(which => {
            const picker   = document.getElementById(`edit${which}Color`);
            const hexInput = document.getElementById(`edit${which}ColorHex`);
            picker.addEventListener('input', () => { hexInput.value = picker.value; });
            hexInput.addEventListener('input', () => {
                if (/^#[0-9a-fA-F]{6}$/.test(hexInput.value)) picker.value = hexInput.value;
            });
        });

        document.getElementById('saveBlockBtn').addEventListener('click', function() {
            const idx = parseInt(document.getElementById('editBlockIdx').value);
            imgTextBlocks[idx].bg_color      = document.getElementById('editBgColorHex').value || document.getElementById('editBgColor').value;
            imgTextBlocks[idx].text_color    = document.getElementById('editTextColorHex').value || document.getElementById('editTextColor').value;
            imgTextBlocks[idx].font_size_pct = parseFloat(document.getElementById('editFontSize').value) || 2;
            renderAllOverlays();
            bootstrap.Modal.getInstance(document.getElementById('overlayEditModal')).hide();
        });

        // ========== ZOOM ==========
        let imgZoomLevel = 1.0;
        window.imgZoom = function(delta) {
            imgZoomLevel = Math.max(0.2, Math.min(5, imgZoomLevel + delta));
            applyZoom();
        };
        window.imgZoomReset = function() {
            imgZoomLevel = 1.0;
            applyZoom();
        };
        function applyZoom() {
            const container = document.getElementById('imgOverlayContainer');
            container.style.transform = `scale(${imgZoomLevel})`;
            container.style.transformOrigin = 'top left';
            // Update scroll container height so scrollbar reflects scaled size
            const imgEl = document.getElementById('imgOverlayBase');
            const wrapper = container.parentElement;
            wrapper.style.height = (imgEl.naturalHeight * imgZoomLevel) + 'px';
            const lbl = document.getElementById('imgZoomLabel');
            if (lbl) lbl.textContent = Math.round(imgZoomLevel * 100) + '%';
        }

        // Font-size recalc on window resize
        window.addEventListener('resize', () => {
            if (imgTextBlocks.length > 0 && document.getElementById('imgOverlayResult').style.display !== 'none') {
                const container = document.getElementById('imgOverlayContainer');
                const imgEl = document.getElementById('imgOverlayBase');
                container.querySelectorAll('.overlay-block').forEach(div => {
                    const idx = parseInt(div.dataset.idx);
                    const block = imgTextBlocks[idx];
                    if (!block) return;
                    const blockHeightPx = imgEl.naturalHeight * (block.height_pct || 5) / 100;
                    let fsPx = imgEl.naturalHeight * (block.font_size_pct || 0) / 100;
                    if (fsPx < blockHeightPx * 0.45) fsPx = blockHeightPx * 0.72;
                    div.style.fontSize = fsPx + 'px';
                });
            }
        });

        // ========== SAVE AS IMAGE ==========
        window.saveOverlayAsImage = async function() {
            const container = document.getElementById('imgOverlayContainer');
            const btn = document.getElementById('saveImageBtn');

            // Temporarily reset zoom for full-resolution capture
            const savedZoom = imgZoomLevel;
            imgZoomLevel = 1.0;
            container.style.transform = 'scale(1)';

            // Hide resize handles & selection outline during capture
            const captureStyle = document.createElement('style');
            captureStyle.id = '__captureStyle';
            captureStyle.textContent = '.resize-handle{display:none!important}.overlay-block{outline:none!important}';
            document.head.appendChild(captureStyle);

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

            try {
                const canvas = await html2canvas(container, {
                    useCORS: true,
                    allowTaint: true,
                    scale: window.devicePixelRatio || 1,
                    backgroundColor: null,
                });
                const link = document.createElement('a');
                const baseName = (imgCurrentFilename || 'overlay').replace(/\.[^.]+$/, '');
                link.download = baseName + '_translated.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch(e) {
                console.error(e);
                alert('Lỗi khi lưu ảnh: ' + e.message);
            } finally {
                // Restore
                imgZoomLevel = savedZoom;
                container.style.transform = `scale(${imgZoomLevel})`;
                document.getElementById('__captureStyle')?.remove();
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download"></i> Lưu ảnh';
            }
        };
    </script>
</body>
</html>
