<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel & PowerPoint Translation Manager</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome cho icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .function-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: 100%;
            transition: transform 0.3s;
        }
        
        .function-card:hover {
            transform: translateY(-5px);
        }
        
        .function-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .function-card .icon {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin: 15px 0;
            transition: all 0.3s;
        }
        
        .upload-area.compact {
            padding: 15px;
            margin: 10px 0;
        }
        
        .upload-area:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }
        
        .upload-area i {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .collapse-toggle {
            cursor: pointer;
            user-select: none;
        }
        
        .collapse-toggle:hover {
            opacity: 0.8;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-custom:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .alert-custom {
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .file-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .loading {
            display: none;
            margin-top: 15px;
        }
        
        .loading .spinner-border {
            width: 2rem;
            height: 2rem;
        }
        
        .json-file-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: #f0f7ff;
            border: 1px solid #cce0ff;
            border-radius: 6px;
            margin-bottom: 6px;
            gap: 8px;
        }
        
        .json-file-row .file-name {
            font-size: 0.78rem;
            color: #333;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .json-file-row .btn-copy-json {
            flex-shrink: 0;
            font-size: 0.75rem;
            padding: 3px 10px;
        }
        
        .btn-copy-json.copied {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-language"></i> Tomo Translation</h1>
            <p>Công cụ quản lý trích xuất và nạp bản dịch cho file Excel (.xlsx), PowerPoint (.pptx) và Word (.docx)</p>
            <div class="mt-3">
                <button class="btn btn-outline-light btn-sm" onclick="clearUploads()" title="Xóa file trong phiên của bạn">
                    <i class="fas fa-trash-alt"></i> Xóa file của tôi
                </button>
                <a href="/logout" class="btn btn-outline-light btn-sm ms-2" title="Đăng xuất">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </a>
            </div>
        </div>
        
        <!-- 3 Bước theo hàng ngang -->
        <div class="row g-3">
            <!-- Bước 1: Upload file -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">1</span>
                        <h3 class="d-inline">Upload File</h3>
                        <p class="text-muted small mt-2">File gốc (.xlsx/.pptx/.docx)</p>
                    </div>
                    
                    <form id="uploadExcelForm" enctype="multipart/form-data">
                        <div class="upload-area compact" id="mainUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p class="mb-2 small"><strong>Kéo thả file vào đây</strong></p>
                            <input type="file" class="form-control" id="mainExcelFile" name="file" accept=".xlsx,.pptx" style="display: none;">
                            <label for="mainExcelFile" class="btn btn-custom btn-sm">
                                <i class="fas fa-folder-open"></i> Chọn file
                            </label>
                        </div>
                        
                        <div id="mainFileInfo" class="file-info" style="display: none;">
                            <i id="mainFileIcon" class="fas fa-file text-secondary"></i>
                            <span id="mainFileName" class="small"></span>
                            <button type="button" class="btn btn-sm btn-outline-danger float-end" id="mainFileRemove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div id="mainAlert"></div>
                    </form>
                    
                    <!-- Hướng dẫn collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step1Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>Hướng dẫn sử dụng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step1Guide">
                            <div class="p-2" style="background: #f8f9fa; border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li>Hỗ trợ Excel (.xlsx), PowerPoint (.pptx) <b>và Word (.docx)</b></li>
                                    <li>Kéo thả hoặc click để chọn file</li>
                                    <li>File sẽ dùng cho cả Extract và Inject</li>
                                    <li>Giới hạn: 16MB</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bước 2: Extract -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">2</span>
                        <h3 class="d-inline">Trích xuất</h3>
                        <p class="text-muted small mt-2">Extract nội dung cần dịch</p>
                    </div>
                    
                    <form id="extractForm" enctype="multipart/form-data">
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-custom btn-sm" id="extractBtn" disabled>
                                <i class="fas fa-cog"></i> Trích xuất JSON
                            </button>
                        </div>
                        
                        <div class="loading text-center" id="extractLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang xử lý...</span>
                            </div>
                            <p class="mt-2 small">Đang trích xuất dữ liệu...</p>
                        </div>
                        
                        <div id="extractAlert"></div>
                    </form>
                    
                    <!-- Kết quả sau khi trích xuất -->
                    <div id="extractResult" style="display: none;">
                        <hr class="my-2">
                        
                        <!-- Btn download ZIP -->
                        <div class="text-center mb-2">
                            <a id="downloadZipBtn" href="/download-zip" class="btn btn-success btn-sm">
                                <i class="fas fa-file-archive"></i> Tải ZIP
                            </a>
                            <span id="extractSummary" class="text-muted small ms-2"></span>
                        </div>
                        
                        <!-- Danh sách file JSON -->
                        <div id="jsonFileList"></div>
                    </div>
                    
                    <!-- Prompt AI -->
                    <div class="mt-3 text-center">
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#promptDetail">
                            <i class="fas fa-eye"></i> Xem Prompt AI
                        </button>
                    </div>
                    
                    <!-- Nội dung prompt collapse -->
                    <div class="collapse mt-2" id="promptDetail">
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; border: 1px solid #90caf9;">
                            <pre id="aiPrompt" style="margin: 0; font-size: 0.7rem; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto;">Hãy dịch các giá trị (values) trong file JSON này sang tiếng Nhật.

Quy tắc bắt buộc:
1. Giữ nguyên 100% các keys (tọa độ cell như "Sheet1!A1")
2. CHỈ dịch nội dung bên trong values
3. KHÔNG dịch các từ/cụm từ đã là ngôn ngữ đích - GIỮ NGUYÊN chúng
4. KHÔNG dịch các mã kỹ thuật, placeholder, hoặc tên biến
5. KHÔNG dịch số, ngày tháng, ký hiệu đặc biệt
6. Giữ nguyên format JSON chuẩn

⚠️ QUY TẮC QUAN TRỌNG về dấu ngoặc kép:
- CHỈ sử dụng dấu ngoặc kép THẲNG chuẩn JSON: " (U+0022)
- TUYỆT ĐỐI KHÔNG dùng dấu ngoặc kép đặc biệt: " " „ ‟ « »
- Nếu cần trích dẫn trong nội dung dịch: dùng 「 」hoặc 'đơn'
- Ví dụ ĐÚNG: "App 「Order Printer Pro」 の使用"
- Ví dụ SAI: "App "Order Printer Pro" の使用" ❌

Output yêu cầu:
- Trả về ĐÚNG cấu trúc JSON gốc
- KHÔNG thêm giải thích hay văn bản nào khác
- Đảm bảo encoding UTF-8
- Kiểm tra kỹ KHÔNG có dấu ngoặc kép đặc biệt trong output</pre>
                        </div>
                    </div>
                    
                    <!-- Hướng dẫn collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step2Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>Hướng dẫn sử dụng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step2Guide">
                            <div class="p-2" style="background: #f8f9fa; border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li>Click "Trích xuất JSON" để xử lý</li>
                                    <li>Sau khi xong: hiển thị từng file JSON</li>
                                    <li>Click <strong>Copy</strong> để copy prompt + JSON → paste vào AI</li>
                                    <li>Click <strong>Tải ZIP</strong> để tải tất cả file</li>
                                    <li>Excel: Bỏ qua số và công thức</li>
                                    <li>PowerPoint: Trích xuất text từ shapes</li>
                                    <li>Word: Trích xuất text từ paragraphs, bảng, header/footer</li>
                                    <li>Mỗi file JSON chứa 400 cặp key-value</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bước 3: Inject -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">3</span>
                        <h3 class="d-inline">Nạp bản dịch</h3>
                        <p class="text-muted small mt-2">Inject JSON đã dịch vào file</p>
                    </div>
                    
                    <form id="injectForm" enctype="multipart/form-data">
                        <!-- Tab chọn giữa Upload file và Paste JSON -->
                        <ul class="nav nav-tabs nav-fill mb-2" id="injectTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#uploadTab" type="button" role="tab">
                                    <i class="fas fa-folder-open"></i> Upload File
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="paste-tab" data-bs-toggle="tab" data-bs-target="#pasteTab" type="button" role="tab">
                                    <i class="fas fa-paste"></i> Paste JSON
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="injectTabContent">
                            <!-- Tab Upload File -->
                            <div class="tab-pane fade" id="uploadTab" role="tabpanel">
                                <div class="upload-area compact" id="injectJsonUploadArea">
                                    <i class="fas fa-file-code"></i>
                                    <p class="mb-2 small"><strong>Kéo thả JSON/ZIP</strong></p>
                                    <input type="file" class="form-control" id="injectJsonFile" name="json_files" accept=".json,.zip" multiple style="display: none;">
                                    <label for="injectJsonFile" class="btn btn-custom btn-sm">
                                        <i class="fas fa-folder-open"></i> Chọn file
                                    </label>
                                </div>
                                
                                <div id="injectJsonFileInfo" class="file-info" style="display: none;">
                                    <div id="injectJsonFileList"></div>
                                    <button type="button" class="btn btn-sm btn-outline-danger float-end mt-2" id="injectJsonFileRemove">
                                        <i class="fas fa-times"></i> Xóa tất cả
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tab Paste JSON -->
                            <div class="tab-pane fade show active" id="pasteTab" role="tabpanel">
                                <div class="mb-2">
                                    <label class="form-label small mb-1"><strong>Paste nội dung JSON:</strong></label>
                                    <textarea class="form-control" id="pasteJsonTextarea" rows="5" placeholder='Paste nội dung JSON vào đây, ví dụ:
{
  "Sheet1!A1": "Translated text 1",
  "Sheet1!A2": "Translated text 2"
}' style="font-family: monospace; font-size: 0.85rem;"></textarea>
                                </div>
                                <div class="text-center mb-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="addPastedJsonBtn">
                                        <i class="fas fa-plus-circle"></i> Thêm JSON này
                                    </button>
                                </div>
                                
                                <!-- Danh sách JSON đã paste -->
                                <div id="pastedJsonList" style="display: none;">
                                    <div class="file-info">
                                        <label class="form-label small mb-1"><strong>Đã thêm:</strong></label>
                                        <div id="pastedJsonItems"></div>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="clearPastedJsonBtn">
                                            <i class="fas fa-trash"></i> Xóa tất cả
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-2">
                            <button type="submit" class="btn btn-custom btn-sm" id="injectBtn" disabled>
                                <i class="fas fa-download"></i> Nạp & Tải về
                            </button>
                        </div>
                        
                        <div class="loading text-center" id="injectLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang xử lý...</span>
                            </div>
                            <p class="mt-2 small">Đang nạp bản dịch...</p>
                        </div>
                        
                        <div id="injectAlert"></div>
                    </form>
                    
                    <!-- Hướng dẫn collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step3Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>Hướng dẫn sử dụng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step3Guide">
                            <div class="p-2" style="background: #f8f9fa; border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li><strong>2 cách nạp JSON:</strong></li>
                                    <li style="list-style: none; padding-left: 15px;">
                                        • <strong>Upload file:</strong> Chọn file JSON/ZIP (hỗ trợ nhiều file cùng lúc)
                                    </li>
                                    <li style="list-style: none; padding-left: 15px;">
                                        • <strong>Paste JSON:</strong> Paste trực tiếp nội dung JSON (có thể paste nhiều lần)
                                    </li>
                                    <li>Tự động gộp và nạp vào file gốc (Excel, PowerPoint <b>hoặc Word</b>)</li>
                                    <li>Giữ nguyên định dạng, màu sắc, bảng, header/footer cho Word</li>
                                    <li>Tải về file output_translated</li>
                                    <li>File tạm tự động xóa sau khi tải</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="text-center mt-5" style="color: #fff; opacity: 0.85;">
        <hr style="border-color: #fff; opacity: 0.2;">
        <div class="pb-2">
            <small>
                &copy; 2026 Tomo Translation &middot; Built by <a href="mailto:eikitomobe@gmail.com" style="color: #fff; text-decoration: underline;">友部 瑛稀</a>
            </small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==================== BIẾN TOÀN CỤC ====================
        let uploadedExcelFilename = null; // Lưu tên file Excel đã upload
        
        // ==================== UPLOAD EXCEL CHUNG ====================
        const mainExcelFile = document.getElementById('mainExcelFile');
        const mainFileInfo = document.getElementById('mainFileInfo');
        const mainFileName = document.getElementById('mainFileName');
        const mainFileRemove = document.getElementById('mainFileRemove');
        const mainAlert = document.getElementById('mainAlert');
        const mainUploadArea = document.getElementById('mainUploadArea');
        const extractBtn = document.getElementById('extractBtn');
        const injectBtn = document.getElementById('injectBtn');
        
        // Xử lý khi chọn file Excel chung
        mainExcelFile.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                mainFileName.textContent = file.name;
                mainFileInfo.style.display = 'block';
                uploadedExcelFilename = file.name;
                
                // Thay đổi icon phù hợp với loại file
                const fileIcon = document.getElementById('mainFileIcon');
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.xlsx')) {
                    fileIcon.className = 'fas fa-file-excel text-success';
                } else if (fileName.endsWith('.pptx')) {
                    fileIcon.className = 'fas fa-file-powerpoint text-danger';
                } else if (fileName.endsWith('.docx')) {
                    fileIcon.className = 'fas fa-file-word text-primary';
                } else {
                    fileIcon.className = 'fas fa-file text-secondary';
                }
                
                // Kích hoạt cả 2 nút Extract và Inject
                extractBtn.disabled = false;
                injectBtn.disabled = false;
                
                // Hiển thị thông báo
                showAlert(mainAlert, 'success', `File "${file.name}" đã được chọn. Bạn có thể tiến hành Extract hoặc Inject.`);
            }
        });
        
        // Xử lý xóa file
        mainFileRemove.addEventListener('click', function() {
            mainExcelFile.value = '';
            mainFileInfo.style.display = 'none';
            uploadedExcelFilename = null;
            extractBtn.disabled = true;
            injectBtn.disabled = true;
            mainAlert.innerHTML = '';
        });
        
        // Xử lý drag and drop
        mainUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#764ba2';
            mainUploadArea.style.background = '#e9ecef';
        });
        
        mainUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#667eea';
            mainUploadArea.style.background = '#f8f9fa';
        });
        
        mainUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#667eea';
            mainUploadArea.style.background = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                mainExcelFile.files = files;
                mainFileName.textContent = files[0].name;
                mainFileInfo.style.display = 'block';
                uploadedExcelFilename = files[0].name;
                extractBtn.disabled = false;
                injectBtn.disabled = false;
                showAlert(mainAlert, 'success', `File "${files[0].name}" đã được chọn.`);
            }
        });
        
        // ==================== CHỨC NĂNG EXTRACT ====================
        
        const extractForm = document.getElementById('extractForm');
        const extractAlert = document.getElementById('extractAlert');
        const extractLoading = document.getElementById('extractLoading');
        const extractResult = document.getElementById('extractResult');
        const extractSummary = document.getElementById('extractSummary');
        const jsonFileList = document.getElementById('jsonFileList');
        
        // Xử lý submit form Extract
        extractForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Kiểm tra xem có file được upload chưa
            if (!uploadedExcelFilename || mainExcelFile.files.length === 0) {
                showAlert(extractAlert, 'warning', 'Vui lòng upload file (Excel hoặc PowerPoint) ở Bước 1 trước!');
                return;
            }
            
            // Ẩn kết quả cũ
            extractResult.style.display = 'none';
            jsonFileList.innerHTML = '';
            
            // Hiển thị loading
            extractLoading.style.display = 'block';
            extractAlert.innerHTML = '';
            
            // Tạo FormData với file Excel từ upload chung
            const formData = new FormData();
            formData.append('file', mainExcelFile.files[0]);
            
            try {
                // Gửi request
                const response = await fetch('/extract', {
                    method: 'POST',
                    body: formData
                });
                
                // Ẩn loading
                extractLoading.style.display = 'none';
                
                // Kiểm tra content-type
                const contentType = response.headers.get('content-type');
                
                if (response.ok && contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    
                    if (data.success) {
                        // Hiển thị tóm tắt
                        extractSummary.textContent = `${data.total_files} file · ${data.total_items} keys`;
                        
                        // Render từng hàng file JSON
                        renderJsonFileRows(data.files);
                        
                        // Hiện khu vực kết quả
                        extractResult.style.display = 'block';
                        
                        showAlert(extractAlert, 'success', `Trích xuất thành công! ${data.total_files} file JSON, ${data.total_items} cặp key-value. Click <strong>Copy</strong> để copy prompt + JSON vào AI, hoặc <strong>Tải ZIP</strong> để tải tất cả.`);
                    } else {
                        showAlert(extractAlert, 'danger', data.error || 'Có lỗi xảy ra!');
                    }
                } else if (!response.ok) {
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        showAlert(extractAlert, 'danger', error.error || 'Có lỗi xảy ra!');
                    } else {
                        const text = await response.text();
                        if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                            showAlert(extractAlert, 'danger', 'Phiên đăng nhập đã hết hạn. Vui lòng <a href="/login">đăng nhập lại</a>.');
                        } else {
                            showAlert(extractAlert, 'danger', 'Lỗi: ' + (text || 'Không xác định'));
                        }
                    }
                }
            } catch (error) {
                extractLoading.style.display = 'none';
                showAlert(extractAlert, 'danger', 'Lỗi kết nối: ' + error.message);
            }
        });
        
        // Render danh sách file JSON thành từng hàng
        function renderJsonFileRows(files) {
            jsonFileList.innerHTML = '';
            const promptText = document.getElementById('aiPrompt').textContent;
            
            files.forEach(function(file, idx) {
                const row = document.createElement('div');
                row.className = 'json-file-row';
                row.innerHTML = `
                    <span class="file-name" title="${file.name}">
                        <i class="fas fa-file-code text-primary"></i>
                        ${file.name}
                    </span>
                    <button type="button"
                        class="btn btn-outline-primary btn-sm btn-copy-json"
                        data-idx="${idx}"
                        title="Copy prompt AI + nội dung JSON này">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                `;
                
                // Lưu nội dung vào data attribute (dùng dataset)
                row.querySelector('.btn-copy-json').addEventListener('click', function() {
                    const btnEl = this;
                    const textToCopy = promptText + '\n\n' + file.content;
                    
                    navigator.clipboard.writeText(textToCopy).then(function() {
                        btnEl.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        btnEl.classList.add('copied');
                        setTimeout(function() {
                            btnEl.innerHTML = '<i class="fas fa-copy"></i> Copy';
                            btnEl.classList.remove('copied');
                        }, 2000);
                    }).catch(function() {
                        // Fallback cho browser không hỗ trợ clipboard API
                        const textarea = document.createElement('textarea');
                        textarea.value = textToCopy;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        try {
                            document.execCommand('copy');
                            btnEl.innerHTML = '<i class="fas fa-check"></i> Copied!';
                            btnEl.classList.add('copied');
                            setTimeout(function() {
                                btnEl.innerHTML = '<i class="fas fa-copy"></i> Copy';
                                btnEl.classList.remove('copied');
                            }, 2000);
                        } catch(err) {
                            alert('Không thể copy tự động. Vui lòng copy thủ công.');
                        }
                        document.body.removeChild(textarea);
                    });
                });
                
                jsonFileList.appendChild(row);
            });
        }
        
        // ==================== CHỨC NĂNG INJECT ====================
        
        const injectForm = document.getElementById('injectForm');
        const injectJsonFile = document.getElementById('injectJsonFile');
        const injectJsonFileInfo = document.getElementById('injectJsonFileInfo');
        const injectJsonFileName = document.getElementById('injectJsonFileName');
        const injectJsonFileRemove = document.getElementById('injectJsonFileRemove');
        const injectAlert = document.getElementById('injectAlert');
        const injectLoading = document.getElementById('injectLoading');
        
        // Paste JSON functionality
        const pasteJsonTextarea = document.getElementById('pasteJsonTextarea');
        const addPastedJsonBtn = document.getElementById('addPastedJsonBtn');
        const pastedJsonList = document.getElementById('pastedJsonList');
        const pastedJsonItems = document.getElementById('pastedJsonItems');
        const clearPastedJsonBtn = document.getElementById('clearPastedJsonBtn');
        
        // Lưu danh sách JSON đã paste
        let pastedJsonData = [];
        
        // Xử lý khi click "Thêm JSON này"
        addPastedJsonBtn.addEventListener('click', function() {
            const jsonText = pasteJsonTextarea.value.trim();
            
            if (!jsonText) {
                showAlert(injectAlert, 'warning', 'Vui lòng paste nội dung JSON vào ô bên trên!');
                return;
            }
            
            // Validate JSON
            try {
                const parsedJson = JSON.parse(jsonText);
                
                // Kiểm tra xem có phải object không
                if (typeof parsedJson !== 'object' || parsedJson === null) {
                    showAlert(injectAlert, 'warning', 'JSON phải là một object (không phải array hoặc giá trị đơn)!');
                    return;
                }
                
                // Thêm vào danh sách
                pastedJsonData.push(parsedJson);
                
                // Hiển thị trong danh sách
                updatePastedJsonList();
                
                // Xóa textarea
                pasteJsonTextarea.value = '';
                
                // Hiển thị thông báo
                showAlert(injectAlert, 'success', `Đã thêm JSON #${pastedJsonData.length} với ${Object.keys(parsedJson).length} cặp key-value.`);
                
            } catch (e) {
                showAlert(injectAlert, 'danger', 'JSON không hợp lệ: ' + e.message);
            }
        });
        
        // Cập nhật hiển thị danh sách JSON đã paste
        function updatePastedJsonList() {
            if (pastedJsonData.length === 0) {
                pastedJsonList.style.display = 'none';
                return;
            }
            
            pastedJsonList.style.display = 'block';
            pastedJsonItems.innerHTML = '';
            
            pastedJsonData.forEach((jsonObj, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'mb-1 d-flex justify-content-between align-items-center';
                itemDiv.innerHTML = `
                    <div>
                        <i class="fas fa-clipboard text-success"></i> 
                        <small><strong>JSON #${index + 1}</strong> - ${Object.keys(jsonObj).length} keys</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePastedJson(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                pastedJsonItems.appendChild(itemDiv);
            });
        }
        
        // Xóa một JSON đã paste
        window.removePastedJson = function(index) {
            pastedJsonData.splice(index, 1);
            updatePastedJsonList();
            showAlert(injectAlert, 'info', 'Đã xóa JSON.');
        };
        
        // Xóa tất cả JSON đã paste
        clearPastedJsonBtn.addEventListener('click', function() {
            if (confirm('Xóa tất cả JSON đã paste?')) {
                pastedJsonData = [];
                updatePastedJsonList();
                showAlert(injectAlert, 'info', 'Đã xóa tất cả JSON đã paste.');
            }
        });
        
        // Xử lý khi chọn file JSON (nhiều file)
        injectJsonFile.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const fileList = document.getElementById('injectJsonFileList');
                fileList.innerHTML = '';
                
                // Hiển thị danh sách các file
                Array.from(e.target.files).forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'mb-1';
                    const icon = file.name.endsWith('.zip') ? 'fa-file-archive' : 'fa-file-code';
                    const color = file.name.endsWith('.zip') ? 'text-warning' : 'text-primary';
                    fileItem.innerHTML = `<i class="fas ${icon} ${color}"></i> <small>${file.name}</small>`;
                    fileList.appendChild(fileItem);
                });
                
                injectJsonFileInfo.style.display = 'block';
            }
        });
        
        // Xử lý xóa file JSON
        injectJsonFileRemove.addEventListener('click', function() {
            injectJsonFile.value = '';
            injectJsonFileInfo.style.display = 'none';
        });
        
        // Xử lý drag and drop cho JSON files
        const injectJsonUploadArea = document.getElementById('injectJsonUploadArea');
        
        injectJsonUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#764ba2';
            injectJsonUploadArea.style.background = '#e9ecef';
        });
        
        injectJsonUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#667eea';
            injectJsonUploadArea.style.background = '#f8f9fa';
        });
        
        injectJsonUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#667eea';
            injectJsonUploadArea.style.background = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Sử dụng DataTransfer để gán files vào input
                const dataTransfer = new DataTransfer();
                Array.from(files).forEach(file => {
                    // Chỉ chấp nhận file .json hoặc .zip
                    if (file.name.endsWith('.json') || file.name.endsWith('.zip')) {
                        dataTransfer.items.add(file);
                    }
                });
                
                if (dataTransfer.files.length > 0) {
                    injectJsonFile.files = dataTransfer.files;
                    
                    // Hiển thị danh sách files
                    const fileList = document.getElementById('injectJsonFileList');
                    fileList.innerHTML = '';
                    
                    Array.from(dataTransfer.files).forEach((file, index) => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'mb-1';
                        const icon = file.name.endsWith('.zip') ? 'fa-file-archive' : 'fa-file-code';
                        const color = file.name.endsWith('.zip') ? 'text-warning' : 'text-primary';
                        fileItem.innerHTML = `<i class="fas ${icon} ${color}"></i> <small>${file.name}</small>`;
                        fileList.appendChild(fileItem);
                    });
                    
                    injectJsonFileInfo.style.display = 'block';
                } else {
                    showAlert(injectAlert, 'warning', 'Chỉ chấp nhận file .json hoặc .zip!');
                }
            }
        });
        
        // Xử lý submit form Inject
        injectForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Kiểm tra xem có file được upload chưa
            if (!uploadedExcelFilename || mainExcelFile.files.length === 0) {
                showAlert(injectAlert, 'warning', 'Vui lòng upload file (Excel hoặc PowerPoint) ở Bước 1 trước!');
                return;
            }
            
            // Kiểm tra xem có file JSON HOẶC pasted JSON không
            if (injectJsonFile.files.length === 0 && pastedJsonData.length === 0) {
                showAlert(injectAlert, 'warning', 'Vui lòng chọn file JSON đã dịch hoặc paste JSON!');
                return;
            }
            
            // Hiển thị loading
            injectLoading.style.display = 'block';
            injectAlert.innerHTML = '';
            
            // Tạo FormData với file Excel từ upload chung và tất cả file JSON
            const formData = new FormData();
            formData.append('excel_file', mainExcelFile.files[0]);
            
            // Thêm tất cả các file JSON/ZIP
            Array.from(injectJsonFile.files).forEach(file => {
                formData.append('json_files', file);
            });
            
            // Thêm tất cả JSON đã paste (gửi dưới dạng JSON string)
            if (pastedJsonData.length > 0) {
                formData.append('pasted_json_data', JSON.stringify(pastedJsonData));
            }
            
            try {
                // Gửi request
                const response = await fetch('/inject', {
                    method: 'POST',
                    body: formData
                });
                
                // Ẩn loading
                injectLoading.style.display = 'none';
                
                if (response.ok) {
                    // Lấy tên file từ header Content-Disposition
                    const disposition = response.headers.get('Content-Disposition');
                    let filename = `output_translated_${Date.now()}.xlsx`;
                    const parsedFilename = parseDownloadFilename(disposition);
                    if (parsedFilename) {
                        filename = parsedFilename;
                    }
                    
                    // Tải file với tên đúng extension
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert(injectAlert, 'success', 'Nạp bản dịch thành công! File đang được tải về. Tất cả file tạm đã được xóa.');
                    
                    // Reset form JSON
                    injectJsonFile.value = '';
                    injectJsonFileInfo.style.display = 'none';
                    
                    // Reset pasted JSON
                    pastedJsonData = [];
                    updatePastedJsonList();
                    pasteJsonTextarea.value = '';
                    
                    // Tự động xóa tất cả file trong thư mục uploads sau khi thành công
                    await clearUploads(true);
                } else {
                    // Kiểm tra xem response có phải JSON không
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        showAlert(injectAlert, 'danger', error.error || 'Có lỗi xảy ra!');
                    } else {
                        // Nếu không phải JSON (có thể là HTML từ trang login hoặc lỗi server)
                        const text = await response.text();
                        if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                            showAlert(injectAlert, 'danger', 'Phiên đăng nhập đã hết hạn. Vui lòng <a href="/login">đăng nhập lại</a>.');
                        } else {
                            showAlert(injectAlert, 'danger', 'Lỗi: ' + (text || 'Không xác định'));
                        }
                    }
                }
            } catch (error) {
                injectLoading.style.display = 'none';
                showAlert(injectAlert, 'danger', 'Lỗi kết nối: ' + error.message);
            }
        });
        
        // ==================== HÀM TRỢ GIÚP ====================

        function parseDownloadFilename(contentDisposition) {
            if (!contentDisposition) return null;

            // Ưu tiên RFC 5987: filename*=UTF-8''...
            const filenameStarMatch = contentDisposition.match(/filename\*\s*=\s*UTF-8''([^;\n]+)/i);
            if (filenameStarMatch && filenameStarMatch[1]) {
                try {
                    return decodeURIComponent(filenameStarMatch[1].trim());
                } catch (e) {
                    // fallback xuống filename thường
                }
            }

            // Fallback: filename="..." hoặc filename=...
            const filenameMatch = contentDisposition.match(/filename\s*=\s*(("([^"]+)")|([^;\n]+))/i);
            if (filenameMatch) {
                return (filenameMatch[3] || filenameMatch[4] || '').trim();
            }

            return null;
        }
        
        // Hàm xóa tất cả file trong uploads
        async function clearUploads(skipConfirm = false) {
            // Xác nhận trước khi xóa (trừ khi skipConfirm = true)
            if (!skipConfirm && !confirm('Bạn có chắc chắn muốn xóa TẤT CẢ file trong thư mục uploads?\n\nThao tác này không thể hoàn tác!')) {
                return;
            }
            
            try {
                const response = await fetch('/clear-uploads', {
                    method: 'POST'
                });
                
                // Kiểm tra xem response có phải JSON không
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                        if (!skipConfirm) {
                            alert('❌ Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                            window.location.href = '/login';
                        }
                        return;
                    }
                    result = { error: text };
                }
                
                if (response.ok && result.success) {
                    if (!skipConfirm) {
                        alert(`✅ ${result.message}`);
                    }
                    
                    // Reset form và trạng thái
                    mainExcelFile.value = '';
                    mainFileInfo.style.display = 'none';
                    uploadedExcelFilename = null;
                    extractBtn.disabled = true;
                    injectBtn.disabled = true;
                    mainAlert.innerHTML = '';
                    injectJsonFile.value = '';
                    injectJsonFileInfo.style.display = 'none';
                } else {
                    if (!skipConfirm) {
                        alert('❌ Lỗi: ' + (result.error || result.message));
                    }
                }
            } catch (error) {
                if (!skipConfirm) {
                    alert('❌ Lỗi kết nối: ' + error.message);
                }
            }
        }
        
        // Hàm copy prompt AI
        // copyPrompt() đã được thay thế bởi renderJsonFileRows() inline copy
        
        function showAlert(element, type, message) {
            element.innerHTML = `
                <div class="alert alert-${type} alert-custom alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
    </script>
</body>
</html>
