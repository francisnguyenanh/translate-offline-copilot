<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel & PowerPoint Translation Manager</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome cho icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .function-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: 100%;
            transition: transform 0.3s;
        }
        
        .function-card:hover {
            transform: translateY(-5px);
        }
        
        .function-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .function-card .icon {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin: 15px 0;
            transition: all 0.3s;
        }
        
        .upload-area.compact {
            padding: 15px;
            margin: 10px 0;
        }
        
        .upload-area:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }
        
        .upload-area i {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .collapse-toggle {
            cursor: pointer;
            user-select: none;
        }
        
        .collapse-toggle:hover {
            opacity: 0.8;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-custom:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .alert-custom {
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .file-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .loading {
            display: none;
            margin-top: 15px;
        }
        
        .loading .spinner-border {
            width: 2rem;
            height: 2rem;
        }
        
        .json-file-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: #f0f7ff;
            border: 1px solid #cce0ff;
            border-radius: 6px;
            margin-bottom: 6px;
            gap: 8px;
        }
        
        .json-file-row .file-name {
            font-size: 0.78rem;
            color: #333;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .json-file-row .btn-copy-json {
            flex-shrink: 0;
            font-size: 0.75rem;
            padding: 3px 10px;
        }
        
        .btn-copy-json.copied {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: white !important;
        }

        /* ===== DARK MODE ===== */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        body.dark-mode .function-card {
            background: #1e2a3a;
            color: #e0e0e0;
        }
        body.dark-mode .function-card h3 { color: #90b4f7; }
        body.dark-mode .upload-area {
            background: #253244;
            border-color: #4a6fa5;
        }
        body.dark-mode .upload-area:hover { background: #2c3e54; }
        body.dark-mode .file-info { background: #253244; color: #ccc; }
        body.dark-mode .json-file-row {
            background: #1e3049;
            border-color: #2d5080;
            color: #ccc;
        }
        body.dark-mode .collapse-toggle {
            background: #253244 !important;
            color: #ccc;
        }
        body.dark-mode .collapse-toggle .text-info { color: #7ec8e3 !important; }
        body.dark-mode .collapse > div {
            background: #253244 !important;
            color: #ccc;
        }
        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background: #253244;
            color: #e0e0e0;
            border-color: #4a6fa5;
        }
        body.dark-mode .nav-tabs .nav-link { color: #90b4f7; }
        body.dark-mode .nav-tabs .nav-link.active {
            background: #1e3049;
            color: #fff;
            border-color: #4a6fa5;
        }
        body.dark-mode .text-muted { color: #8a9bb0 !important; }
        body.dark-mode footer { color: #8a9bb0 !important; }
        body.dark-mode .alert-info { background: #1b3a52; color: #7ec8e3; border-color: #2d6a8a; }
        body.dark-mode #promptDetail > div {
            background: #1b2d3e !important;
            border-color: #2d5a7a !important;
        }
        body.dark-mode #aiPrompt { color: #b0c8e0; }
        body.dark-mode .validation-item { background: #253244; border-color: #3a5070; }
        body.dark-mode .tm-badge { background: #1e3049; color: #7ec8e3; }
        .dedup-banner {
            background: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        body.dark-mode .dedup-banner {
            background: #193d2a;
            border-color: #1f6640;
            color: #6dd99e;
        }
        body.dark-mode .dedup-banner .text-muted { color: #4d9e6a !important; }

        /* === Dark mode: Improvement for Step 2/3 === */
        body.dark-mode .file-name { color: #e0e0e0; font-weight: 500; }
        body.dark-mode .json-file-row { color: #e0e0e0; }
        body.dark-mode .form-control::placeholder { color: #8a9bb0; }
        
        /* === Dark mode: Modal === */
        body.dark-mode .modal-content {
            background: #1e3049;
            color: #e0e0e0;
            border-color: #2d5080;
        }
        body.dark-mode .modal-header {
            background: #17253a;
            border-bottom-color: #2d5080;
        }
        body.dark-mode .modal-footer {
            background: #17253a;
            border-top-color: #2d5080;
        }
        body.dark-mode .modal-title { color: #e0e0e0; }
        body.dark-mode .btn-close { filter: invert(1) brightness(1.5); }

        /* === Dark mode: Dropdown === */
        body.dark-mode .dropdown-menu {
            background: #1e3049;
            border-color: #2d5080;
        }
        body.dark-mode .dropdown-item { color: #d0dff0; }
        body.dark-mode .dropdown-item:hover,
        body.dark-mode .dropdown-item:focus {
            background: #253c5a;
            color: #fff;
        }
        body.dark-mode .dropdown-header { color: #8ab4d8; }
        body.dark-mode .dropdown-divider { border-color: #2d5080; }

        /* === Dark mode: List group (template list in modal) === */
        body.dark-mode .list-group-item {
            background: #1e3049;
            color: #d0dff0;
            border-color: #2d5080;
        }
        body.dark-mode .list-group-item:hover {
            background: #253c5a;
            color: #fff;
        }
        body.dark-mode .list-group-item.active {
            background: #0d5c9e;
            border-color: #1a7ac4;
            color: #fff;
        }
        body.dark-mode .list-group-item-action { color: #d0dff0; }

        /* === Dark mode: Alerts === */
        body.dark-mode .alert-success {
            background: #193d2a;
            color: #6dd99e;
            border-color: #1f6640;
        }
        body.dark-mode .alert-danger {
            background: #3d1919;
            color: #f08080;
            border-color: #7a2020;
        }
        body.dark-mode .alert-warning {
            background: #3d3019;
            color: #f0c060;
            border-color: #7a6020;
        }
        body.dark-mode .alert-secondary {
            background: #253244;
            color: #b0c4d8;
            border-color: #3a5070;
        }

        /* === Dark mode: Typography & Labels === */
        body.dark-mode label,
        body.dark-mode .form-label { color: #ffffff; }
        body.dark-mode code {
            background: #172840;
            color: #79d4f3;
            border: 1px solid #2d5080;
        }
        body.dark-mode small { color: #a0b0c0; }
        body.dark-mode strong { color: #ffffff; }
        body.dark-mode p { color: #e0e0e0; }
        body.dark-mode hr { border-color: #2d5080; opacity: 0.5; }

        /* === Dark mode: Cards & function cards === */
        body.dark-mode .card {
            background: #1b2d3e;
            border-color: #2d5080;
            color: #d0e0f0;
        }
        body.dark-mode .card-header {
            background: #17253a;
            border-bottom-color: #2d5080;
            color: #e0e0e0;
        }
        body.dark-mode .card-body { color: #d0e0f0; }

        /* === Dark mode: Table === */
        body.dark-mode .table {
            color: #d0e0f0;
            border-color: #2d5080;
        }
        body.dark-mode .table th,
        body.dark-mode .table td { border-color: #2d5080; }
        body.dark-mode .table-striped tbody tr:nth-of-type(odd) { background: #1b2d40; }

        /* === Dark mode: Textarea === */
        body.dark-mode textarea.form-control {
            background: #172840;
            color: #ffffff;
            border-color: #3a6090;
        }
        body.dark-mode textarea.form-control:focus {
            background: #1b3050;
            border-color: #5090c8;
            box-shadow: 0 0 0 0.2rem rgba(80,144,200,0.25);
        }

        /* === Dark mode: Tab border at bottom === */
        body.dark-mode .nav-tabs { border-bottom-color: #2d5080; }
        body.dark-mode .nav-tabs .nav-link:not(.active):hover {
            background: #1b2d3e;
            border-color: #2d5080 #2d5080 transparent;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-language"></i> Tomo Translation</h1>
            <p>C√¥ng c·ª• qu·∫£n l√Ω tr√≠ch xu·∫•t v√† n·∫°p b·∫£n d·ªãch cho file Excel (.xlsx), PowerPoint (.pptx) v√† Word (.docx)</p>
            <div class="mt-3 d-flex flex-wrap justify-content-center gap-2">
                <button class="btn btn-outline-light btn-sm" onclick="clearUploads()" title="X√≥a file trong phi√™n c·ªßa b·∫°n">
                    <i class="fas fa-trash-alt"></i> X√≥a file c·ªßa t√¥i
                </button>
                <a href="/logout" class="btn btn-outline-light btn-sm" title="ƒêƒÉng xu·∫•t">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </a>
                <button class="btn btn-outline-light btn-sm" id="darkModeToggle" onclick="toggleDarkMode()" title="Chuy·ªÉn ch·∫ø ƒë·ªô t·ªëi/s√°ng">
                    <i class="fas fa-moon" id="darkModeIcon"></i> <span id="darkModeLabel">Dark Mode</span>
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-database"></i> Translation Memory
                    </button>
                    <ul class="dropdown-menu">
                        <li><h6 class="dropdown-header" id="tmLangHeader">TM: ...</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="exportTM()"><i class="fas fa-download text-success"></i> Xu·∫•t TM (JSON)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="document.getElementById('tmImportFile').click()"><i class="fas fa-upload text-primary"></i> Nh·∫≠p TM (JSON)</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="clearTM()"><i class="fas fa-trash"></i> X√≥a TM</a></li>
                    </ul>
                </div>
                <input type="file" id="tmImportFile" accept=".json" style="display:none" onchange="importTM(this)">
            </div>
        </div>
        
        <!-- 3 B∆∞·ªõc theo h√†ng ngang -->
        <div class="row g-3">
            <!-- B∆∞·ªõc 1: Upload file -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">1</span>
                        <h3 class="d-inline">Upload File</h3>
                        <p class="text-muted small mt-2">File g·ªëc (.xlsx/.pptx/.docx)</p>
                    </div>
                    
                    <form id="uploadExcelForm" enctype="multipart/form-data">
                        <div class="upload-area compact" id="mainUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p class="mb-2 small"><strong>K√©o th·∫£ file v√†o ƒë√¢y</strong></p>
                            <input type="file" class="form-control" id="mainExcelFile" name="file" accept=".xlsx,.pptx" style="display: none;">
                            <label for="mainExcelFile" class="btn btn-custom btn-sm">
                                <i class="fas fa-folder-open"></i> Ch·ªçn file
                            </label>
                        </div>
                        
                        <div id="mainFileInfo" class="file-info" style="display: none;">
                            <i id="mainFileIcon" class="fas fa-file text-secondary"></i>
                            <span id="mainFileName" class="small"></span>
                            <button type="button" class="btn btn-sm btn-outline-danger float-end" id="mainFileRemove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div id="mainAlert"></div>
                    </form>

                    <!-- Ch·ªçn ng√¥n ng·ªØ ƒë√≠ch -->
                    <div class="mt-3">
                        <label for="targetLangSelect" class="form-label small mb-1">
                            <i class="fas fa-globe"></i> <strong>Ng√¥n ng·ªØ ƒë√≠ch:</strong>
                        </label>
                        <select class="form-select form-select-sm" id="targetLangSelect">
                            <option value="" disabled>ƒêang t·∫£i danh s√°ch...</option>
                        </select>
                        <div class="text-muted" style="font-size: 0.72rem; margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> Danh s√°ch ng√¥n ng·ªØ ch·ªânh s·ª≠a trong <code>languages.json</code>
                        </div>
                    </div>

                    <!-- Glossary Management -->
                    <div class="mt-3">
                        <div class="d-flex align-items-center justify-content-between mb-1">
                            <small><i class="fas fa-book text-warning"></i> <strong>Glossary:</strong></small>
                            <div class="d-flex gap-1">
                                <button class="btn btn-outline-warning btn-sm py-0 px-2" style="font-size:0.72rem" onclick="document.getElementById('glossaryUploadFile').click()" title="Upload CSV (source,translation)">
                                    <i class="fas fa-upload"></i> Upload CSV
                                </button>
                                <button class="btn btn-outline-secondary btn-sm py-0 px-2" style="font-size:0.72rem" id="exportGlossaryBtn" onclick="exportGlossary()" title="T·∫£i glossary v·ªÅ">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button class="btn btn-outline-danger btn-sm py-0 px-2" style="font-size:0.72rem" id="clearGlossaryBtn" onclick="clearGlossary()" title="X√≥a glossary">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div id="glossaryInfo" class="text-muted" style="font-size:0.72rem;">
                            <i class="fas fa-circle-notch fa-spin"></i> ƒêang t·∫£i...
                        </div>
                        <input type="file" id="glossaryUploadFile" accept=".csv" style="display:none" onchange="uploadGlossary(this)">
                    </div>
                    
                    <!-- H∆∞·ªõng d·∫´n collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step1Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step1Guide">
                            <div class="p-2" style="background: #f8f9fa; border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li>H·ªó tr·ª£ Excel (.xlsx), PowerPoint (.pptx) <b>v√† Word (.docx)</b></li>
                                    <li>K√©o th·∫£ ho·∫∑c click ƒë·ªÉ ch·ªçn file</li>
                                    <li>File s·∫Ω d√πng cho c·∫£ Extract v√† Inject</li>
                                    <li>Gi·ªõi h·∫°n: 16MB</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- B∆∞·ªõc 2: Extract -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">2</span>
                        <h3 class="d-inline">Tr√≠ch xu·∫•t</h3>
                        <p class="text-muted small mt-2">Extract n·ªôi dung c·∫ßn d·ªãch</p>
                    </div>
                    
                    <form id="extractForm" enctype="multipart/form-data">
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-custom btn-sm" id="extractBtn" disabled>
                                <i class="fas fa-cog"></i> Tr√≠ch xu·∫•t JSON
                            </button>
                        </div>
                        
                        <div class="loading text-center" id="extractLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">ƒêang x·ª≠ l√Ω...</span>
                            </div>
                            <p class="mt-2 small">ƒêang tr√≠ch xu·∫•t d·ªØ li·ªáu...</p>
                        </div>
                        
                        <div id="extractAlert"></div>
                    </form>
                    
                    <!-- K·∫øt qu·∫£ sau khi tr√≠ch xu·∫•t -->
                    <div id="extractResult" style="display: none;">
                        <hr class="my-2">                        

                        <!-- Dedup Panel -->
                        <div id="dedupPanel" style="display:none;"></div>

                        <!-- Danh s√°ch file JSON -->
                        <div id="jsonFileList"></div>

                        <!-- Btn download ZIP -->
                        <div class="text-center mb-2">
                            <a id="downloadZipBtn" href="/download-zip" class="btn btn-success btn-sm">
                                <i class="fas fa-file-archive"></i> T·∫£i ZIP
                            </a>
                            <span id="extractSummary" class="text-muted small ms-2"></span>
                        </div>
                                                
                        <!-- Duplicate warning -->
                        

                    </div>
                    
                    <!-- Prompt AI -->
                    <div class="mt-3">
                        <!-- Template Selector -->
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <small><i class="fas fa-magic text-primary"></i> <strong>Template:</strong></small>
                            <select class="form-select form-select-sm" id="templateSelect" style="font-size:0.78rem;"></select>
                            <button class="btn btn-outline-primary btn-sm py-0 px-2" style="font-size:0.72rem;flex-shrink:0" onclick="openTemplateModal()">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#promptDetail">
                                <i class="fas fa-eye"></i> Xem Prompt AI
                            </button>
                        </div>
                    </div>
                    
                    <!-- N·ªôi dung prompt collapse -->
                    <div class="collapse mt-2" id="promptDetail">
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; border: 1px solid #90caf9;">
                            <pre id="aiPrompt" style="margin: 0; font-size: 0.7rem; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto;">H√£y d·ªãch c√°c gi√° tr·ªã (values) trong file JSON n√†y sang {TARGET_LANG}.

Quy t·∫Øc b·∫Øt bu·ªôc:
1. Gi·ªØ nguy√™n 100% c√°c keys (t·ªça ƒë·ªô cell nh∆∞ "Sheet1!A1")
2. CH·ªà d·ªãch n·ªôi dung b√™n trong values
3. KH√îNG d·ªãch c√°c t·ª´/c·ª•m t·ª´ ƒë√£ l√† ng√¥n ng·ªØ ƒë√≠ch - GI·ªÆ NGUY√äN ch√∫ng
4. KH√îNG d·ªãch c√°c m√£ k·ªπ thu·∫≠t, placeholder, ho·∫∑c t√™n bi·∫øn
5. KH√îNG d·ªãch s·ªë, ng√†y th√°ng, k√Ω hi·ªáu ƒë·∫∑c bi·ªát
6. Gi·ªØ nguy√™n format JSON chu·∫©n

‚ö†Ô∏è QUY T·∫ÆC QUAN TR·ªåNG v·ªÅ d·∫•u ngo·∫∑c k√©p:
- CH·ªà s·ª≠ d·ª•ng d·∫•u ngo·∫∑c k√©p TH·∫≤NG chu·∫©n JSON: " (U+0022)
- TUY·ªÜT ƒê·ªêI KH√îNG d√πng d·∫•u ngo·∫∑c k√©p ƒë·∫∑c bi·ªát: " " ‚Äû ‚Äü ¬´ ¬ª
- N·∫øu c·∫ßn tr√≠ch d·∫´n trong n·ªôi dung d·ªãch: d√πng „Äå „Äçho·∫∑c 'ƒë∆°n'
- V√≠ d·ª• ƒê√öNG: "App „ÄåOrder Printer Pro„Äç „ÅÆ‰ΩøÁî®"
- V√≠ d·ª• SAI: "App "Order Printer Pro" „ÅÆ‰ΩøÁî®" ‚ùå

Output y√™u c·∫ßu:
- Tr·∫£ v·ªÅ ƒê√öNG c·∫•u tr√∫c JSON g·ªëc
- KH√îNG th√™m gi·∫£i th√≠ch hay vƒÉn b·∫£n n√†o kh√°c
- ƒê·∫£m b·∫£o encoding UTF-8
- Ki·ªÉm tra k·ªπ KH√îNG c√≥ d·∫•u ngo·∫∑c k√©p ƒë·∫∑c bi·ªát trong output</pre>
                        </div>
                    </div>
                    
                    <!-- H∆∞·ªõng d·∫´n collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step2Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step2Guide">
                            <div class="p-2" style="background: #f8f9fa; border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li>Click "Tr√≠ch xu·∫•t JSON" ƒë·ªÉ x·ª≠ l√Ω</li>
                                    <li>Sau khi xong: hi·ªÉn th·ªã t·ª´ng file JSON</li>
                                    <li>Click <strong>Copy</strong> ƒë·ªÉ copy prompt + JSON ‚Üí paste v√†o AI</li>
                                    <li>Click <strong>T·∫£i ZIP</strong> ƒë·ªÉ t·∫£i t·∫•t c·∫£ file</li>
                                    <li>Excel: B·ªè qua s·ªë v√† c√¥ng th·ª©c</li>
                                    <li>PowerPoint: Tr√≠ch xu·∫•t text t·ª´ shapes</li>
                                    <li>Word: Tr√≠ch xu·∫•t text t·ª´ paragraphs, b·∫£ng, header/footer</li>
                                    <li>M·ªói file JSON ch·ª©a 400 c·∫∑p key-value</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- B∆∞·ªõc 3: Inject -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">3</span>
                        <h3 class="d-inline">N·∫°p b·∫£n d·ªãch</h3>
                        <p class="text-muted small mt-2">Inject JSON ƒë√£ d·ªãch v√†o file</p>
                    </div>
                    
                    <form id="injectForm" enctype="multipart/form-data">
                        <!-- Tab ch·ªçn gi·ªØa Upload file v√† Paste JSON -->
                        <ul class="nav nav-tabs nav-fill mb-2" id="injectTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#uploadTab" type="button" role="tab">
                                    <i class="fas fa-folder-open"></i> Upload File
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="paste-tab" data-bs-toggle="tab" data-bs-target="#pasteTab" type="button" role="tab">
                                    <i class="fas fa-paste"></i> Paste JSON
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="injectTabContent">
                            <!-- Tab Upload File -->
                            <div class="tab-pane fade" id="uploadTab" role="tabpanel">
                                <div class="upload-area compact" id="injectJsonUploadArea">
                                    <i class="fas fa-file-code"></i>
                                    <p class="mb-2 small"><strong>K√©o th·∫£ JSON/ZIP</strong></p>
                                    <input type="file" class="form-control" id="injectJsonFile" name="json_files" accept=".json,.zip" multiple style="display: none;">
                                    <label for="injectJsonFile" class="btn btn-custom btn-sm">
                                        <i class="fas fa-folder-open"></i> Ch·ªçn file
                                    </label>
                                </div>
                                
                                <div id="injectJsonFileInfo" class="file-info" style="display: none;">
                                    <div id="injectJsonFileList"></div>
                                    <button type="button" class="btn btn-sm btn-outline-danger float-end mt-2" id="injectJsonFileRemove">
                                        <i class="fas fa-times"></i> X√≥a t·∫•t c·∫£
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tab Paste JSON -->
                            <div class="tab-pane fade show active" id="pasteTab" role="tabpanel">
                                <div class="mb-2">
                                    <label class="form-label small mb-1"><strong>Paste n·ªôi dung JSON:</strong></label>
                                    <textarea class="form-control" id="pasteJsonTextarea" rows="5" placeholder='Paste n·ªôi dung JSON v√†o ƒë√¢y, v√≠ d·ª•:
{
  "Sheet1!A1": "Translated text 1",
  "Sheet1!A2": "Translated text 2"
}' style="font-family: monospace; font-size: 0.85rem;"></textarea>
                                </div>
                                <div class="text-center mb-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="addPastedJsonBtn">
                                        <i class="fas fa-plus-circle"></i> Th√™m JSON n√†y
                                    </button>
                                </div>
                                
                                <!-- Danh s√°ch JSON ƒë√£ paste -->
                                <div id="pastedJsonList" style="display: none;">
                                    <div class="file-info">
                                        <label class="form-label small mb-1"><strong>ƒê√£ th√™m:</strong></label>
                                        <div id="pastedJsonItems"></div>
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="clearPastedJsonBtn">
                                            <i class="fas fa-trash"></i> X√≥a t·∫•t c·∫£
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-2">
                            <button type="submit" class="btn btn-custom btn-sm" id="injectBtn" disabled>
                                <i class="fas fa-download"></i> N·∫°p & T·∫£i v·ªÅ
                            </button>
                        </div>

                        <!-- Validation -->
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-info btn-sm w-100" id="validateBtn" onclick="runValidation()">
                                <i class="fas fa-check-double"></i> Ki·ªÉm tra b·∫£n d·ªãch
                            </button>
                            <div id="validationResult" class="mt-2" style="display:none;"></div>
                        </div>
                        
                        <div class="loading text-center" id="injectLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">ƒêang x·ª≠ l√Ω...</span>
                            </div>
                            <p class="mt-2 small">ƒêang n·∫°p b·∫£n d·ªãch...</p>
                        </div>
                        
                        <div id="injectAlert"></div>
                    </form>
                    
                    <!-- H∆∞·ªõng d·∫´n collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step3Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step3Guide">
                            <div class="p-2" style="background: #f8f9fa; border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li><strong>2 c√°ch n·∫°p JSON:</strong></li>
                                    <li style="list-style: none; padding-left: 15px;">
                                        ‚Ä¢ <strong>Upload file:</strong> Ch·ªçn file JSON/ZIP (h·ªó tr·ª£ nhi·ªÅu file c√πng l√∫c)
                                    </li>
                                    <li style="list-style: none; padding-left: 15px;">
                                        ‚Ä¢ <strong>Paste JSON:</strong> Paste tr·ª±c ti·∫øp n·ªôi dung JSON (c√≥ th·ªÉ paste nhi·ªÅu l·∫ßn)
                                    </li>
                                    <li>T·ª± ƒë·ªông g·ªôp v√† n·∫°p v√†o file g·ªëc (Excel, PowerPoint <b>ho·∫∑c Word</b>)</li>
                                    <li>Gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng, m√†u s·∫Øc, b·∫£ng, header/footer cho Word</li>
                                    <li>T·∫£i v·ªÅ file output_translated</li>
                                    <li>File t·∫°m t·ª± ƒë·ªông x√≥a sau khi t·∫£i</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="text-center mt-5" style="color: #fff; opacity: 0.85;">
        <hr style="border-color: #fff; opacity: 0.2;">
        <div class="pb-2">
            <small>
                &copy; 2026 Tomo Translation &middot; Built by <a href="mailto:eikitomobe@gmail.com" style="color: #fff; text-decoration: underline;">ÂèãÈÉ® ÁëõÁ®Ä</a>
            </small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Modal: Template Editor -->
    <div class="modal fade" id="templateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-magic"></i> Qu·∫£n l√Ω Prompt Templates</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Template list (left) + edit form (right) -->
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong class="small">Danh s√°ch:</strong>
                                <button class="btn btn-outline-success btn-sm py-0 px-2" style="font-size:0.75rem" onclick="addNewTemplate()">
                                    <i class="fas fa-plus"></i> Th√™m
                                </button>
                            </div>
                            <div id="templateList" class="list-group" style="max-height:300px;overflow-y:auto;"></div>
                        </div>
                        <div class="col-md-8" id="templateEditPanel" style="display:none;">
                            <div class="mb-2">
                                <label class="form-label small mb-1"><strong>T√™n template:</strong></label>
                                <input type="text" class="form-control form-control-sm" id="editTemplateName" placeholder="T√™n hi·ªÉn th·ªã...">
                            </div>
                            <div class="mb-2">
                                <label class="form-label small mb-1"><strong>N·ªôi dung prompt</strong> <span class="text-muted">(d√πng <code>{TARGET_LANG}</code> cho ng√¥n ng·ªØ ƒë√≠ch)</span>:</label>
                                <textarea class="form-control" id="editTemplateContent" rows="10" style="font-size:0.78rem;font-family:monospace;"></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="saveEditTemplate()"><i class="fas fa-save"></i> L∆∞u</button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteEditTemplate()"><i class="fas fa-trash"></i> X√≥a</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <small class="text-muted me-auto">Templates l∆∞u trong <code>prompt_templates.json</code></small>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== BI·∫æN TO√ÄN C·ª§C ====================
        let uploadedExcelFilename  = null;
        let extractedFilesData     = null;
        let extractedDedupData     = null;  // Dedup files t·ª´ server
        let currentGlossary        = {};
        let currentTM              = {};
        let currentLangCode        = 'ja';
        let currentLangName        = 'ti·∫øng Nh·∫≠t';
        let currentTemplateContent = '';
        let editingTemplateIdx     = -1;

        // ==================== NG√îN NG·ªÆ ƒê√çCH ====================
        const INITIAL_PROMPT = document.getElementById('aiPrompt').textContent;
        currentTemplateContent = INITIAL_PROMPT;

        function updatePrompt(langName) {
            let promptText = currentTemplateContent.replace(/{TARGET_LANG}/g, langName);
            const entries = Object.entries(currentGlossary);
            if (entries.length > 0) {
                promptText += '\n\nüìñ GLOSSARY (d√πng b·∫£n d·ªãch ƒë√£ quy ƒë·ªãnh):\n' +
                    entries.map(([k, v]) => `- "${k}" ‚Üí "${v}"`).join('\n');
            }
            document.getElementById('aiPrompt').textContent = promptText;
        }

        async function loadLanguages() {
            const select = document.getElementById('targetLangSelect');
            try {
                const res = await fetch('/api/languages');
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const langs = await res.json();
                select.innerHTML = '';
                langs.forEach(function(lang) {
                    const opt = document.createElement('option');
                    opt.value        = lang.code;
                    opt.textContent  = lang.label;
                    opt.dataset.name = lang.name;
                    if (lang.code === 'ja') opt.selected = true;
                    select.appendChild(opt);
                });
                const def = select.options[select.selectedIndex];
                if (def) {
                    currentLangCode = def.value;
                    currentLangName = def.dataset.name;
                    updatePrompt(currentLangName);
                    updateTMHeader(currentLangName);
                    await Promise.all([loadGlossary(currentLangCode), loadTM(currentLangCode), loadTemplates(currentLangCode)]);
                }
            } catch (e) {
                select.innerHTML = '<option value="ja" data-name="ti·∫øng Nh·∫≠t">üáØüáµ Ti·∫øng Nh·∫≠t (Japanese)</option>';
                updatePrompt('ti·∫øng Nh·∫≠t');
                console.warn('Kh√¥ng th·ªÉ t·∫£i languages.json:', e);
            }
            select.addEventListener('change', async function() {
                const chosen = this.options[this.selectedIndex];
                if (chosen) {
                    currentLangCode = chosen.value;
                    currentLangName = chosen.dataset.name;
                    updatePrompt(currentLangName);
                    updateTMHeader(currentLangName);
                    await Promise.all([loadGlossary(currentLangCode), loadTM(currentLangCode), loadTemplates(currentLangCode)]);
                }
            });
        }

        // Ch·∫°y ngay khi trang load
        loadLanguages();

        // ==================== UPLOAD EXCEL CHUNG ====================
        const mainExcelFile = document.getElementById('mainExcelFile');
        const mainFileInfo = document.getElementById('mainFileInfo');
        const mainFileName = document.getElementById('mainFileName');
        const mainFileRemove = document.getElementById('mainFileRemove');
        const mainAlert = document.getElementById('mainAlert');
        const mainUploadArea = document.getElementById('mainUploadArea');
        const extractBtn = document.getElementById('extractBtn');
        const injectBtn = document.getElementById('injectBtn');
        
        // X·ª≠ l√Ω khi ch·ªçn file Excel chung
        mainExcelFile.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                mainFileName.textContent = file.name;
                mainFileInfo.style.display = 'block';
                uploadedExcelFilename = file.name;
                
                // Thay ƒë·ªïi icon ph√π h·ª£p v·ªõi lo·∫°i file
                const fileIcon = document.getElementById('mainFileIcon');
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.xlsx')) {
                    fileIcon.className = 'fas fa-file-excel text-success';
                } else if (fileName.endsWith('.pptx')) {
                    fileIcon.className = 'fas fa-file-powerpoint text-danger';
                } else if (fileName.endsWith('.docx')) {
                    fileIcon.className = 'fas fa-file-word text-primary';
                } else {
                    fileIcon.className = 'fas fa-file text-secondary';
                }
                
                // K√≠ch ho·∫°t c·∫£ 2 n√∫t Extract v√† Inject
                extractBtn.disabled = false;
                injectBtn.disabled = false;
                
                // Hi·ªÉn th·ªã th√¥ng b√°o
                showAlert(mainAlert, 'success', `File "${file.name}" ƒë√£ ƒë∆∞·ª£c ch·ªçn. B·∫°n c√≥ th·ªÉ ti·∫øn h√†nh Extract ho·∫∑c Inject.`);
            }
        });
        
        // X·ª≠ l√Ω x√≥a file
        mainFileRemove.addEventListener('click', function() {
            mainExcelFile.value = '';
            mainFileInfo.style.display = 'none';
            uploadedExcelFilename = null;
            extractBtn.disabled = true;
            injectBtn.disabled = true;
            mainAlert.innerHTML = '';
        });
        
        // X·ª≠ l√Ω drag and drop
        mainUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#764ba2';
            mainUploadArea.style.background = '#e9ecef';
        });
        
        mainUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#667eea';
            mainUploadArea.style.background = '#f8f9fa';
        });
        
        mainUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#667eea';
            mainUploadArea.style.background = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                mainExcelFile.files = files;
                mainFileName.textContent = files[0].name;
                mainFileInfo.style.display = 'block';
                uploadedExcelFilename = files[0].name;
                extractBtn.disabled = false;
                injectBtn.disabled = false;
                showAlert(mainAlert, 'success', `File "${files[0].name}" ƒë√£ ƒë∆∞·ª£c ch·ªçn.`);
            }
        });
        
        // ==================== CH·ª®C NƒÇNG EXTRACT ====================
        
        const extractForm = document.getElementById('extractForm');
        const extractAlert = document.getElementById('extractAlert');
        const extractLoading = document.getElementById('extractLoading');
        const extractResult = document.getElementById('extractResult');
        const extractSummary = document.getElementById('extractSummary');
        const jsonFileList = document.getElementById('jsonFileList');
        
        // X·ª≠ l√Ω submit form Extract
        extractForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Ki·ªÉm tra xem c√≥ file ƒë∆∞·ª£c upload ch∆∞a
            if (!uploadedExcelFilename || mainExcelFile.files.length === 0) {
                showAlert(extractAlert, 'warning', 'Vui l√≤ng upload file (Excel ho·∫∑c PowerPoint) ·ªü B∆∞·ªõc 1 tr∆∞·ªõc!');
                return;
            }
            
            // ·∫®n k·∫øt qu·∫£ c≈©
            extractResult.style.display = 'none';
            jsonFileList.innerHTML = '';
            extractedDedupData = null;
            const dedupPanel = document.getElementById('dedupPanel');
            if (dedupPanel) { dedupPanel.style.display = 'none'; dedupPanel.innerHTML = ''; }
            
            // Hi·ªÉn th·ªã loading
            extractLoading.style.display = 'block';
            extractAlert.innerHTML = '';
            
            // T·∫°o FormData v·ªõi file Excel t·ª´ upload chung
            const formData = new FormData();
            formData.append('file', mainExcelFile.files[0]);
            
            try {
                // G·ª≠i request
                const response = await fetch('/extract', {
                    method: 'POST',
                    body: formData
                });
                
                // ·∫®n loading
                extractLoading.style.display = 'none';
                
                // Ki·ªÉm tra content-type
                const contentType = response.headers.get('content-type');
                
                if (response.ok && contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    
                    if (data.success) {
                        // Hi·ªÉn th·ªã t√≥m t·∫Øt
                        // L∆∞u extracted data cho TM v√† validation
                        extractedFilesData = data.files;
                        extractedDedupData = data.dedup_files || null;

                        // Render file rows
                        renderJsonFileRows(data.files);

                        // Render dedup panel
                        if (extractedDedupData && data.dedup_stats) {
                            renderDedupPanel(extractedDedupData, data.dedup_stats);
                        }

                        // C·∫≠p nh·∫≠t summary
                        const ds = data.dedup_stats;
                        if (ds && ds.saved > 0) {
                            extractSummary.textContent = `${data.total_files} file ¬∑ ${data.total_items} keys (${ds.unique} unique)`;
                        } else {
                            extractSummary.textContent = `${data.total_files} file ¬∑ ${data.total_items} keys`;
                        }

                        // Ki·ªÉm tra text tr√πng l·∫∑p
                        detectDuplicatesInFiles(data.files);

                        // Hi·ªán khu v·ª±c k·∫øt qu·∫£
                        extractResult.style.display = 'block';

                        const ds2 = data.dedup_stats;
                        const dedupNote = (ds2 && ds2.saved > 0)
                            ? ` | üìà <strong>Dedup:</strong> ch·ªâ c·∫ßn d·ªãch <strong>${ds2.unique}</strong>/${ds2.total} (ti·∫øt ki·ªám ${ds2.saved}, ${ds2.percent_saved}%)`
                            : '';
                        //showAlert(extractAlert, 'success', `Tr√≠ch xu·∫•t th√†nh c√¥ng! ${data.total_files} file JSON, ${data.total_items} c·∫∑p key-value.${dedupNote} Click <strong>Copy</strong> ho·∫∑c <strong>Copy Dedup</strong> ƒë·ªÉ d√πng v·ªõi AI.`);
                    } else {
                        showAlert(extractAlert, 'danger', data.error || 'C√≥ l·ªói x·∫£y ra!');
                    }
                } else if (!response.ok) {
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        showAlert(extractAlert, 'danger', error.error || 'C√≥ l·ªói x·∫£y ra!');
                    } else {
                        const text = await response.text();
                        if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                            showAlert(extractAlert, 'danger', 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng <a href="/login">ƒëƒÉng nh·∫≠p l·∫°i</a>.');
                        } else {
                            showAlert(extractAlert, 'danger', 'L·ªói: ' + (text || 'Kh√¥ng x√°c ƒë·ªãnh'));
                        }
                    }
                }
            } catch (error) {
                extractLoading.style.display = 'none';
                showAlert(extractAlert, 'danger', 'L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        });
        
        // Render danh s√°ch file JSON th√†nh t·ª´ng h√†ng
        function renderJsonFileRows(files) {
            jsonFileList.innerHTML = '';
            
            files.forEach(function(file, idx) {
                const row = document.createElement('div');
                row.className = 'json-file-row';
                row.innerHTML = `
                    <span class="file-name" title="${file.name}">
                        <i class="fas fa-file-code text-primary"></i>
                        ${file.name}
                    </span>
                    <button type="button"
                        class="btn btn-outline-primary btn-sm btn-copy-json"
                        data-idx="${idx}"
                        title="Copy prompt AI + n·ªôi dung JSON n√†y">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                `;
                
                // L∆∞u n·ªôi dung v√†o data attribute (d√πng dataset)
                row.querySelector('.btn-copy-json').addEventListener('click', function() {
                    const btnEl = this;
                    // ƒê·ªçc prompt t·∫°i th·ªùi ƒëi·ªÉm click ƒë·ªÉ lu√¥n d√πng ng√¥n ng·ªØ hi·ªán t·∫°i
                    const promptText = document.getElementById('aiPrompt').textContent;
                    const textToCopy = promptText + '\n\n' + file.content;
                    
                    navigator.clipboard.writeText(textToCopy).then(function() {
                        btnEl.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        btnEl.classList.add('copied');
                        setTimeout(function() {
                            btnEl.innerHTML = '<i class="fas fa-copy"></i> Copy';
                            btnEl.classList.remove('copied');
                        }, 2000);
                    }).catch(function() {
                        // Fallback cho browser kh√¥ng h·ªó tr·ª£ clipboard API
                        const textarea = document.createElement('textarea');
                        textarea.value = textToCopy;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        try {
                            document.execCommand('copy');
                            btnEl.innerHTML = '<i class="fas fa-check"></i> Copied!';
                            btnEl.classList.add('copied');
                            setTimeout(function() {
                                btnEl.innerHTML = '<i class="fas fa-copy"></i> Copy';
                                btnEl.classList.remove('copied');
                            }, 2000);
                        } catch(err) {
                            alert('Kh√¥ng th·ªÉ copy t·ª± ƒë·ªông. Vui l√≤ng copy th·ªß c√¥ng.');
                        }
                        document.body.removeChild(textarea);
                    });
                });
                
                jsonFileList.appendChild(row);
            });
        }

        // Render dedup panel ‚Äì hi·ªÉn th·ªã th·ªëng k√™ v√† c√°c file dedup
        function renderDedupPanel(dedupFiles, stats) {
            const panel = document.getElementById('dedupPanel');
            if (!panel) return;

            const savedPct = stats.saved > 0
                ? `<span class="badge bg-success ms-1">-${stats.percent_saved}%</span>`
                : '';

            let rowsHtml = dedupFiles.map((file, idx) => `
                <div class="json-file-row d-flex align-items-center gap-2" style="margin-top:4px">
                    <span class="file-name text-truncate" style="flex:1;font-size:0.78rem" title="${file.name}">
                        <i class="fas fa-compress-alt text-success"></i> ${file.name}
                    </span>
                    <button type="button"
                        class="btn btn-outline-success btn-sm btn-copy-dedup"
                        data-dedup-idx="${idx}"
                        title="Copy prompt AI + n·ªôi dung dedup JSON n√†y (√≠t keys h∆°n)">
                        <i class="fas fa-copy"></i> Copy Dedup
                    </button>
                </div>
            `).join('');

            panel.innerHTML = `
                <div class="dedup-banner alert py-2 px-3 mb-2">
                    <strong><i class="fas fa-compress-arrows-alt text-success me-1"></i>Dedup Mode</strong>
                    ‚Äî T·ªïng <strong>${stats.total}</strong> keys ‚Üí
                    ch·ªâ c·∫ßn d·ªãch <strong>${stats.unique}</strong> unique values
                    ${savedPct}
                    <span class="text-muted">(ti·∫øt ki·ªám ${stats.saved} l·∫ßn d·ªãch)</span>
                    <div class="mt-1" id="dedupFileRows">${rowsHtml}</div>
                </div>`;
            panel.style.display = 'block';

            // G·∫Øn s·ª± ki·ªán cho c√°c n√∫t Copy Dedup
            panel.querySelectorAll('.btn-copy-dedup').forEach(btn => {
                btn.addEventListener('click', function() {
                    const btnEl = this;
                    const idx   = parseInt(this.dataset.dedupIdx);
                    const file  = extractedDedupData[idx];
                    const promptText = document.getElementById('aiPrompt').textContent;
                    const textToCopy = promptText + '\n\n' + file.content;

                    navigator.clipboard.writeText(textToCopy).then(() => {
                        btnEl.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        btnEl.classList.add('copied');
                        setTimeout(() => {
                            btnEl.innerHTML = '<i class="fas fa-copy"></i> Copy Dedup';
                            btnEl.classList.remove('copied');
                        }, 2000);
                    }).catch(() => {
                        const ta = document.createElement('textarea');
                        ta.value = textToCopy;
                        ta.style.cssText = 'position:fixed;opacity:0';
                        document.body.appendChild(ta);
                        ta.select();
                        try { document.execCommand('copy'); btnEl.innerHTML = '<i class="fas fa-check"></i> Copied!'; setTimeout(() => { btnEl.innerHTML = '<i class="fas fa-copy"></i> Copy Dedup'; }, 2000); }
                        catch(e) { alert('Kh√¥ng th·ªÉ copy t·ª± ƒë·ªông.'); }
                        document.body.removeChild(ta);
                    });
                });
            });
        }
        
        const injectForm = document.getElementById('injectForm');
        const injectJsonFile = document.getElementById('injectJsonFile');
        const injectJsonFileInfo = document.getElementById('injectJsonFileInfo');
        const injectJsonFileName = document.getElementById('injectJsonFileName');
        const injectJsonFileRemove = document.getElementById('injectJsonFileRemove');
        const injectAlert = document.getElementById('injectAlert');
        const injectLoading = document.getElementById('injectLoading');
        
        // Paste JSON functionality
        const pasteJsonTextarea = document.getElementById('pasteJsonTextarea');
        const addPastedJsonBtn = document.getElementById('addPastedJsonBtn');
        const pastedJsonList = document.getElementById('pastedJsonList');
        const pastedJsonItems = document.getElementById('pastedJsonItems');
        const clearPastedJsonBtn = document.getElementById('clearPastedJsonBtn');
        
        // L∆∞u danh s√°ch JSON ƒë√£ paste
        let pastedJsonData = [];
        
        // X·ª≠ l√Ω khi click "Th√™m JSON n√†y"
        addPastedJsonBtn.addEventListener('click', function() {
            const jsonText = pasteJsonTextarea.value.trim();
            
            if (!jsonText) {
                showAlert(injectAlert, 'warning', 'Vui l√≤ng paste n·ªôi dung JSON v√†o √¥ b√™n tr√™n!');
                return;
            }
            
            // Validate JSON
            try {
                const parsedJson = JSON.parse(jsonText);
                
                // Ki·ªÉm tra xem c√≥ ph·∫£i object kh√¥ng
                if (typeof parsedJson !== 'object' || parsedJson === null) {
                    showAlert(injectAlert, 'warning', 'JSON ph·∫£i l√† m·ªôt object (kh√¥ng ph·∫£i array ho·∫∑c gi√° tr·ªã ƒë∆°n)!');
                    return;
                }
                
                // Th√™m v√†o danh s√°ch
                pastedJsonData.push(parsedJson);
                
                // Hi·ªÉn th·ªã trong danh s√°ch
                updatePastedJsonList();
                
                // X√≥a textarea
                pasteJsonTextarea.value = '';
                
                // Hi·ªÉn th·ªã th√¥ng b√°o
                showAlert(injectAlert, 'success', `ƒê√£ th√™m JSON #${pastedJsonData.length} v·ªõi ${Object.keys(parsedJson).length} c·∫∑p key-value.`);
                
            } catch (e) {
                showAlert(injectAlert, 'danger', 'JSON kh√¥ng h·ª£p l·ªá: ' + e.message);
            }
        });
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã danh s√°ch JSON ƒë√£ paste
        function updatePastedJsonList() {
            if (pastedJsonData.length === 0) {
                pastedJsonList.style.display = 'none';
                return;
            }
            
            pastedJsonList.style.display = 'block';
            pastedJsonItems.innerHTML = '';
            
            pastedJsonData.forEach((jsonObj, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'mb-1 d-flex justify-content-between align-items-center';
                itemDiv.innerHTML = `
                    <div>
                        <i class="fas fa-clipboard text-success"></i> 
                        <small><strong>JSON #${index + 1}</strong> - ${Object.keys(jsonObj).length} keys</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePastedJson(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                pastedJsonItems.appendChild(itemDiv);
            });
        }
        
        // X√≥a m·ªôt JSON ƒë√£ paste
        window.removePastedJson = function(index) {
            pastedJsonData.splice(index, 1);
            updatePastedJsonList();
            showAlert(injectAlert, 'info', 'ƒê√£ x√≥a JSON.');
        };
        
        // X√≥a t·∫•t c·∫£ JSON ƒë√£ paste
        clearPastedJsonBtn.addEventListener('click', function() {
            if (confirm('X√≥a t·∫•t c·∫£ JSON ƒë√£ paste?')) {
                pastedJsonData = [];
                updatePastedJsonList();
                showAlert(injectAlert, 'info', 'ƒê√£ x√≥a t·∫•t c·∫£ JSON ƒë√£ paste.');
            }
        });
        
        // X·ª≠ l√Ω khi ch·ªçn file JSON (nhi·ªÅu file)
        injectJsonFile.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const fileList = document.getElementById('injectJsonFileList');
                fileList.innerHTML = '';
                
                // Hi·ªÉn th·ªã danh s√°ch c√°c file
                Array.from(e.target.files).forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'mb-1';
                    const icon = file.name.endsWith('.zip') ? 'fa-file-archive' : 'fa-file-code';
                    const color = file.name.endsWith('.zip') ? 'text-warning' : 'text-primary';
                    fileItem.innerHTML = `<i class="fas ${icon} ${color}"></i> <small>${file.name}</small>`;
                    fileList.appendChild(fileItem);
                });
                
                injectJsonFileInfo.style.display = 'block';
            }
        });
        
        // X·ª≠ l√Ω x√≥a file JSON
        injectJsonFileRemove.addEventListener('click', function() {
            injectJsonFile.value = '';
            injectJsonFileInfo.style.display = 'none';
        });
        
        // X·ª≠ l√Ω drag and drop cho JSON files
        const injectJsonUploadArea = document.getElementById('injectJsonUploadArea');
        
        injectJsonUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#764ba2';
            injectJsonUploadArea.style.background = '#e9ecef';
        });
        
        injectJsonUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#667eea';
            injectJsonUploadArea.style.background = '#f8f9fa';
        });
        
        injectJsonUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#667eea';
            injectJsonUploadArea.style.background = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // S·ª≠ d·ª•ng DataTransfer ƒë·ªÉ g√°n files v√†o input
                const dataTransfer = new DataTransfer();
                Array.from(files).forEach(file => {
                    // Ch·ªâ ch·∫•p nh·∫≠n file .json ho·∫∑c .zip
                    if (file.name.endsWith('.json') || file.name.endsWith('.zip')) {
                        dataTransfer.items.add(file);
                    }
                });
                
                if (dataTransfer.files.length > 0) {
                    injectJsonFile.files = dataTransfer.files;
                    
                    // Hi·ªÉn th·ªã danh s√°ch files
                    const fileList = document.getElementById('injectJsonFileList');
                    fileList.innerHTML = '';
                    
                    Array.from(dataTransfer.files).forEach((file, index) => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'mb-1';
                        const icon = file.name.endsWith('.zip') ? 'fa-file-archive' : 'fa-file-code';
                        const color = file.name.endsWith('.zip') ? 'text-warning' : 'text-primary';
                        fileItem.innerHTML = `<i class="fas ${icon} ${color}"></i> <small>${file.name}</small>`;
                        fileList.appendChild(fileItem);
                    });
                    
                    injectJsonFileInfo.style.display = 'block';
                } else {
                    showAlert(injectAlert, 'warning', 'Ch·ªâ ch·∫•p nh·∫≠n file .json ho·∫∑c .zip!');
                }
            }
        });
        
        // X·ª≠ l√Ω submit form Inject
        injectForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Ki·ªÉm tra xem c√≥ file ƒë∆∞·ª£c upload ch∆∞a
            if (!uploadedExcelFilename || mainExcelFile.files.length === 0) {
                showAlert(injectAlert, 'warning', 'Vui l√≤ng upload file (Excel ho·∫∑c PowerPoint) ·ªü B∆∞·ªõc 1 tr∆∞·ªõc!');
                return;
            }
            
            // Ki·ªÉm tra xem c√≥ file JSON HO·∫∂C pasted JSON kh√¥ng
            if (injectJsonFile.files.length === 0 && pastedJsonData.length === 0) {
                showAlert(injectAlert, 'warning', 'Vui l√≤ng ch·ªçn file JSON ƒë√£ d·ªãch ho·∫∑c paste JSON!');
                return;
            }
            
            // Hi·ªÉn th·ªã loading
            injectLoading.style.display = 'block';
            injectAlert.innerHTML = '';
            
            // T·∫°o FormData v·ªõi file Excel t·ª´ upload chung v√† t·∫•t c·∫£ file JSON
            const formData = new FormData();
            formData.append('excel_file', mainExcelFile.files[0]);
            
            // Th√™m t·∫•t c·∫£ c√°c file JSON/ZIP
            Array.from(injectJsonFile.files).forEach(file => {
                formData.append('json_files', file);
            });
            
            // Th√™m t·∫•t c·∫£ JSON ƒë√£ paste (g·ª≠i d∆∞·ªõi d·∫°ng JSON string)
            if (pastedJsonData.length > 0) {
                formData.append('pasted_json_data', JSON.stringify(pastedJsonData));
            }
            
            try {
                // G·ª≠i request
                const response = await fetch('/inject', {
                    method: 'POST',
                    body: formData
                });
                
                // ·∫®n loading
                injectLoading.style.display = 'none';
                
                if (response.ok) {
                    // L·∫•y t√™n file t·ª´ header Content-Disposition
                    const disposition = response.headers.get('Content-Disposition');
                    let filename = `output_translated_${Date.now()}.xlsx`;
                    const parsedFilename = parseDownloadFilename(disposition);
                    if (parsedFilename) {
                        filename = parsedFilename;
                    }
                    
                    // T·∫£i file v·ªõi t√™n ƒë√∫ng extension
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert(injectAlert, 'success', 'N·∫°p b·∫£n d·ªãch th√†nh c√¥ng! File ƒëang ƒë∆∞·ª£c t·∫£i v·ªÅ. T·∫•t c·∫£ file t·∫°m ƒë√£ ƒë∆∞·ª£c x√≥a.');
                    
                    // T·ª± ƒë·ªông l∆∞u c·∫∑p d·ªãch v√†o TM
                    await savePairsToTM();

                    // Reset form JSON
                    injectJsonFile.value = '';
                    injectJsonFileInfo.style.display = 'none';
                    
                    // Reset pasted JSON
                    pastedJsonData = [];
                    updatePastedJsonList();
                    pasteJsonTextarea.value = '';
                    
                    // T·ª± ƒë·ªông x√≥a t·∫•t c·∫£ file trong th∆∞ m·ª•c uploads sau khi th√†nh c√¥ng
                    await clearUploads(true);
                } else {
                    // Ki·ªÉm tra xem response c√≥ ph·∫£i JSON kh√¥ng
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        showAlert(injectAlert, 'danger', error.error || 'C√≥ l·ªói x·∫£y ra!');
                    } else {
                        // N·∫øu kh√¥ng ph·∫£i JSON (c√≥ th·ªÉ l√† HTML t·ª´ trang login ho·∫∑c l·ªói server)
                        const text = await response.text();
                        if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                            showAlert(injectAlert, 'danger', 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng <a href="/login">ƒëƒÉng nh·∫≠p l·∫°i</a>.');
                        } else {
                            showAlert(injectAlert, 'danger', 'L·ªói: ' + (text || 'Kh√¥ng x√°c ƒë·ªãnh'));
                        }
                    }
                }
            } catch (error) {
                injectLoading.style.display = 'none';
                showAlert(injectAlert, 'danger', 'L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        });
        
        // ==================== H√ÄM TR·ª¢ GI√öP ====================

        function parseDownloadFilename(contentDisposition) {
            if (!contentDisposition) return null;

            // ∆Øu ti√™n RFC 5987: filename*=UTF-8''...
            const filenameStarMatch = contentDisposition.match(/filename\*\s*=\s*UTF-8''([^;\n]+)/i);
            if (filenameStarMatch && filenameStarMatch[1]) {
                try {
                    return decodeURIComponent(filenameStarMatch[1].trim());
                } catch (e) {
                    // fallback xu·ªëng filename th∆∞·ªùng
                }
            }

            // Fallback: filename="..." ho·∫∑c filename=...
            const filenameMatch = contentDisposition.match(/filename\s*=\s*(("([^"]+)")|([^;\n]+))/i);
            if (filenameMatch) {
                return (filenameMatch[3] || filenameMatch[4] || '').trim();
            }

            return null;
        }
        
        // H√†m x√≥a t·∫•t c·∫£ file trong uploads
        async function clearUploads(skipConfirm = false) {
            // X√°c nh·∫≠n tr∆∞·ªõc khi x√≥a (tr·ª´ khi skipConfirm = true)
            if (!skipConfirm && !confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ file trong th∆∞ m·ª•c uploads?\n\nThao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                return;
            }
            
            try {
                const response = await fetch('/clear-uploads', {
                    method: 'POST'
                });
                
                // Ki·ªÉm tra xem response c√≥ ph·∫£i JSON kh√¥ng
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                        if (!skipConfirm) {
                            alert('‚ùå Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                            window.location.href = '/login';
                        }
                        return;
                    }
                    result = { error: text };
                }
                
                if (response.ok && result.success) {
                    if (!skipConfirm) {
                        alert(`‚úÖ ${result.message}`);
                    }
                    
                    // Reset form v√† tr·∫°ng th√°i
                    mainExcelFile.value = '';
                    mainFileInfo.style.display = 'none';
                    uploadedExcelFilename = null;
                    extractBtn.disabled = true;
                    injectBtn.disabled = true;
                    mainAlert.innerHTML = '';
                    injectJsonFile.value = '';
                    injectJsonFileInfo.style.display = 'none';
                } else {
                    if (!skipConfirm) {
                        alert('‚ùå L·ªói: ' + (result.error || result.message));
                    }
                }
            } catch (error) {
                if (!skipConfirm) {
                    alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
                }
            }
        }
        
        // H√†m copy prompt AI
        // copyPrompt() ƒë√£ ƒë∆∞·ª£c thay th·∫ø b·ªüi renderJsonFileRows() inline copy
        

        // ==================== DARK MODE ====================
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark ? '1' : '0');
            document.getElementById('darkModeIcon').className   = isDark ? 'fas fa-sun'  : 'fas fa-moon';
            document.getElementById('darkModeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }
        (function() {
            if (localStorage.getItem('darkMode') === '1') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').className    = 'fas fa-sun';
                document.getElementById('darkModeLabel').textContent = 'Light Mode';
            }
        })();

        // ==================== PROMPT TEMPLATES ====================
        let allTemplates = [];

        async function loadTemplates(lang) {
            lang = lang || currentLangCode || 'default';
            try {
                const res = await fetch('/api/templates?lang=' + encodeURIComponent(lang));
                if (!res.ok) throw new Error();
                allTemplates = await res.json();
            } catch(e) {
                allTemplates = [{id:'default', name:'M·∫∑c ƒë·ªãnh', content: INITIAL_PROMPT}];
            }
            renderTemplateSelect();
        }

        function renderTemplateSelect() {
            const sel = document.getElementById('templateSelect');
            if (!sel) return;
            sel.innerHTML = '';
            allTemplates.forEach((t, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = t.name;
                sel.appendChild(opt);
            });
            applyTemplate(0);
            // Replace with clone to clear any previously attached listeners
            const fresh = sel.cloneNode(true);
            sel.parentNode.replaceChild(fresh, sel);
            fresh.addEventListener('change', function() { applyTemplate(parseInt(this.value)); });
        }

        function applyTemplate(idx) {
            if (!allTemplates[idx]) return;
            currentTemplateContent = allTemplates[idx].content;
            updatePrompt(currentLangName);
        }

        function openTemplateModal() {
            const title = document.querySelector('#templateModal .modal-title');
            if (title) title.innerHTML = `<i class="fas fa-magic"></i> Qu·∫£n l√Ω Prompt Templates <small class="text-muted ms-1" style="font-size:0.75em">(${currentLangName})</small>`;
            renderTemplateListInModal();
            new bootstrap.Modal(document.getElementById('templateModal')).show();
        }

        function renderTemplateListInModal() {
            const list = document.getElementById('templateList');
            list.innerHTML = '';
            allTemplates.forEach((t, i) => {
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action py-1 small';
                btn.textContent = t.name;
                btn.onclick = () => openTemplateForEdit(i);
                list.appendChild(btn);
            });
        }

        function openTemplateForEdit(idx) {
            editingTemplateIdx = idx;
            document.getElementById('editTemplateName').value    = allTemplates[idx].name;
            document.getElementById('editTemplateContent').value = allTemplates[idx].content;
            document.getElementById('templateEditPanel').style.display = 'block';
            document.querySelectorAll('#templateList .list-group-item').forEach((el, i) => {
                el.classList.toggle('active', i === idx);
            });
        }

        function addNewTemplate() {
            allTemplates.push({id: 'custom_' + Date.now(), name: 'Template m·ªõi', content: INITIAL_PROMPT});
            renderTemplateListInModal();
            openTemplateForEdit(allTemplates.length - 1);
        }

        async function saveEditTemplate() {
            if (editingTemplateIdx < 0) return;
            allTemplates[editingTemplateIdx].name    = document.getElementById('editTemplateName').value.trim() || 'Template';
            allTemplates[editingTemplateIdx].content = document.getElementById('editTemplateContent').value;
            try {
                await fetch('/api/templates?lang=' + encodeURIComponent(currentLangCode), {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(allTemplates)});
            } catch(e) {}
            renderTemplateListInModal();
            renderTemplateSelect();
            alert('‚úÖ ƒê√£ l∆∞u template!');
        }

        async function deleteEditTemplate() {
            if (editingTemplateIdx < 0 || allTemplates.length <= 1) { alert('C·∫ßn gi·ªØ √≠t nh·∫•t 1 template.'); return; }
            if (!confirm('X√≥a template n√†y?')) return;
            allTemplates.splice(editingTemplateIdx, 1);
            editingTemplateIdx = -1;
            document.getElementById('templateEditPanel').style.display = 'none';
            try {
                await fetch('/api/templates?lang=' + encodeURIComponent(currentLangCode), {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(allTemplates)});
            } catch(e) {}
            renderTemplateListInModal();
            renderTemplateSelect();
        }

        // ==================== GLOSSARY ====================
        async function loadGlossary(lang) {
            try {
                const res = await fetch(`/api/glossary/${lang}`);
                currentGlossary = res.ok ? await res.json() : {};
            } catch(e) { currentGlossary = {}; }
            updateGlossaryInfo();
            updatePrompt(currentLangName);
        }

        function updateGlossaryInfo() {
            const el = document.getElementById('glossaryInfo');
            if (!el) return;
            const count = Object.keys(currentGlossary).length;
            if (count > 0) {
                el.innerHTML = `<i class="fas fa-check-circle text-success"></i> ${count} t·ª´ trong glossary ‚Äî s·∫Ω t·ª± ƒë·ªông th√™m v√†o prompt`;
            } else {
                el.innerHTML = `<i class="fas fa-circle text-secondary"></i> Ch∆∞a c√≥ glossary ‚Äî upload CSV ƒë·ªÉ th√™m`;
            }
        }

        async function uploadGlossary(input) {
            if (!input.files.length) return;
            const fd = new FormData();
            fd.append('file', input.files[0]);
            input.value = '';
            try {
                const res = await fetch(`/api/glossary/${currentLangCode}/upload`, {method: 'POST', body: fd});
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ ƒê√£ upload ${data.count} t·ª´ v√†o glossary!`);
                    await loadGlossary(currentLangCode);
                } else {
                    alert('‚ùå L·ªói: ' + data.error);
                }
            } catch(e) { alert('‚ùå L·ªói k·∫øt n·ªëi'); }
        }

        async function exportGlossary() {
            window.location.href = `/api/glossary/${currentLangCode}/export`;
        }

        async function clearGlossary() {
            const count = Object.keys(currentGlossary).length;
            if (count === 0) { alert('Glossary ƒëang tr·ªëng.'); return; }
            if (!confirm(`X√≥a to√†n b·ªô ${count} t·ª´ trong glossary ${currentLangName}?`)) return;
            try {
                await fetch(`/api/glossary/${currentLangCode}/clear`, {method: 'POST'});
                currentGlossary = {};
                updateGlossaryInfo();
                updatePrompt(currentLangName);
                alert('‚úÖ ƒê√£ x√≥a glossary.');
            } catch(e) { alert('‚ùå L·ªói k·∫øt n·ªëi'); }
        }

        // ==================== TRANSLATION MEMORY ====================
        function updateTMHeader(langName) {
            const h = document.getElementById('tmLangHeader');
            if (h) h.textContent = `TM: ${langName}`;
        }

        async function loadTM(lang) {
            try {
                const res = await fetch(`/api/tm?lang=${lang}`);
                currentTM = res.ok ? await res.json() : {};
            } catch(e) { currentTM = {}; }
        }

        async function savePairsToTM() {
            if (!extractedFilesData || pastedJsonData.length === 0) return;
            // Gom source text t·ª´ extracted files
            const sourceMap = {};
            extractedFilesData.forEach(f => {
                try { Object.assign(sourceMap, JSON.parse(f.content)); } catch(e) {}
            });
            // Gom translated text t·ª´ pasted data
            const translatedMap = {};
            pastedJsonData.forEach(obj => Object.assign(translatedMap, obj));
            // Build pairs (ch·ªâ l∆∞u khi source ‚â† translated)
            const pairs = {};
            for (const [key, src] of Object.entries(sourceMap)) {
                if (translatedMap[key] && translatedMap[key] !== src) {
                    pairs[src] = translatedMap[key];
                }
            }
            if (Object.keys(pairs).length === 0) return;
            try {
                const res = await fetch('/api/tm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lang: currentLangCode, pairs})
                });
                const data = await res.json();
                if (data.success) {
                    await loadTM(currentLangCode);
                    console.log(`TM: ƒë√£ l∆∞u ${data.saved} c·∫∑p (t·ªïng ${data.total})`);
                }
            } catch(e) {}
        }

        async function exportTM() {
            const count = Object.keys(currentTM).length;
            if (count === 0) { alert('TM ƒëang tr·ªëng cho ng√¥n ng·ªØ n√†y.'); return; }
            window.location.href = `/api/tm/export/${currentLangCode}`;
        }

        async function importTM(input) {
            if (!input.files.length) return;
            const fd = new FormData();
            fd.append('file', input.files[0]);
            input.value = '';
            try {
                const res = await fetch(`/api/tm/import/${currentLangCode}`, {method: 'POST', body: fd});
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ ƒê√£ nh·∫≠p ${data.imported} c·∫∑p v√†o TM (t·ªïng: ${data.total})`);
                    await loadTM(currentLangCode);
                } else { alert('‚ùå ' + data.error); }
            } catch(e) { alert('‚ùå L·ªói k·∫øt n·ªëi'); }
        }

        async function clearTM() {
            const count = Object.keys(currentTM).length;
            if (count === 0) { alert('TM ƒëang tr·ªëng.'); return; }
            if (!confirm(`X√≥a to√†n b·ªô ${count} c·∫∑p trong TM cho ${currentLangName}?`)) return;
            try {
                await fetch(`/api/tm/clear/${currentLangCode}`, {method: 'POST'});
                currentTM = {};
                alert('‚úÖ ƒê√£ x√≥a TM.');
            } catch(e) { alert('‚ùå L·ªói k·∫øt n·ªëi'); }
        }

        // ==================== DUPLICATE DETECTION ====================
        function detectDuplicatesInFiles(files) {
            const valueCounts = {};
            files.forEach(file => {
                try {
                    const obj = JSON.parse(file.content);
                    for (const [k, v] of Object.entries(obj)) {
                        if (!valueCounts[v]) valueCounts[v] = [];
                        valueCounts[v].push(k);
                    }
                } catch(e) {}
            });
            const dups = Object.entries(valueCounts).filter(([v, keys]) => keys.length > 1);
        }

        // ==================== SMART VALIDATION ====================
        function runValidation() {
            // Gom t·∫•t c·∫£ JSON ƒë√£ paste
            const translated = {};
            pastedJsonData.forEach(obj => Object.assign(translated, obj));

            if (Object.keys(translated).length === 0) {
                document.getElementById('validationResult').style.display = 'block';
                document.getElementById('validationResult').innerHTML =
                    '<div class="alert alert-warning py-1 small mt-1"><i class="fas fa-exclamation-triangle"></i> Ch∆∞a c√≥ JSON n√†o ƒë·ªÉ ki·ªÉm tra. H√£y paste JSON ƒë√£ d·ªãch tr∆∞·ªõc.</div>';
                return;
            }

            // Gom source text (n·∫øu c√≥)
            const source = {};
            if (extractedFilesData) {
                extractedFilesData.forEach(f => {
                    try { Object.assign(source, JSON.parse(f.content)); } catch(e) {}
                });
            }

            const errors = [], warnings = [];
            const INVALID_QUOTES = /[‚Äú‚Äù‚Äû‚Äü¬´¬ª‚Äò‚Äô]/;
            const PLACEHOLDER_RE = /\{[\w\d_]+\}|%[sdf\d]|\$\d+|%\d+\$[sd]|%\d/g;
            const URL_RE         = /https?:\/\/[^\s"]+/g;
            const EMAIL_RE       = /[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}/g;

            for (const [key, tVal] of Object.entries(translated)) {
                // 1. D·∫•u ngo·∫∑c k√©p ƒë·∫∑c bi·ªát
                if (INVALID_QUOTES.test(tVal)) {
                    errors.push({key, msg: 'C√≥ d·∫•u ngo·∫∑c k√©p ƒë·∫∑c bi·ªát (" " ho·∫∑c t∆∞∆°ng t·ª±) ‚Äî c·∫ßn thay b·∫±ng \"'});
                }
                const sVal = source[key];
                if (sVal !== undefined) {
                    // 2. Placeholder b·ªã thi·∫øu
                    const srcPH = [...sVal.matchAll(PLACEHOLDER_RE)].map(m => m[0]);
                    const missing = srcPH.filter(ph => !tVal.includes(ph));
                    if (missing.length > 0) {
                        errors.push({key, msg: `Thi·∫øu placeholder: ${missing.join(', ')}`});
                    }
                    // 3. ƒê·ªô d√†i ch√™nh l·ªách > 50%
                    if (sVal.length > 5) {
                        const ratio = tVal.length / sVal.length;
                        if (ratio > 2.0 || ratio < 0.3) {
                            warnings.push({key, msg: `ƒê·ªô d√†i kh√°c bi·ªát nhi·ªÅu: g·ªëc ${sVal.length} ‚Üí d·ªãch ${tVal.length} k√Ω t·ª±`});
                        }
                    }
                    // 4. URL kh√¥ng ƒë∆∞·ª£c thay ƒë·ªïi
                    const srcURLs = [...sVal.matchAll(URL_RE)].map(m => m[0]);
                    srcURLs.filter(u => !tVal.includes(u)).forEach(u => {
                        warnings.push({key, msg: `URL c·∫ßn gi·ªØ nguy√™n: ${u.substring(0, 50)}`});
                    });
                    // 5. Email kh√¥ng ƒë∆∞·ª£c thay ƒë·ªïi
                    const srcEmails = [...sVal.matchAll(EMAIL_RE)].map(m => m[0]);
                    srcEmails.filter(e => !tVal.includes(e)).forEach(e => {
                        warnings.push({key, msg: `Email c·∫ßn gi·ªØ nguy√™n: ${e}`});
                    });
                }
            }

            renderValidationResult(errors, warnings, Object.keys(translated).length);
        }

        function renderValidationResult(errors, warnings, totalKeys) {
            const el = document.getElementById('validationResult');
            el.style.display = 'block';
            if (errors.length === 0 && warnings.length === 0) {
                el.innerHTML = `<div class="alert alert-success py-1 small mt-1"><i class="fas fa-check-circle"></i> Ki·ªÉm tra ${totalKeys} keys ‚Äî Kh√¥ng ph√°t hi·ªán v·∫•n ƒë·ªÅ!</div>`;
                return;
            }
            let html = `<div class="mt-1" style="font-size:0.78rem;">
                <div class="mb-1"><strong>${totalKeys} keys</strong> ‚Äî <span class="text-danger">${errors.length} l·ªói</span>, <span class="text-warning">${warnings.length} c·∫£nh b√°o</span></div>`;
            if (errors.length > 0) {
                html += `<div class="mb-1"><strong class="text-danger"><i class="fas fa-times-circle"></i> L·ªói:</strong>
                    <ul class="mb-0 ps-3">` +
                    errors.slice(0, 20).map(e => `<li><code>${e.key.substring(0,30)}</code>: ${e.msg}</li>`).join('') +
                    (errors.length > 20 ? `<li>... v√† ${errors.length - 20} l·ªói kh√°c</li>` : '') +
                    `</ul></div>`;
            }
            if (warnings.length > 0) {
                html += `<div><strong class="text-warning"><i class="fas fa-exclamation-triangle"></i> C·∫£nh b√°o:</strong>
                    <ul class="mb-0 ps-3">` +
                    warnings.slice(0, 10).map(w => `<li><code>${w.key.substring(0,30)}</code>: ${w.msg}</li>`).join('') +
                    (warnings.length > 10 ? `<li>... v√† ${warnings.length - 10} c·∫£nh b√°o kh√°c</li>` : '') +
                    `</ul></div>`;
            }
            html += '</div>';
            el.innerHTML = html;
        }


        // ==================== DARK MODE ====================
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark ? '1' : '0');
            document.getElementById('darkModeIcon').className   = isDark ? 'fas fa-sun'  : 'fas fa-moon';
            document.getElementById('darkModeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }
        (function() {
            if (localStorage.getItem('darkMode') === '1') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').className    = 'fas fa-sun';
                document.getElementById('darkModeLabel').textContent = 'Light Mode';
            }
        })();

                function showAlert(element, type, message) {
            element.innerHTML = `
                <div class="alert alert-${type} alert-custom alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
    </script>
</body>
</html>
