<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel & PowerPoint Translation Manager</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome cho icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .function-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: 100%;
            transition: transform 0.3s;
        }
        
        .function-card:hover {
            transform: translateY(-5px);
        }
        
        .function-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .function-card .icon {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin: 15px 0;
            transition: all 0.3s;
        }
        
        .upload-area.compact {
            padding: 15px;
            margin: 10px 0;
        }
        
        .upload-area:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }
        
        .upload-area i {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .collapse-toggle {
            cursor: pointer;
            user-select: none;
        }
        
        .collapse-toggle:hover {
            opacity: 0.8;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-custom:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .alert-custom {
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .file-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .loading {
            display: none;
            margin-top: 15px;
        }
        
        .loading .spinner-border {
            width: 2rem;
            height: 2rem;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-language"></i> Excel & PowerPoint Translation Manager</h1>
            <p>Công cụ quản lý trích xuất và nạp bản dịch cho file Excel (.xlsx) và PowerPoint (.pptx)</p>
            <div class="mt-3">
                <button class="btn btn-outline-light btn-sm" onclick="clearUploads()" title="Xóa file trong phiên của bạn">
                    <i class="fas fa-trash-alt"></i> Xóa file của tôi
                </button>
                <a href="/logout" class="btn btn-outline-light btn-sm ms-2" title="Đăng xuất">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </a>
            </div>
        </div>
        
        <!-- 3 Bước theo hàng ngang -->
        <div class="row g-3">
            <!-- Bước 1: Upload file -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">1</span>
                        <h3 class="d-inline">Upload File</h3>
                        <p class="text-muted small mt-2">File gốc (.xlsx hoặc .pptx)</p>
                    </div>
                    
                    <form id="uploadExcelForm" enctype="multipart/form-data">
                        <div class="upload-area compact" id="mainUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p class="mb-2 small"><strong>Kéo thả file vào đây</strong></p>
                            <input type="file" class="form-control" id="mainExcelFile" name="file" accept=".xlsx,.pptx" style="display: none;">
                            <label for="mainExcelFile" class="btn btn-custom btn-sm">
                                <i class="fas fa-folder-open"></i> Chọn file
                            </label>
                        </div>
                        
                        <div id="mainFileInfo" class="file-info" style="display: none;">
                            <i class="fas fa-file-excel text-success"></i>
                            <span id="mainFileName" class="small"></span>
                            <button type="button" class="btn btn-sm btn-outline-danger float-end" id="mainFileRemove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div id="mainAlert"></div>
                    </form>
                    
                    <!-- Hướng dẫn collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step1Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>Hướng dẫn sử dụng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step1Guide">
                            <div class="p-2" style="background: #f8f9fa; border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li>Hỗ trợ Excel (.xlsx) và PowerPoint (.pptx)</li>
                                    <li>Kéo thả hoặc click để chọn file</li>
                                    <li>File sẽ dùng cho cả Extract và Inject</li>
                                    <li>Giới hạn: 16MB</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bước 2: Extract -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">2</span>
                        <h3 class="d-inline">Trích xuất</h3>
                        <p class="text-muted small mt-2">Extract nội dung cần dịch</p>
                    </div>
                    
                    <form id="extractForm" enctype="multipart/form-data">
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-custom btn-sm" id="extractBtn" disabled>
                                <i class="fas fa-download"></i> Trích xuất JSON
                            </button>
                        </div>
                        
                        <div class="loading text-center" id="extractLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang xử lý...</span>
                            </div>
                            <p class="mt-2 small">Đang trích xuất dữ liệu...</p>
                        </div>
                        
                        <div id="extractAlert"></div>
                    </form>
                    
                    <!-- Prompt AI - Chỉ hiển thị nút Copy -->
                    <div class="mt-3 text-center">
                        <button class="btn btn-outline-primary btn-sm" onclick="copyPrompt()" title="Copy prompt AI để dịch">
                            <i class="fas fa-robot"></i> Copy Prompt AI
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#promptDetail">
                            <i class="fas fa-eye"></i> Xem
                        </button>
                    </div>
                    
                    <!-- Nội dung prompt collapse -->
                    <div class="collapse mt-2" id="promptDetail">
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; border: 1px solid #90caf9;">
                            <pre id="aiPrompt" style="margin: 0; font-size: 0.7rem; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto;">Hãy dịch các giá trị (values) trong file JSON này sang tiếng Nhật.

Quy tắc bắt buộc:
1. Giữ nguyên 100% các keys (tọa độ cell như "Sheet1!A1")
2. CHỈ dịch nội dung bên trong values
3. KHÔNG dịch các từ/cụm từ đã là ngôn ngữ đích - GIỮ NGUYÊN chúng
4. KHÔNG dịch các mã kỹ thuật, placeholder, hoặc tên biến
5. KHÔNG dịch số, ngày tháng, ký hiệu đặc biệt
6. Giữ nguyên format JSON chuẩn

⚠️ QUY TẮC QUAN TRỌNG về dấu ngoặc kép:
- CHỈ sử dụng dấu ngoặc kép THẲNG chuẩn JSON: " (U+0022)
- TUYỆT ĐỐI KHÔNG dùng dấu ngoặc kép đặc biệt: " " „ ‟ « »
- Nếu cần trích dẫn trong nội dung dịch: dùng 「 」hoặc 'đơn'
- Ví dụ ĐÚNG: "App 「Order Printer Pro」 の使用"
- Ví dụ SAI: "App "Order Printer Pro" の使用" ❌

Output yêu cầu:
- Trả về ĐÚNG cấu trúc JSON gốc
- KHÔNG thêm giải thích hay văn bản nào khác
- Đảm bảo encoding UTF-8
- Kiểm tra kỹ KHÔNG có dấu ngoặc kép đặc biệt trong output</pre>
                        </div>
                    </div>
                    
                    <!-- Hướng dẫn collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step2Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>Hướng dẫn sử dụng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step2Guide">
                            <div class="p-2" style="background: #f8f9fa; border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li>Click "Trích xuất JSON" → tải về ZIP</li>
                                    <li>Giải nén ZIP → có nhiều file JSON nhỏ</li>
                                    <li>Excel: Bỏ qua số và công thức</li>
                                    <li>PowerPoint: Trích xuất text từ shapes</li>
                                    <li>Mỗi file JSON chứa 400 cặp key-value</li>
                                    <li>Dùng AI (ChatGPT/Copilot) để dịch</li>
                                    <li>Copy prompt AI bằng nút bên trên</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bước 3: Inject -->
            <div class="col-lg-4">
                <div class="function-card">
                    <div class="text-center">
                        <span class="step-number">3</span>
                        <h3 class="d-inline">Nạp bản dịch</h3>
                        <p class="text-muted small mt-2">Inject JSON đã dịch vào file</p>
                    </div>
                    
                    <form id="injectForm" enctype="multipart/form-data">
                        <div class="upload-area compact" id="injectJsonUploadArea">
                            <i class="fas fa-file-code"></i>
                            <p class="mb-2 small"><strong>Kéo thả JSON/ZIP</strong></p>
                            <input type="file" class="form-control" id="injectJsonFile" name="json_files" accept=".json,.zip" multiple style="display: none;">
                            <label for="injectJsonFile" class="btn btn-custom btn-sm">
                                <i class="fas fa-folder-open"></i> Chọn file
                            </label>
                        </div>
                        
                        <div id="injectJsonFileInfo" class="file-info" style="display: none;">
                            <div id="injectJsonFileList"></div>
                            <button type="button" class="btn btn-sm btn-outline-danger float-end mt-2" id="injectJsonFileRemove">
                                <i class="fas fa-times"></i> Xóa
                            </button>
                        </div>
                        
                        <div class="text-center mt-2">
                            <button type="submit" class="btn btn-custom btn-sm" id="injectBtn" disabled>
                                <i class="fas fa-download"></i> Nạp & Tải về
                            </button>
                        </div>
                        
                        <div class="loading text-center" id="injectLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang xử lý...</span>
                            </div>
                            <p class="mt-2 small">Đang nạp bản dịch...</p>
                        </div>
                        
                        <div id="injectAlert"></div>
                    </form>
                    
                    <!-- Hướng dẫn collapse -->
                    <div class="mt-3">
                        <div class="collapse-toggle p-2" style="background: #f8f9fa; border-radius: 5px;" data-bs-toggle="collapse" data-bs-target="#step3Guide">
                            <i class="fas fa-info-circle text-info"></i>
                            <small><strong>Hướng dẫn sử dụng</strong></small>
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div class="collapse mt-2" id="step3Guide">
                            <div class="p-2" style="background: #f8f9fa; border-radius: 5px;">
                                <ul class="small mb-0" style="padding-left: 20px;">
                                    <li>Upload file JSON đã dịch (hoặc ZIP)</li>
                                    <li>Hỗ trợ nhiều file JSON cùng lúc</li>
                                    <li>Tự động gộp và nạp vào file gốc</li>
                                    <li>Giữ nguyên định dạng, màu sắc</li>
                                    <li>Tải về file output_translated</li>
                                    <li>File tạm tự động xóa sau khi tải</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==================== BIẾN TOÀN CỤC ====================
        let uploadedExcelFilename = null; // Lưu tên file Excel đã upload
        
        // ==================== UPLOAD EXCEL CHUNG ====================
        const mainExcelFile = document.getElementById('mainExcelFile');
        const mainFileInfo = document.getElementById('mainFileInfo');
        const mainFileName = document.getElementById('mainFileName');
        const mainFileRemove = document.getElementById('mainFileRemove');
        const mainAlert = document.getElementById('mainAlert');
        const mainUploadArea = document.getElementById('mainUploadArea');
        const extractBtn = document.getElementById('extractBtn');
        const injectBtn = document.getElementById('injectBtn');
        
        // Xử lý khi chọn file Excel chung
        mainExcelFile.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                mainFileName.textContent = file.name;
                mainFileInfo.style.display = 'block';
                uploadedExcelFilename = file.name;
                
                // Kích hoạt cả 2 nút Extract và Inject
                extractBtn.disabled = false;
                injectBtn.disabled = false;
                
                // Hiển thị thông báo
                showAlert(mainAlert, 'success', `File "${file.name}" đã được chọn. Bạn có thể tiến hành Extract hoặc Inject.`);
            }
        });
        
        // Xử lý xóa file
        mainFileRemove.addEventListener('click', function() {
            mainExcelFile.value = '';
            mainFileInfo.style.display = 'none';
            uploadedExcelFilename = null;
            extractBtn.disabled = true;
            injectBtn.disabled = true;
            mainAlert.innerHTML = '';
        });
        
        // Xử lý drag and drop
        mainUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#764ba2';
            mainUploadArea.style.background = '#e9ecef';
        });
        
        mainUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#667eea';
            mainUploadArea.style.background = '#f8f9fa';
        });
        
        mainUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            mainUploadArea.style.borderColor = '#667eea';
            mainUploadArea.style.background = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                mainExcelFile.files = files;
                mainFileName.textContent = files[0].name;
                mainFileInfo.style.display = 'block';
                uploadedExcelFilename = files[0].name;
                extractBtn.disabled = false;
                injectBtn.disabled = false;
                showAlert(mainAlert, 'success', `File "${files[0].name}" đã được chọn.`);
            }
        });
        
        // ==================== CHỨC NĂNG EXTRACT ====================
        
        const extractForm = document.getElementById('extractForm');
        const extractAlert = document.getElementById('extractAlert');
        const extractLoading = document.getElementById('extractLoading');
        
        // Xử lý submit form Extract
        extractForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Kiểm tra xem có file được upload chưa
            if (!uploadedExcelFilename || mainExcelFile.files.length === 0) {
                showAlert(extractAlert, 'warning', 'Vui lòng upload file (Excel hoặc PowerPoint) ở Bước 1 trước!');
                return;
            }
            
            // Hiển thị loading
            extractLoading.style.display = 'block';
            extractAlert.innerHTML = '';
            
            // Tạo FormData với file Excel từ upload chung
            const formData = new FormData();
            formData.append('file', mainExcelFile.files[0]);
            
            try {
                // Gửi request
                const response = await fetch('/extract', {
                    method: 'POST',
                    body: formData
                });
                
                // Ẩn loading
                extractLoading.style.display = 'none';
                
                if (response.ok) {
                    // Lấy tên file từ header Content-Disposition
                    const disposition = response.headers.get('Content-Disposition');
                    let filename = `to_translate_${Date.now()}.zip`;
                    
                    if (disposition && disposition.includes('filename=')) {
                        const filenameMatch = disposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    // Tải file ZIP
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert(extractAlert, 'success', 'Trích xuất thành công! File ZIP đang được tải về. Giải nén file và dịch các file JSON bên trong, sau đó dùng chức năng Inject.');
                } else {
                    const error = await response.json();
                    showAlert(extractAlert, 'danger', error.error || 'Có lỗi xảy ra!');
                }
            } catch (error) {
                extractLoading.style.display = 'none';
                showAlert(extractAlert, 'danger', 'Lỗi kết nối: ' + error.message);
            }
        });
        
        // ==================== CHỨC NĂNG INJECT ====================
        
        const injectForm = document.getElementById('injectForm');
        const injectJsonFile = document.getElementById('injectJsonFile');
        const injectJsonFileInfo = document.getElementById('injectJsonFileInfo');
        const injectJsonFileName = document.getElementById('injectJsonFileName');
        const injectJsonFileRemove = document.getElementById('injectJsonFileRemove');
        const injectAlert = document.getElementById('injectAlert');
        const injectLoading = document.getElementById('injectLoading');
        
        // Xử lý khi chọn file JSON (nhiều file)
        injectJsonFile.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const fileList = document.getElementById('injectJsonFileList');
                fileList.innerHTML = '';
                
                // Hiển thị danh sách các file
                Array.from(e.target.files).forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'mb-1';
                    const icon = file.name.endsWith('.zip') ? 'fa-file-archive' : 'fa-file-code';
                    const color = file.name.endsWith('.zip') ? 'text-warning' : 'text-primary';
                    fileItem.innerHTML = `<i class="fas ${icon} ${color}"></i> <small>${file.name}</small>`;
                    fileList.appendChild(fileItem);
                });
                
                injectJsonFileInfo.style.display = 'block';
            }
        });
        
        // Xử lý xóa file JSON
        injectJsonFileRemove.addEventListener('click', function() {
            injectJsonFile.value = '';
            injectJsonFileInfo.style.display = 'none';
        });
        
        // Xử lý drag and drop cho JSON files
        const injectJsonUploadArea = document.getElementById('injectJsonUploadArea');
        
        injectJsonUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#764ba2';
            injectJsonUploadArea.style.background = '#e9ecef';
        });
        
        injectJsonUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#667eea';
            injectJsonUploadArea.style.background = '#f8f9fa';
        });
        
        injectJsonUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            injectJsonUploadArea.style.borderColor = '#667eea';
            injectJsonUploadArea.style.background = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Sử dụng DataTransfer để gán files vào input
                const dataTransfer = new DataTransfer();
                Array.from(files).forEach(file => {
                    // Chỉ chấp nhận file .json hoặc .zip
                    if (file.name.endsWith('.json') || file.name.endsWith('.zip')) {
                        dataTransfer.items.add(file);
                    }
                });
                
                if (dataTransfer.files.length > 0) {
                    injectJsonFile.files = dataTransfer.files;
                    
                    // Hiển thị danh sách files
                    const fileList = document.getElementById('injectJsonFileList');
                    fileList.innerHTML = '';
                    
                    Array.from(dataTransfer.files).forEach((file, index) => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'mb-1';
                        const icon = file.name.endsWith('.zip') ? 'fa-file-archive' : 'fa-file-code';
                        const color = file.name.endsWith('.zip') ? 'text-warning' : 'text-primary';
                        fileItem.innerHTML = `<i class="fas ${icon} ${color}"></i> <small>${file.name}</small>`;
                        fileList.appendChild(fileItem);
                    });
                    
                    injectJsonFileInfo.style.display = 'block';
                } else {
                    showAlert(injectAlert, 'warning', 'Chỉ chấp nhận file .json hoặc .zip!');
                }
            }
        });
        
        // Xử lý submit form Inject
        injectForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Kiểm tra xem có file được upload chưa
            if (!uploadedExcelFilename || mainExcelFile.files.length === 0) {
                showAlert(injectAlert, 'warning', 'Vui lòng upload file (Excel hoặc PowerPoint) ở Bước 1 trước!');
                return;
            }
            
            // Kiểm tra xem có file JSON được chọn không
            if (injectJsonFile.files.length === 0) {
                showAlert(injectAlert, 'warning', 'Vui lòng chọn file JSON đã dịch!');
                return;
            }
            
            // Hiển thị loading
            injectLoading.style.display = 'block';
            injectAlert.innerHTML = '';
            
            // Tạo FormData với file Excel từ upload chung và tất cả file JSON
            const formData = new FormData();
            formData.append('excel_file', mainExcelFile.files[0]);
            
            // Thêm tất cả các file JSON/ZIP
            Array.from(injectJsonFile.files).forEach(file => {
                formData.append('json_files', file);
            });
            
            try {
                // Gửi request
                const response = await fetch('/inject', {
                    method: 'POST',
                    body: formData
                });
                
                // Ẩn loading
                injectLoading.style.display = 'none';
                
                if (response.ok) {
                    // Lấy tên file từ header Content-Disposition
                    const disposition = response.headers.get('Content-Disposition');
                    let filename = `output_translated_${Date.now()}.xlsx`;
                    
                    if (disposition && disposition.includes('filename=')) {
                        const filenameMatch = disposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    // Tải file với tên đúng extension
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert(injectAlert, 'success', 'Nạp bản dịch thành công! File đang được tải về. Tất cả file tạm đã được xóa.');
                    
                    // Reset form JSON
                    injectJsonFile.value = '';
                    injectJsonFileInfo.style.display = 'none';
                    
                    // Tự động xóa tất cả file trong thư mục uploads sau khi thành công
                    await clearUploads(true);
                } else {
                    const error = await response.json();
                    showAlert(injectAlert, 'danger', error.error || 'Có lỗi xảy ra!');
                }
            } catch (error) {
                injectLoading.style.display = 'none';
                showAlert(injectAlert, 'danger', 'Lỗi kết nối: ' + error.message);
            }
        });
        
        // ==================== HÀM TRỢ GIÚP ====================
        
        // Hàm xóa tất cả file trong uploads
        async function clearUploads(skipConfirm = false) {
            // Xác nhận trước khi xóa (trừ khi skipConfirm = true)
            if (!skipConfirm && !confirm('Bạn có chắc chắn muốn xóa TẤT CẢ file trong thư mục uploads?\n\nThao tác này không thể hoàn tác!')) {
                return;
            }
            
            try {
                const response = await fetch('/clear-uploads', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    if (!skipConfirm) {
                        alert(`✅ ${result.message}`);
                    }
                    
                    // Reset form và trạng thái
                    mainExcelFile.value = '';
                    mainFileInfo.style.display = 'none';
                    uploadedExcelFilename = null;
                    extractBtn.disabled = true;
                    injectBtn.disabled = true;
                    mainAlert.innerHTML = '';
                    injectJsonFile.value = '';
                    injectJsonFileInfo.style.display = 'none';
                } else {
                    if (!skipConfirm) {
                        alert('❌ Lỗi: ' + (result.error || result.message));
                    }
                }
            } catch (error) {
                if (!skipConfirm) {
                    alert('❌ Lỗi kết nối: ' + error.message);
                }
            }
        }
        
        // Hàm copy prompt AI
        function copyPrompt() {
            const promptText = document.getElementById('aiPrompt').textContent;
            
            // Tạo textarea tạm để copy
            const textarea = document.createElement('textarea');
            textarea.value = promptText;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                // Hiển thị thông báo đã copy
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Đã copy!';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-success');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                }, 2000);
            } catch (err) {
                alert('Không thể copy. Vui lòng copy thủ công.');
            }
            
            document.body.removeChild(textarea);
        }
        
        function showAlert(element, type, message) {
            element.innerHTML = `
                <div class="alert alert-${type} alert-custom alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
    </script>
</body>
</html>
